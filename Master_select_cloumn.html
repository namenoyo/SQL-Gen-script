<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Google Sheets Formula Generator</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 1000px; margin: auto; }
    input, select, textarea, button { margin: 4px; padding: 4px; font-size: 13px; max-width: 20ch; }
    textarea { height: 150px; width: 100%; }
    .section { border: 1px solid #ccc; padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #f9f9f9; }
    .btn { background: #4CAF50; color: white; border: none; cursor: pointer; padding: 6px 12px; margin-top: 8px; }
    .btn-clear { background: #f44336; margin-left: 10px; }
    .form-grid {
      display: grid;
      grid-template-columns: max-content auto;
      gap: 6px 12px;
      align-items: center;
    }
  </style>
</head>
<body>
  <h2>ğŸ§© Google Sheets Formula Generator</h2>

  <div class="section">
    <div class="form-grid">
      <label>ğŸ¯ à¹€à¸¥à¸·à¸­à¸à¸›à¸£à¸°à¹€à¸ à¸—à¸ªà¸¹à¸•à¸£:</label>
      <select id="formulaType_select_column">
        <option value="xlookup_latest">XLOOKUP à¸¥à¹ˆà¸²à¸ªà¸¸à¸” (FILTER+SORT)</option>
        <option value="iferror">IFERROR à¸£à¸­à¸šà¸ªà¸¹à¸•à¸£</option>
        <option value="vlookup">VLOOKUP à¸›à¸à¸•à¸´</option>
      </select>

      <label>ğŸ“Œ à¸Šà¸·à¹ˆà¸­ Tab à¸›à¸¥à¸²à¸¢à¸—à¸²à¸‡:</label>
      <input type="text" id="targetSheet_select_column" placeholder="à¹€à¸Šà¹ˆà¸™ TEST_SUITE">

      <label>ğŸ”‘ Cell à¸—à¸µà¹ˆà¸¡à¸µ Key (target):</label>
      <input type="text" id="targetKeyCell_select_column" placeholder="à¹€à¸Šà¹ˆà¸™ C8">

      <label>ğŸ“Œ à¸Šà¸·à¹ˆà¸­ Tab à¸•à¹‰à¸™à¸—à¸²à¸‡ (source):</label>
      <input type="text" id="sourceSheet_select_column" placeholder="à¹€à¸Šà¹ˆà¸™ upload_to_sheet">

      <label>ğŸ“Œ à¸Šà¹ˆà¸§à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ (columns):</label>
      <input type="text" id="sourceCols_select_column" placeholder="à¹€à¸Šà¹ˆà¸™ A:E à¸«à¸£à¸·à¸­ A-E à¸«à¸£à¸·à¸­ 1-5">

      <label>ğŸ”‘ à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œ Key (source):</label>
      <input type="text" id="sourceKeyCol_select_column" placeholder="à¹€à¸Šà¹ˆà¸™ C">

      <label>ğŸ“¥ à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥:</label>
      <input type="text" id="resultColInput_select_column" placeholder="à¹€à¸Šà¹ˆà¸™ E à¸«à¸£à¸·à¸­ 5">
    </div>
  </div>

  <div class="section">
    <label>ğŸ§  à¸ªà¸¹à¸•à¸£à¸—à¸µà¹ˆà¹„à¸”à¹‰:</label>
    <textarea id="generatedFormula" readonly></textarea>
<br>	
    <button class="btn" onclick="copyFormula()">ğŸ“‹ Copy à¸ªà¸¹à¸•à¸£</button>
    <button class="btn btn-clear" onclick="clearInputs()">ğŸ§¹ Clear</button>
  </div>

  <script>
    document.getElementById("formulaType_select_column").addEventListener("change", generateFormula);
    document.querySelectorAll("input, select").forEach(el => el.addEventListener("input", generateFormula));

    function columnLetterToNumber(col) {
      col = col.toUpperCase();
      let num = 0;
      for (let i = 0; i < col.length; i++) {
        num = num * 26 + (col.charCodeAt(i) - 64);
      }
      return num;
    }

    function numberToColumnLetter(n) {
      let result = "";
      while (n > 0) {
        const rem = (n - 1) % 26;
        result = String.fromCharCode(65 + rem) + result;
        n = Math.floor((n - 1) / 26);
      }
      return result;
    }

    function normalizeRangeInput(rangeInput) {
      if (/^[A-Z]-[A-Z]$/i.test(rangeInput)) {
        const parts = rangeInput.toUpperCase().split("-");
        return `${parts[0]}:${parts[1]}`;
      } else if (/^\d+-\d+$/.test(rangeInput)) {
        const parts = rangeInput.split("-").map(Number);
        return `${numberToColumnLetter(parts[0])}:${numberToColumnLetter(parts[1])}`;
      }
      return rangeInput;
    }

    function expandRangeIfNeeded(range, targetColLetter) {
      const match = range.match(/^([A-Z]+):([A-Z]+)$/);
      if (!match) return range;

      const startCol = match[1];
      let endCol = match[2];
      const startNum = columnLetterToNumber(startCol);
      let endNum = columnLetterToNumber(endCol);
      const targetNum = columnLetterToNumber(targetColLetter);

      if (targetNum > endNum) {
        endNum = targetNum;
        endCol = numberToColumnLetter(endNum);
        return `${startCol}:${endCol}`;
      }
      return range;
    }

    function generateFormula() {
      const type = document.getElementById("formulaType_select_column").value;
      const src = document.getElementById("sourceSheet_select_column").value.trim();
      let range = document.getElementById("sourceCols_select_column").value.trim();
      const keyCol = document.getElementById("sourceKeyCol_select_column").value.trim();
      const tgt = document.getElementById("targetSheet_select_column").value.trim();
      const keyCell = document.getElementById("targetKeyCell_select_column").value.trim();
      const resultInput = document.getElementById("resultColInput_select_column").value.trim();

      if (!(src && range && keyCol && tgt && keyCell && resultInput)) {
        document.getElementById("generatedFormula").value = "âŒ à¸à¸£à¸¸à¸“à¸²à¸à¸£à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸«à¹‰à¸„à¸£à¸š";
        return;
      }

      range = normalizeRangeInput(range);
      const colLetter = isNaN(resultInput) ? resultInput : numberToColumnLetter(parseInt(resultInput));
      range = expandRangeIfNeeded(range, colLetter);
      const colIndex = isNaN(resultInput) ? columnLetterToNumber(resultInput) : parseInt(resultInput);

      let formula = "";
      if (type === "xlookup_latest") {
        formula = `=IFERROR(\n  INDEX(\n    SORT(\n      FILTER('${src}'!${range}, TRIM('${src}'!${keyCol}:${keyCol}) = TRIM(${keyCell})),\n      1, FALSE\n    ),\n    1, ${colIndex}\n  ),\n  \"âŒ à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥\"\n)`;
      } else if (type === "iferror") {
        formula = `=IFERROR(...à¸ªà¸¹à¸•à¸£à¸‚à¸­à¸‡à¸„à¸¸à¸“...)`;
      } else if (type === "vlookup") {
        formula = `=VLOOKUP(${keyCell}, '${src}'!${range}, ${colIndex}, FALSE)`;
      }

      document.getElementById("generatedFormula").value = formula;
    }

    function copyFormula() {
      const formula = document.getElementById("generatedFormula").value;
      navigator.clipboard.writeText(formula).then(() => {
        alert("âœ… à¸„à¸±à¸”à¸¥à¸­à¸à¸ªà¸¹à¸•à¸£à¹à¸¥à¹‰à¸§");
      });
    }

    function clearInputs() {
      const ids = [
        "targetSheet_select_column",
        "targetKeyCell_select_column",
        "sourceSheet_select_column",
        "sourceCols_select_column",
        "sourceKeyCol_select_column",
        "resultColInput_select_column"
      ];
      ids.forEach(id => document.getElementById(id).value = "");
      document.getElementById("formulaType_select_column").selectedIndex = 0;
      document.getElementById("generatedFormula").value = "";
    }
  </script>
</body>
</html>
