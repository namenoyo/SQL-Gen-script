
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>QA Smart Panel + D-Line Generator</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #f5f8fb;
      display: flex;
      height: 100vh;
	   font-size: 13px;
    }
    .sidebar {
  width: 220px;
  min-width: 220px;     
  max-width: 220px;     
  background: #2c3e50;
  color: white;
  display: flex;
  flex-direction: column;
  padding: 20px 10px;
  overflow-y: auto;      
  overflow-x: hidden;    
  flex-shrink: 0;        
}
    .sidebar h2 {
      font-size: 16px;
      margin-bottom: 20px;
      padding-left: 10px;
    }
    .sidebar a {
  padding: 8px 15px;
  margin: 4px 0;
  text-decoration: none;
  color: white;
  border-radius: 6px;
  display: block;
  font-size: 13px;
  white-space: nowrap;       
  overflow: hidden;           
  text-overflow: ellipsis;    
}
    .sidebar a:hover, .sidebar a.active {
      background-color: #3498db;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    textarea, input[type="date"], input[type="text"], select {
      width: 100%;
      padding: 6px;
      margin: 6px 0 10px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background-color: #3498db;
      color: white;
      padding: 6px 12px;
      margin: 3px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #2980b9;
    }
    h3 {
      margin-top: 0;
      font-size: 16px;
    }
    .card-content {
      display: none;
    }
    .card-content.active {
      display: block;
    }
    table {
      width: 100%;
      border-collapse: collapse;
	   font-size: 13px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #3498db;
      color: white;
	   font-size: 12px;
    }
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
	  font-size: 13px;
    }
    .row label {
      width: 120px;
      font-weight: bold;
    }
    .row input, .row select {
      flex: 1;
    }
	
	input.small-date {
	width: 150px;
	}
	textarea.large-output {
  min-height: 200px;
  font-family: monospace;
  white-space: pre;
	}
	textarea.medium-output {
  min-height: 100px;
  font-family: monospace;
  white-space: pre;
	}
	
    .small-input {
  width: 20px;
  max-width: 15%;
  padding: 4px 8px;
  font-size: 13px;
}

   .noometal-brand {
  position: fixed;
  bottom: 8px;
  left: 12px;
  font-size: 11px;
  font-family: 'Segoe UI', sans-serif;
  color: rgba(0, 206, 209, 0.3);           /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏•‡∏à‡∏≤‡∏á‡πÜ */
  letter-spacing: 1px;
  text-shadow: 0 0 2px rgba(0, 206, 209, 0.15); /* ‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ó‡∏∞‡πÄ‡∏• */
  pointer-events: none;
  z-index: 999;
  user-select: none;
}

 /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-right: 10px;
      vertical-align: middle;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0;
      right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4CAF50;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    .toggle-label {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
	
	.small-select_id_card {
  width: 200px;   /* ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏ä‡πâ 150px ‡∏Å‡πá‡πÑ‡∏î‡πâ */
  max-width: 100%;
}


/* ===== Flush-left ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ SP-Life ===== */

/* 1) ‡∏´‡∏±‡∏Å padding ‡∏ã‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á .main-content (20px) ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ section ‡∏ô‡∏µ‡πâ */
#SPLife_Gen_TextFile{
  margin-left: -20px;              /* ‡∏ä‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πâ‡∏≤‡∏¢ */
  width: calc(100% + 20px);        /* ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ */
  padding-left: 0 !important;      /* ‡∏Å‡∏±‡∏ô style ‡∏≠‡∏∑‡πà‡∏ô‡∏°‡∏≤‡∏ó‡∏±‡∏ö */
}

/* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ margin */
#SPLife_Gen_TextFile .card{
  margin: 0 !important;
  border-radius: 0;                 /* ‡πÅ‡∏ô‡∏ö‡∏™‡∏ô‡∏¥‡∏ó‡∏Å‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢ ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
}

/* 2) ‡πÇ‡∏ã‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á CBSPLIFE (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ SP-Life) */
#SPLife_Gen_TextFile #app_cbsplife{
  padding-left: 0 !important;
  margin-left: 0 !important;
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏ó‡∏π‡∏•‡∏ö‡∏≤‡∏£‡πå‡πÉ‡∏ô CBSPLIFE ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡∏ã‡πâ‡∏≤‡∏¢ */
#SPLife_Gen_TextFile #app_cbsplife #cbsplife-header,
#SPLife_Gen_TextFile #app_cbsplife .toolbar,
#SPLife_Gen_TextFile #app_cbsplife #detailTable_CBSPLIFE{
  margin-left: 0 !important;
}

/* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å: ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á overflow ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) */
@media (max-width: 900px){
  #SPLife_Gen_TextFile{
    margin-left: 0;
    width: 100%;
  }
}
/* ===== Flush-left ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Claim Payment WHT ===== */
#claimpay_wht {
  margin-left: -20px;             /* ‡∏´‡∏±‡∏Å padding ‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏≠‡∏Å */
  width: calc(100% + 20px);       /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏ô */
  padding-left: 0 !important;
}

#claimpay_wht .card {
  margin: 0 !important;
  border-radius: 0;                /* ‡πÅ‡∏ô‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ã‡πâ‡∏≤‡∏¢ */
}

#claimpay_wht #app_claimpay_wht {
  padding-left: 0 !important;
  margin-left: 0 !important;
}

#claimpay_wht #app_claimpay_wht .toolbar,
#claimpay_wht #app_claimpay_wht table,
#claimpay_wht #app_claimpay_wht .header {
  margin-left: 0 !important;
}

/* ‡∏Å‡∏±‡∏ô overflow ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
@media (max-width: 900px){
  #claimpay_wht {
    margin-left: 0;
    width: 100%;
  }
}
/* ===== Fill width/height ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤ Claim-payment (WHT) ===== */
#claimpay_wht .card {
  margin: 0 !important;
  width: 100% !important;
  max-width: none !important;
  border-radius: 0;
}

/* wrapper ‡∏£‡∏≠‡∏ö iframe (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô) */
#claimpay_wht .iframe-wrap,
#claimpay_wht .tool-frame,
#claimpay_wht .viewer,
#claimpay_wht .content-inner {
  width: 100% !important;
  max-width: none !important;
  padding: 0 !important;
  margin: 0 !important;
  box-sizing: border-box;
}

/* ‡∏ï‡∏±‡∏ß iframe ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
#claimpay_wht iframe,
#claimpay_wht .tool-iframe {
  display: block;
  width: 100% !important;
  border: 0;
  /* ‡∏™‡∏π‡∏á = ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ - ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß/‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì */
  height: calc(100vh - 240px) !important;
  min-height: 520px;                 /* ‡∏Å‡∏±‡∏ô‡πÄ‡∏ï‡∏µ‡πâ‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
}

/* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ container ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á padding-inline */
#claimpay_wht :is(main, .content, .main-content){
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* ‡∏Å‡∏±‡∏ô overflow ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
@media (max-width: 900px){
  #claimpay_wht iframe,
  #claimpay_wht .tool-iframe{
    height: calc(100vh - 280px) !important;
    min-height: 420px;
  }
}


  </style>
</head>
<body>
  <div class="sidebar">
    <h2>üß† QA Micro App ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô</h2>
    <a href="#" class="tab-link active" onclick="switchTab('sql')">üì¶ Gen : Query ‡∏õ‡∏µ‡∏ï‡πà‡∏≠ ORD AS400</a>
	<a href="#" class="tab-link" onclick="switchTab('Chat_Deploy_Chatbox')">üì¶ Auto Jira Deploy</a>
    <a href="#" class="tab-link" onclick="switchTab('mapping')">üì¶ Gen : Ref_1</a>
	<a href="#" class="tab-link" onclick="switchTab('idcardno')"> üì¶ Gen : ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</a>
    <a href="#" class="tab-link" onclick="switchTab('dline')">üì¶ Gen : Text File Counter Bank</a>
	<a href="#" class="tab-link" onclick="switchTab('SPLife_Gen_TextFile')">üì¶ Gen : Text File SP Life</a>
	<a href="#" class="tab-link" onclick="switchTab('split_text')">üì¶ ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</a>
	<a href="#" class="tab-link" onclick="switchTab('json_gen')">üì¶ Gen : JSON For Test Data</a>
	<a href="#" class="tab-link" onclick="switchTab('google_gen')">üì¶ Google Sheets : Formula Generator</a>
	<a href="#" class="tab-link" onclick="switchTab('claimpay_wht')">üì¶ Claim-payment : All Type</a>
	
	
  </div>

  <div class="main-content">
<div id="sql" class="card-content active">

      <div class="section">
        <h3>üìÑ SQL Query Generator ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô AS400</h3>
       <div style="display: flex; align-items: left ; gap: 15px;">
	   
	   
  <button onclick="useToday()">üìÖ ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ </button> <p>‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏á</p>
  <input type="date" id="customDate" class="small-date">
</div>
<br>
        <div><strong>üìÜ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏:</strong> <span id="displayDate"></span></div>
		
        <textarea id="sqlOutput"  class="large-output"></textarea>
		<div class="section">
        <button onclick="copySQL()">üìã Copy</button>
        <button onclick="clearSQL()">üßπ Clear</button>
		</div>
		<script>
    function pad(n) {
      return n.toString().padStart(2, '0');
    }

    function toYYMMDD(date) {
      const d = new Date(date);
      const year = d.getFullYear() - 543;
      const yy = (year ).toString().padStart(2, '0');
      const mm = pad(d.getMonth() + 1);
      const dd = pad(d.getDate());
      return { yy, mm, dd };
    }
	
	function toBEYYMMDD(dateObj) {
  const year = dateObj.getFullYear() + 543 - 2500;
  return `${pad(year)}${pad(dateObj.getMonth() + 1)}${pad(dateObj.getDate())}`;
}



    function formatThaiDate(date) {
  const d = new Date(date);
  const year = d.getFullYear() + 543;
  const month = ('0' + (d.getMonth() + 1)).slice(-2); // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 2 ‡∏´‡∏•‡∏±‡∏Å
  const day = ('0' + d.getDate()).slice(-2);          // ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö 2 ‡∏´‡∏•‡∏±‡∏Å
  return `${year}/${month}/${day}`;
}

  function generateSQL(dateInput) {
  const base = new Date(dateInput);

  function toBEYYMMDD(dateObj) {
    const year = String(dateObj.getFullYear() + 543 - 2500).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const day = String(dateObj.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
  }

  const end = toBEYYMMDD(base);

  const mod1Start = new Date(base.getFullYear(), base.getMonth() - 2, base.getDate() - 1);
  const mod1End = new Date(base.getFullYear(), base.getMonth() - 1, base.getDate() - 1);
  const mod1StartStr = toBEYYMMDD(mod1Start);
  const mod1EndStr = toBEYYMMDD(mod1End);

  const mod3StartStr = toBEYYMMDD(new Date(base.getFullYear(), base.getMonth() - 3, 1));
  const mod3EndStr = toBEYYMMDD(new Date(base.getFullYear(), base.getMonth() - 3, base.getDate()));

  const mod6StartStr = toBEYYMMDD(new Date(base.getFullYear(), base.getMonth() - 6, 1));
  const mod6EndStr = toBEYYMMDD(new Date(base.getFullYear(), base.getMonth() - 6, base.getDate()));

  const mod12StartStr = toBEYYMMDD(new Date(base.getFullYear(), base.getMonth() - 12, 1));
  const mod12EndStr = toBEYYMMDD(new Date(base.getFullYear(), base.getMonth() - 12, base.getDate()));

  const sql = `SELECT a.POLIC#, a.POSMAS, a.POCMDT, a.POFRDT,a.POTODT, a.POMOD#, a.*
FROM olis.OLPPOLMS AS a
WHERE a.POSTS@ = 'I' AND NOT EXISTS (
  SELECT 1 FROM olis.OLPLOAHD b WHERE a."POLIC#" = b."LHPOL#"
) AND (
  (a.POMOD# = '1' AND a.POTODT BETWEEN '${mod1StartStr}' AND '${mod1EndStr}') OR
  (a.POMOD# = '3' AND a.POFRDT BETWEEN '${mod3StartStr}' AND '${mod3EndStr}' AND a.POTODT <= '${end}') OR
  (a.POMOD# = '6' AND a.POFRDT BETWEEN '${mod6StartStr}' AND '${mod6EndStr}' AND a.POTODT <= '${end}') OR
  (a.POMOD# = '12' AND a.POFRDT BETWEEN '${mod12StartStr}' AND '${mod12EndStr}' AND a.POTODT <= '${end}')
);`;

  document.getElementById('sqlOutput').value = sql;
  document.getElementById('displayDate').textContent = formatThaiDate(dateInput);
}



    function useToday() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('customDate').value = dateStr;
      generateSQL(dateStr);
    }

    function copySQL() {
      const textarea = document.getElementById('sqlOutput');
      textarea.select();
      document.execCommand('copy');
    }

    function clearSQL() {
      document.getElementById('sqlOutput').value = '';
      document.getElementById('displayDate').textContent = '';
    }

    document.getElementById('customDate').addEventListener('change', function () {
      generateSQL(this.value);
    });
	</script>
      </div>
    </div>
	
	
<div id="Chat_Deploy_Chatbox" class="card-content">
   <div class="card">
        <h3>üì¶ Auto Jira Deploy </h3><br>
		<h5>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å Google Chat : AI_Tester_Monitor_Batch </h5>
         <div id="Chat_Deploy_Messages"
         style="border: 1px solid #ccc; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto; background: #f9f9f9; margin-bottom: 1rem;">
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
      <input id="Chat_Deploy_Input"
             placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°... ‡πÄ‡∏ä‡πà‡∏ô #‡∏Ç‡∏≠ Deploy msa-emailnoti"
             style="flex: 1 1 60%; min-width: 250px;">
      <button onclick="send()">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏á</button>
      <button onclick="sendQuick('#Check Server Jira')">‚úÖ Check Server</button>
    </div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <input id="Chat_Deploy_SystemInput"
             list="Chat_Deploy_SystemList"
             placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"
             style="flex: 1 1 60%; min-width: 250px;">
      <datalist id="Chat_Deploy_SystemList"></datalist>
      <button onclick="deploy()">üöÄ Deploy ‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

  
<script>
  const webhookURL = "https://workflow.ochi.link/webhook/3d7cd446-3e99-4525-aaae-e42c4c717a31";

  const systemOptions = [
  { label: 'aceso', data: 'aceso' },
  { label: 'blowprint', data: 'blowprint' },
  { label: 'loantapp', data: 'loantapp' },
  { label: 'trmoveapp', data: 'trmoveapp' },
  { label: 'welcomeapp', data: 'welcomeapp' },
  { label: 'agentoffice', data: 'agentoffice' },
  { label: 'bizpaymentapp', data: 'bizpaymentapp' },
  { label: 'csbroker', data: 'csbroker' },
  { label: 'eformapp', data: 'eformapp' },
  { label: 'engisiapp', data: 'engisiapp' },
  { label: 'epirusapp', data: 'epirusapp' },
  { label: 'epitagiapp', data: 'epitagiapp' },
  { label: 'hadesapp', data: 'hadesapp' },
  { label: 'hecate', data: 'hecate' },
  { label: 'hydraapp', data: 'hydraapp' },
  { label: 'prasinoapp', data: 'prasinoapp' },
  { label: 'swissknifeapp', data: 'swissknifeapp' },
  { label: 'boothapp', data: 'boothapp' },
  { label: 'brokerrein', data: 'brokerrein' },
  { label: 'caerusapp', data: 'caerusapp' },
  { label: 'charonapp', data: 'charonapp' },
  { label: 'cisapp', data: 'cisapp' },
  { label: 'clpayapp', data: 'clpayapp' },
  { label: 'clregisterapp', data: 'clregisterapp' },
  { label: 'easyloanapp', data: 'easyloanapp' },
  { label: 'justclapp', data: 'justclapp' },
  { label: 'collectapp', data: 'collectapp' },
  { label: 'coreul', data: 'coreul' },
  { label: 'crmface', data: 'crmface' },
  { label: 'philotesapp', data: 'philotesapp' },
  { label: 'cyclopsapp', data: 'cyclopsapp' },
  { label: 'digisignapp', data: 'digisignapp' },
  { label: 'dmsconcileapp', data: 'dmsconcileapp' },
  { label: 'elpis', data: 'elpis' },
  { label: 'elpisbackapp', data: 'elpisbackapp' },
  { label: 'eros', data: 'eros' },
  { label: 'geras', data: 'geras' },
  { label: 'nyx', data: 'nyx' },
  { label: 'nyxbackapp', data: 'nyxbackapp' },
  { label: 'groupmember', data: 'groupmember' },
  { label: 'groupmemberhr', data: 'groupmemberhr' },
  { label: 'income', data: 'income' },
  { label: 'irisapp', data: 'irisapp' },
  { label: 'oceantaxapp', data: 'oceantaxapp' },
  { label: 'pcertapp', data: 'pcertapp' },
  { label: 'phoebe', data: 'phoebe' },
  { label: 'portorapp', data: 'portorapp' },
  { label: 'telebapp', data: 'telebapp' },
  { label: 'erosbackapp', data: 'erosbackapp' },
  { label: 'ulclapp', data: 'ulclapp' },
  { label: 'ulfinapp', data: 'ulfinapp' },
  { label: 'ulnbapp', data: 'ulnbapp' },
  { label: 'ulpsapp', data: 'ulpsapp' },
  { label: 'ulrivaapp', data: 'ulrivaapp' },
  { label: 'vocard', data: 'vocard' },
  { label: 'whtaxapp', data: 'whtaxapp' },
  { label: 'msa-agentactivity', data: 'msa-agentactivity' },
  { label: 'msa-agentauth', data: 'msa-agentauth' },
  { label: 'msa-agentincome', data: 'msa-agentincome' },
  { label: 'msa-agentnewskm', data: 'msa-agentnewskm' },
  { label: 'msa-agentproduct', data: 'msa-agentproduct' },
  { label: 'msa-agentteam', data: 'msa-agentteam' },
  { label: 'msa-altproduct', data: 'msa-altproduct' },
  { label: 'msa-application', data: 'msa-application' },
  { label: 'msa-bblpaymentgw', data: 'msa-bblpaymentgw' },
  { label: 'msa-custauth', data: 'msa-custauth' },
  { label: 'msa-custlookup', data: 'msa-custlookup' },
  { label: 'msa-custsegment', data: 'msa-custsegment' },
  { label: 'msa-dwconsol', data: 'msa-dwconsol' },
  { label: 'msa-emailnoti', data: 'msa-emailnoti' },
  { label: 'msa-filecollect', data: 'msa-filecollect' },
  { label: 'msa-grouplifeadmin', data: 'msa-grouplifeadmin' },
  { label: 'msa-letterreturn', data: 'msa-letterreturn' },
  { label: 'msa-lineoa', data: 'msa-lineoa' },
  { label: 'msa-loyaltyhub', data: 'msa-loyaltyhub' },
  { label: 'msa-loyaltypoint', data: 'msa-loyaltypoint' },
  { label: 'msa-mastersetting', data: 'msa-mastersetting' },
  { label: 'msa-mktadmin', data: 'msa-mktadmin' },
  { label: 'msa-mockito', data: 'msa-mockito' },
  { label: 'msa-nbsportal', data: 'msa-nbsportal' },
  { label: 'msa-oicgw', data: 'msa-oicgw' },
  { label: 'msa-oliauth', data: 'msa-oliauth' },
  { label: 'msa-otp', data: 'msa-otp' },
  { label: 'msa-policy', data: 'msa-policy' },
  { label: 'msa-pushnoti', data: 'msa-pushnoti' },
  { label: 'msa-salesillus', data: 'msa-salesillus' },
  { label: 'msa-scheduler', data: 'msa-scheduler' },
  { label: 'msa-seaweedgw', data: 'msa-seaweedgw' },
  { label: 'msa-stock', data: 'msa-stock' },
  { label: 'msa-survey', data: 'msa-survey' },
  { label: 'msa-token', data: 'msa-token' },
  { label: 'msa-underwriting', data: 'msa-underwriting' },
  { label: 'msa-welcomecall', data: 'msa-welcomecall' },
  { label: 'msa-adw', data: 'msa-adw' },
  { label: 'msa-adwetl', data: 'msa-adwetl' },
  { label: 'msa-depositpay', data: 'msa-depositpay' },
  { label: 'msa-thaiqr', data: 'msa-thaiqr' },
  { label: 'msa-eclaim', data: 'msa-eclaim' },
  { label: 'msa-omail', data: 'msa-omail' },
  { label: 'msa-coreesb', data: 'msa-coreesb' },
  { label: 'msa-dms', data: 'msa-dms' },
  { label: 'msa-doculink', data: 'msa-doculink' },
  { label: 'msa-rightpdpa', data: 'msa-rightpdpa' },
  { label: 'msa-dispatchdata', data: 'msa-dispatchdata' },
  { label: 'msa-epolicy', data: 'msa-epolicy' },
  { label: 'msa-followhub', data: 'msa-followhub' },
  { label: 'msa-grouplifehr', data: 'msa-grouplifehr' },
  { label: 'msa-ibs', data: 'msa-ibs' },
  { label: 'msa-healthcopay', data: 'msa-healthcopay' },
  { label: 'msa-sonar', data: 'msa-sonar' },
  { label: 'msa-playground', data: 'msa-playground' },
  { label: 'msa-expalloc', data: 'msa-expalloc' },
  { label: 'msa-agentoss', data: 'msa-agentoss' },
  { label: 'msa-nbentry', data: 'msa-nbentry' },
  { label: 'msa-uwer', data: 'msa-uwer' },
  { label: 'msa-digihealth', data: 'msa-digihealth' },
  { label: 'msa-pharmcare', data: 'msa-pharmcare' },
  { label: 'msa-benefitbank', data: 'msa-benefitbank' },
  { label: 'msa-benefitregister', data: 'msa-benefitregister' },
  { label: 'msa-iclaim', data: 'msa-iclaim' },
  { label: 'msa-claimtx', data: 'msa-claimtx' },
  { label: 'msa-claimui', data: 'msa-claimui' },
  { label: 'msa-psuite', data: 'msa-psuite' },
  { label: 'msa-bizpayment', data: 'msa-bizpayment' },
  { label: 'msa-taxreserve', data: 'msa-taxreserve' },
  { label: 'msa-autosurr', data: 'msa-autosurr' },
  { label: 'msa-illul', data: 'msa-illul' },
  { label: 'msa-reinsurance', data: 'msa-reinsurance' },
  { label: 'msa-insuranceconnext', data: 'msa-insuranceconnext' },
  { label: 'msa-iservice', data: 'msa-iservice' },
  { label: 'msa-esbdatacache', data: 'msa-esbdatacache' },
  { label: 'msa-alter', data: 'msa-alter' },
  { label: 'msa-onlinepayment', data: 'msa-onlinepayment' },
  { label: 'msa-mlgw', data: 'msa-mlgw' },
  { label: 'msa-brokerauth', data: 'msa-brokerauth' },
  { label: 'msa-splife', data: 'msa-splife' },
  { label: 'msa-barcodedms', data: 'msa-barcodedms' },
  { label: 'msa-gerasapi', data: 'msa-gerasapi' },
  { label: 'msa-nyxapi', data: 'msa-nyxapi' },
  { label: 'msa-caerusappapi', data: 'msa-caerusappapi' },
  { label: 'msa-whtaxappapi', data: 'msa-whtaxappapi' },
  { label: 'msa-cisappapi', data: 'msa-cisappapi' },
  { label: 'msa-clpayappapi', data: 'msa-clpayappapi' },
  { label: 'msa-clregisterappapi', data: 'msa-clregisterappapi' },
  { label: 'msa-pcertappapi', data: 'msa-pcertappapi' },
  { label: 'msa-incomeapi', data: 'msa-incomeapi' },
  { label: 'msa-internetsalesapi', data: 'msa-internetsalesapi' },
  { label: 'msa-irisappapi', data: 'msa-irisappapi' },
  { label: 'msa-agentmgmtappapi', data: 'msa-agentmgmtappapi' },
  { label: 'msa-nbswebapi', data: 'msa-nbswebapi' },
  { label: 'msa-philotesappapi', data: 'msa-philotesappapi' },
  { label: 'msa-cyclopsappapi', data: 'msa-cyclopsappapi' },
  { label: 'msa-portorappapi', data: 'msa-portorappapi' },
  { label: 'msa-bizpaymentappapi', data: 'msa-bizpaymentappapi' },
  { label: 'msa-engisiappapi', data: 'msa-engisiappapi' },
  { label: 'msa-epitagiappapi', data: 'msa-epitagiappapi' },
  { label: 'msa-hadesappapi', data: 'msa-hadesappapi' },
  { label: 'msa-hermesappapi', data: 'msa-hermesappapi' },
  { label: 'msa-hydraappapi', data: 'msa-hydraappapi' },
  { label: 'msa-prasinoappapi', data: 'msa-prasinoappapi' },
  { label: 'msa-acesoapi', data: 'msa-acesoapi' }
	
  ];

  const datalist = document.getElementById("Chat_Deploy_SystemList");
  systemOptions.forEach(opt => {
    const option = document.createElement("option");
    option.value = opt.label;
    datalist.appendChild(option);
  });

  function addMessage(sender, text) {
    const div = document.createElement("div");
    div.classList.add("msg", sender);
    div.textContent = (sender === "user" ? "üë§ " : "ü§ñ ") + text;
    document.getElementById("Chat_Deploy_Messages").appendChild(div);
    document.getElementById("Chat_Deploy_Messages").scrollTop = 9999;
  }

  async function send() {
    const input = document.getElementById("Chat_Deploy_Input");
    const text = input.value.trim();
    if (!text) return;

    addMessage("user", text);
    input.value = "";

    const payload = { text };

    try {
      const res = await fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        addMessage("bot", "‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á Service ‡πÅ‡∏•‡πâ‡∏ß");
      } else {
        addMessage("bot", "‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + res.status);
      }
    } catch (err) {
      addMessage("bot", "‚ùå error: " + err.message);
    }
  }

  function sendQuick(text) {
    document.getElementById("Chat_Deploy_Input").value = text;
    send();
  }

  async function deploy() {
  const input = document.getElementById("Chat_Deploy_SystemInput");
  const inputValue = input.value.trim();
  const selected = systemOptions.find(s => s.label === inputValue)?.data;

  if (!selected) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á");
    return;
  }

  const message = `#‡∏Ç‡∏≠ Deploy ${inputValue}`;
  addMessage("user", message);

  const payload = { text: message };
  input.value = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏™‡∏°‡∏≠

  try {
    const res = await fetch(webhookURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      addMessage("bot", "‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Google Chat ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
     
    } else {
      addMessage("bot", "‚ùå ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + res.status);
    }
  } catch (err) {
    addMessage("bot", "‚ùå error: " + err.message);
  }
}

</script>

	</div>
    </div>
	
	
<div id="mapping" class="card-content">
  <div class="card">
    <h3>üîß ‡πÄ‡∏•‡∏Ç‡∏Å‡∏ò Transform ‡πÄ‡∏õ‡πá‡∏ô Ref1</h3>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
    <label for="payType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:</label>
    <select id="payType">
      <option value="51">51 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç</option>
      <option value="52">52 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏°</option>
      <option value="53">53 - ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô PA term</option>
      <option value="56">56 - ‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏≤‡∏Å ‡∏™‡∏ô‡∏á.‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</option>
      <option value="58">58 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç + ‡∏ã‡∏∑‡πâ‡∏≠ Rider ‡πÄ‡∏û‡∏¥‡πà‡∏°</option>
      <option value="59">59 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</option>
      <option value="60">60 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á Internet Sale</option>
      <option value="62">62 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç ‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏ô‡∏≠ DAB2</option>
      <option value="63">63 - ‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô PA ‡∏õ‡∏µ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</option>
      <option value="75">75 - ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Silkspan</option>
      <option value="76">76 - ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Booth Model</option>
      <option value="77">77 - ‡πÄ‡∏Ñ‡∏™‡πÉ‡∏´‡∏°‡πà ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ Telesales</option>
      <option value="78">78 - ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</option>
      <option value="79">79 - ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ Unit Linked</option>
    </select>

    <br><br>

    <input type="text" id="inputID"
      placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏Å‡∏ò : 1104860, J7647226, E6350304, PAR10430199, ‡∏™1234568">

    <br><button onclick="transform()">‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤</button>

    <label for="output_1">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</label>
    <textarea id="output_1" readonly></textarea>

    <script>
  // ========= CONFIG =========
  const ALWAYS_SUFFIX = "11105";

  const payTypeFixMap = {
    "51": "01",
	"58": "01",
	"59": "01",
	"60": "01",
	"62": "01",
	"75": "01",
	"76": "01",
	"77": "01",
    "52": "1"
  };

  const noFixTypes = new Set(["53"]);

  const ref1PadLengthByType = {
    "51": 9
  };

  // ========= REF1 TRANSFORM LOGIC (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°) =========
  const specialPrefixes = ['PA', 'PAR'];
  const mappingTable = {
    "000": "0", "033": "PA", "034": "PAR", "003": "‡∏Å", "004": "‡∏Ç", "005": "‡∏Ü",
    "006": "‡∏î", "007": "‡∏ò", "008": "‡∏û", "009": "‡∏ß", "010": "A", "011": "B", "012": "C",
    "013": "D", "014": "E", "015": "F", "016": "K", "017": "T", "018": "‡∏™", "019": "H",
    "020": "I", "021": "J", "022": "1", "023": "2", "024": "3", "025": "4", "026": "5",
    "027": "6", "028": "7", "029": "8", "030": "9", "031": "PAA", "032": "MIC", "288": "UL"
  };

  function buildMaps() {
    const prefixMap = [];
    const charMap = {};
    for (const code in mappingTable) {
      const desc = mappingTable[code];
      if (specialPrefixes.includes(desc)) {
        prefixMap.push({ desc, code: code.padStart(3, '0') });
      } else if (desc.length >= 2) {
        prefixMap.push({ desc, code: code.padStart(2, '0') });
      } else {
        charMap[desc] = code.padStart(2, '0');
      }
    }
    prefixMap.sort((a, b) => b.desc.length - a.desc.length);
    return { prefixMap, charMap };
  }

  function transformRef1(input) {
    const { prefixMap, charMap } = buildMaps();
    let transformed = input;
    let matchedPrefix = null;

    for (const map of prefixMap) {
      if (input.startsWith(map.desc)) {
        transformed = map.code + input.slice(map.desc.length);
        matchedPrefix = map.desc;
        break;
      }
    }

    if (!matchedPrefix) {
      const firstChar = input.charAt(0);
      const rest = input.slice(1);
      const code = charMap[firstChar];
      if (code) transformed = code + rest;
    }

    return transformed;
  }

  // ========= HELPER: parse multi input =========
  function parseInputList(raw) {
  return raw
    // ‡∏ï‡∏±‡∏î ' ‡πÅ‡∏•‡∏∞ " ‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    .replace(/['"]/g, "")
    // ‡πÅ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ comma, newline, semicolon, tab, space
    .split(/[\n,; \t]+/g)
    // trim ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
    .map(s => s.trim())
    // ‡∏ï‡∏±‡∏î‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
    .filter(Boolean);
}


  // ========= FINAL TRANSFORM (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) =========
  function transform() {
    const raw = document.getElementById("inputID").value;
    const payType = document.getElementById("payType").value;

    const list = parseInputList(raw);

    if (!list.length) {
      document.getElementById("output_1").value = "";
      return;
    }

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° fix
    let fix = payTypeFixMap[payType] || "";
    if (noFixTypes.has(payType)) fix = "";

    const padLen = ref1PadLengthByType[payType];

    const outputs = list.map((input) => {
      // 1) ref1
      let ref1 = transformRef1(input);

      // 2) pad ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó + ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ref1 ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô
      if (padLen && /^\d+$/.test(ref1)) {
        ref1 = ref1.padStart(padLen, "0");
      }

      // 3) ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö output
      return `${payType}${fix}${ref1}${ALWAYS_SUFFIX}`;
    });

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
    document.getElementById("output_1").value = outputs.join("\n");
  }
</script>

  </div>
</div>

	
	
<div id="idcardno" class="card-content">
     <div class="card">
        <h3>ìÅã Gen : ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô </h3>
		
  <div class="radio-group">
    <label><input type="radio" name="idType" value="thai" checked onchange="updatePrefixOptions()"> ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢</label>
    <label><input type="radio" name="idType" value="alien" onchange="updatePrefixOptions()"> ‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ß</label>
  </div>

  <div class="toggle-label">
    <label class="switch">
      <input type="checkbox" id="customPrefix" onchange="togglePrefixSelect()">
      <span class="slider"></span>
    </label>
    <span>‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏á</span>
  </div>

  <label>‡πÄ‡∏•‡∏Ç‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</label>
  <select id="prefixSelect" disabled  class="small-select_id_card"></select>

  <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</label>
  <select id="count" class="small-select_id_card"> >
    <option value="3">3 ‡πÄ‡∏•‡∏Ç</option>
    <option value="5" selected>5 ‡πÄ‡∏•‡∏Ç</option>
    <option value="10">10 ‡πÄ‡∏•‡∏Ç</option>
  </select>
  
<p style="font-size: 10px; color: gray; margin-left: 10px;">
  * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç 1- 5  ‡πÅ‡∏•‡∏∞ ‡∏Ñ‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ß ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç 6-9  [‡πÅ‡∏ï‡πà‡πÉ‡∏ô Ocean ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô 0 6 7 8  ‡πÅ‡∏•‡∏∞ 9 ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢]
</p>

  <div class="btn-group">
   <button onclick="generateIDCards()">üìÑ Generate</button>
    <button onclick="copyOutput_2()">üìã Copy</button>
    <button onclick="clearOutput()">üßπ Clear</button>
  </div>

  <textarea id="output_2" readonly class="large-output"></textarea>
		
  <script>
    function updatePrefixOptions() {
      const type = document.querySelector('input[name="idType"]:checked').value;
      const prefixSelect = document.getElementById('prefixSelect');
      prefixSelect.innerHTML = '';

      const start = type === 'thai' ? 1 : 6;
      const end = type === 'thai' ? 5 : 9;

      for (let i = start; i <= end; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = i;
        prefixSelect.appendChild(opt);
      }
    }

    function togglePrefixSelect() {
      const isEnabled = document.getElementById('customPrefix').checked;
      document.getElementById('prefixSelect').disabled = !isEnabled;
    }

    function generateID(type, customPrefixEnabled, customPrefix) {
      let id = '';
      if (customPrefixEnabled) {
        id += customPrefix;
      } else {
        id += (type === 'thai') ? Math.floor(Math.random() * 5) + 1 : Math.floor(Math.random() * 4) + 6;
      }

      for (let i = 0; i < 11; i++) {
        id += Math.floor(Math.random() * 10);
      }

      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(id.charAt(i)) * (13 - i);
      }

      let checkDigit = (11 - (sum % 11)) % 10;
      return id + checkDigit;
    }

    function generateIDCards() {
  const type = document.querySelector('input[name="idType"]:checked').value;
  const count = parseInt(document.getElementById('count').value);
  const customPrefixEnabled = document.getElementById('customPrefix').checked;
  const prefix = parseInt(document.getElementById('prefixSelect').value);
  const output_2 = [];

  for (let i = 0; i < count; i++) {
    output_2.push(generateID(type, customPrefixEnabled, prefix));
  }

  document.getElementById('output_2').value = output_2.join('\n');
}


    function copyOutput_2() {
      const textarea = document.getElementById('output_2');
      textarea.select();
      document.execCommand('copy');
      //alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!');
    }

    function clearOutput() {
      document.getElementById('output_2').value = '';
    }

    // ‡πÇ‡∏´‡∏•‡∏î prefix options ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    updatePrefixOptions();
  </script>
      </div>
    </div>
	

<div id="dline" class="card-content">
     <div class="card">
<h2>üìÑ  Generator Text File - Counter Bank V.1</h2>

<div class="row">
  <label>Bank Code:</label>
  <select id="bankCommon"  class="small-input">
    <option value="002">002 BBL</option>
    <option value="004">004 KBANK</option>
    <option value="006">006 KTB</option>
    <option value="011">011 TMB</option>
	<option value="014">014 SCB</option>
	<option value="022">022 CIMB</option>
	<option value="025">025 BAY</option>
	<option value="030">030 GSB</option>
	<option value="034">034 BAAC</option>
	<option value="065">065 TNB</option>
	<option value="073">073 LH</option>

	
  </select>
</div>
<div class="row">
  <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
  <input type="date" id="txnDate"  class="small-input" onchange="syncDates()" />
</div>

<table id="detailTable">
  <thead>
    <tr>
      <th>Effective Date</th>
      <th>Payment Date</th>
      <th>Customer Name   
	<br><span style="font-size: 11px; color: Blue;">*‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Eng	</span><br>
	<span style="font-size: 11px; color: red;">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</span><br>
	
	</th>
	<p style="font-size: 10px; color: gray; margin-left: 10px;">
  * ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏∏ Customer Name ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô <strong>ANSI</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Encoding ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
</p>
      <th>Ref1 
	<br>
	<span style="font-size: 11px; color: Blue;">*‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏∏</span><br>
	</th>
      <th>Ref2</th>
      <th>Amount</th>
      <th>Fee1 
	  <br>
	<span style="font-size: 11px; color: red;">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</span><br>
	</th>
      <th>Fee2
	  <br>
	<span style="font-size: 11px; color: red;">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</span><br></th>
      <th>‡∏•‡∏ö</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button onclick="addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
<button onclick="clearRows()">üßπ Clear</button>
<button onclick="generateText()">üìÑ Generate</button>
<button onclick="copyOutput()">üìã Copy</button>
<button onclick="downloadTxt()">üíæ Export</button>

<h3>üì¶ Text Output <span style="font-size: 9px; color: Blue;"> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span>  </h3>

<textarea id="outputArea" readonly class="large-output"> </textarea>

<script>
function pad(str, len) {
  return (str || "").toString().padEnd(len, ' ').slice(0, len);
}

function getDDMMYYYY(dateStr) {
  const d = new Date(dateStr);
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = String(d.getFullYear());
  return dd + mm + yyyy;
}

function addRow() {
  const tbody = document.querySelector("#detailTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" maxlength="8" class="eff" /></td>
    <td><input type="text" maxlength="8" class="pay" /></td>
    <td><input type="text" maxlength="50" value="QA TestFile" /></td>
    <td><input type="text" maxlength="19" value="5101020120468042275" /></td>
    <td><input type="text" maxlength="8" value="28032568" /></td>
    <td><input type="number" step="0.01" maxlength="13" value="500.00" /></td>
    <td><input type="text" maxlength="2" value="00" /></td>
    <td><input type="text" maxlength="10" value="0000000000" /></td>
    <td><button onclick="this.closest('tr').remove()">üóë</button></td>
  `;
  tbody.appendChild(tr);
  syncDates();
}

function setDefault() {
  document.querySelectorAll("#detailTable tbody tr").forEach(row => {
    const date = getDDMMYYYY(document.getElementById("txnDate").value);
    row.querySelector(".eff").value = date;
    row.querySelector(".pay").value = date;
  });
}

function clearRows() {
  document.querySelector("#detailTable tbody").innerHTML = "";
}

function syncDates() {
  const date = getDDMMYYYY(document.getElementById("txnDate").value);
  document.querySelectorAll(".eff, .pay").forEach(el => el.value = date);
}

function generateText() {
  const bank = document.getElementById("bankCommon").value;
  const bankText = document.getElementById("bankCommon").selectedOptions[0].text.split(' ')[1];
  const txnDate = getDDMMYYYY(document.getElementById("txnDate").value);
  const tbody = document.querySelector("#detailTable tbody");
  const rows = tbody.querySelectorAll("tr");

  let totalAmount = 0;
  const lines = Array.from(rows).map((row, i) => {
    const cells = row.querySelectorAll("input");
    const eff = pad(cells[0].value, 8);
    const pay = pad(cells[1].value, 8);
    const name = pad(cells[2].value, 50);
    const ref1 = pad(cells[3].value, 20);
    const ref2 = pad(cells[4].value, 39);
    const rawAmt = parseFloat(cells[5].value.replace(/[^\d.]/g, ""));
    const amt = pad(String(Math.round(rawAmt * 100)).padStart(13, '0'), 13);
    totalAmount += isNaN(rawAmt) ? 0 : rawAmt;
    const fee2 = pad(cells[7].value, 10);
    const fixID = "1473129649";
    const seq = "D" + String(i + 2).padStart(6, '0');
    const fixedValue = pad("003335", 6);
    const fixedValue_2 = pad("B0250147CMBD00000000", 20);
    const fixedValue_3 = pad("0005052020", 13);
    const fixedValue_4 = pad("00", 56);
    return seq + bank + fixID + eff + fixedValue + name + ref1 + ref2 + fixedValue_2 + amt + fixedValue_3 + fixedValue_4 + fee2;
	
	
  });

  const headerRaw = "H000001" + bank + "1473129649" + bankText.padEnd(40, ' ').slice(0, 40) + txnDate + "OCLCROSS";
  const header = headerRaw.padEnd(195, ' ').slice(0, 195);

  const dCount = rows.length;
  const trailerSeq = "T" + String(dCount + 2).padStart(6, '0');
  const dCountStr = String(dCount).padStart(6, '0');
  const TfixedValue_1 = pad("0000000000000000001", 19);
  const totalAmountStr = String(Math.round(totalAmount * 100)).padStart(13, '0');
  
  const trailerRaw = trailerSeq + bank + "1473129649" + TfixedValue_1 + totalAmountStr + dCountStr  ;
  const trailer = trailerRaw.padEnd(82, ' ').slice(0, 82);

  document.getElementById("outputArea").value = header + "\n" + lines.join("\n") + "\n" + trailer;
}

function copyOutput() {
  const txt = document.getElementById("outputArea");
  txt.select();
  document.execCommand("copy");
}

function downloadTxt() {
  const blob = new Blob([document.getElementById("outputArea").value], {type: "text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Generated_DLines.txt";
  a.click();
  URL.revokeObjectURL(url);
}

window.onload = () => {
  document.getElementById("txnDate").valueAsDate = new Date();
  addRow();
};
</script>
</div>
</div>

<div id="split_text" class="card-content">
     <div class="card">
        <h2>üîÅ ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</h2>

  <label>üîπ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (Auto Detect):</label>
  <textarea id="inputArea_5" placeholder="‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô 'aaa','bbb','ccc' ‡∏´‡∏£‡∏∑‡∏≠ aaa bbb ccc"></textarea>

  <label>üîπ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô Output:</label>
  <select id="outputSelect_5" onchange="toggleCustom('output')">
    <option value="\n">‡πÄ‡∏ß‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î</option>
	<option value="quoted-comma">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Query ','</option>
    <option value="custom">‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏≠‡∏á</option>
  </select>
  <input type="text" id="outputCustom_5" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô Output ‡πÄ‡∏≠‡∏á" style="display:none" />

  <button onclick="convertDelimiter()">üìÑ ‡πÅ‡∏õ‡∏•‡∏á</button>
  <button onclick="clearAll()">üßπ Clear</button>

  <h3>üîπ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:</h3>
  <textarea id="output_5" class="large-output" readonly></textarea>

   <button onclick="copyOutput_5()">üìã Copy</button>
   
  <script>
   function toggleCustom(type) {
  const custom = document.getElementById(type + 'Custom_5');
  const select = document.getElementById(type + 'Select_5');
  custom.style.display = select.value === 'custom' ? 'block' : 'none';
}


   function getOutputDelimiter() {
  const select = document.getElementById('outputSelect_5').value.trim();
  const custom = document.getElementById('outputCustom_5').value;

  if (select === 'custom') return custom;
  
  // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á string escape ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô character ‡∏à‡∏£‡∏¥‡∏á
  if (select === '\\n') return '\n';
  if (select === '\\t') return '\t';

  // ‚úÖ return delimiter ‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏≤‡∏á ' " ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß
  if (select === 'quoted-comma') return 'quoted-comma';

  return select.replace(/^['"\s]+|['"\s]+$/g, '');
}



   function detectInputDelimiter(text) {
  const candidates = [
    { regex: /'\s*,\s*'/, label: 'quoted-comma' },
    { regex: /\s*,\s*/, label: ',' },
    { regex: /\n+/, label: 'newline' },
    { regex: /\t+/, label: 'tab' },
    { regex: /\s{2,}/, label: 'double space' },
    { regex: /\s+/, label: 'space' },
  ];

  let bestMatch = candidates[0];
  let maxParts = 0;

  candidates.forEach(c => {
    // ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á replace quote ‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô split
    const cleanedText = text.replace(/^['"]+|['"]+$/g, '');
    const parts = cleanedText.split(c.regex).filter(x => x.trim() !== '');
    if (parts.length > maxParts) {
      maxParts = parts.length;
      bestMatch = c;
    }
  });

  return bestMatch.regex;
}

function convertDelimiter() {
  const inputText = document.getElementById('inputArea_5').value.trim();
  const outputDelimiter = getOutputDelimiter();

  // ‚úÖ ‡πÉ‡∏ä‡πâ match ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö universal
  const parts = inputText
    .match(/(['"]?[\w‡∏Å-‡πô]+['"]?)/g)  // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÄ‡∏•‡∏Ç ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ quote
    .map(x =>
      x
        .replace(/^[\s,'"\[\]]+/, '')
        .replace(/[\s,'"\[\]]+$/, '')
        .trim()
    )
    .filter(Boolean);

  let result = '';
  if (outputDelimiter === 'quoted-comma') {
    result = parts.map(x => `'${x}'`).join(',');
  } else {
    result = parts.join(outputDelimiter);
  }

  document.getElementById('output_5').value = result;

}

function copyOutput_5() {
  const txt = document.getElementById("output_5");
  txt.select();
  document.execCommand("copy");
}


    function clearAll() {
      document.getElementById('inputArea_5').value = '';
     document.getElementById('output_5').value = '';

    }
  </script>
  </div>
</div>

<div id="json_gen" class="card-content">
     <div class="card">
        <h2>üì¶ Gen : JSON For Test Data</h2>
		
		
<div>
  <label>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: <input id="new-column-name_6" placeholder="‡πÄ‡∏ä‡πà‡∏ô Column_1" /></label>
  <button onclick="addColumn_6()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á</button>
  <button onclick="addRow_6()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

<table id="data-table">
  <thead>
    <tr id="header-row">
      <!-- ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    </tr>
  </thead>
  <tbody id="table-body">
    <!-- ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
  </tbody>
</table>
<label class="switch">
  <input type="checkbox" id="toggle-running_6" onchange="renderHeader_6(); renderRunningNo_6();" checked />
  <span class="slider"></span></label>
<span> ‡πÅ‡∏™‡∏î‡∏á Running No.</span>
 <button onclick="generateJSON_6()">üîÅ Generate JSON</button>
</label>
<div style="margin-top: 10px;">

<div style="margin-top: 10px;">
<h3>üìÑ JSON Output</h3>
<textarea id="json-output_6" readonly class="medium-output"></textarea><br>
<button onclick="copyJSONToClipboard_6()">üìã Copy JSON</button>

  <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: <input id="file-name_6" value="test-data" /></label>
  <label style="margin-left: 10px;">
    ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö:
    <select id="file-type_6" class="small-select_id_card">
      <option value="json">.json</option>
      <option value="csv">.csv</option>
      <option value="xlsx">.xlsx</option>
    </select>
  </label>
  <button onclick="exportData_6()">üì§ Export</button>
</div>

</div>

<h3>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON</h3>
<textarea id="json-input_6" placeholder="‡∏ß‡∏≤‡∏á JSON ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤" class="medium-output"></textarea><br/>
<button onclick="importJSON_6()">üì• Import ‡∏à‡∏≤‡∏Å Text Area ‡∏ô‡∏µ‡πâ</button>



<h3>üìÇ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå JSON / CSV / XLSX</h3>
<input type="file" id="file-import_6" accept=".csv,.xlsx,.json" />
<button onclick="handleFileImport_6()">üì• Import File</button>



<script>
  const headerRow = document.getElementById('header-row');
  const tableBody = document.getElementById('table-body');
  const jsonOutput = document.getElementById('json-output_6');
  let columns = ['Value_1', 'Value_2', 'Value_3'];

  function addColumn_6() {
    const input = document.getElementById('new-column-name_6');
    const newCol = input.value.trim();
    if (!newCol) return alert('üõë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå');
    if (columns.includes(newCol)) return alert('‚ö†Ô∏è ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
    columns.push(newCol);
    renderHeader_6();
    [...tableBody.children].forEach(row => {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.oninput = exportJSON_6;
      td.appendChild(input);
      row.insertBefore(td, row.lastChild);
    });
    input.value = '';
    exportJSON_6();
  }

  function renderHeader_6() {
    headerRow.innerHTML = '';
    const showRunning = document.getElementById('toggle-running_6').checked;
    if (showRunning) {
      const thNo = document.createElement('th');
      thNo.textContent = '#';
      headerRow.appendChild(thNo);
    }
    columns.forEach((col, index) => {
      const th = document.createElement('th');
      const span = document.createElement('span');
      span.textContent = col;
      th.appendChild(span);
      const editBtn = document.createElement('button');
      editBtn.textContent = '‚úèÔ∏è';
      editBtn.style.marginLeft = '6px';
      editBtn.onclick = () => editColumn_6(index);
      th.appendChild(editBtn);
      headerRow.appendChild(th);
    });
    const thDelete = document.createElement('th');
    thDelete.textContent = 'üóëÔ∏è';
    headerRow.appendChild(thDelete);
    renderRunningNo_6();
  }

  function editColumn_6(index) {
    const oldName = columns[index];
    const newName = prompt(`üîß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "${oldName}" ‡πÄ‡∏õ‡πá‡∏ô:`, oldName);
    if (!newName || newName.trim() === '') return alert('‚ö†Ô∏è ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á');
    if (columns.includes(newName) && newName !== oldName) return alert('‚ö†Ô∏è ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
    columns[index] = newName.trim();
    renderHeader_6();
    exportJSON_6();
  }

  function renderRunningNo_6() {
    const showRunning = document.getElementById('toggle-running_6').checked;
    [...tableBody.children].forEach((row, index) => {
      const exist = row.querySelector('.cell-running');
      if (showRunning && !exist) {
        const td = document.createElement('td');
        td.className = 'cell-running';
        td.textContent = index + 1;
        row.insertBefore(td, row.firstChild);
      } else if (!showRunning && exist) {
        exist.remove();
      } else if (exist) {
        exist.textContent = index + 1;
      }
    });
  }

  function addRow_6(data = {}) {
    const tr = document.createElement('tr');
    const showRunning = document.getElementById('toggle-running_6').checked;
    if (showRunning) {
      const tdNo = document.createElement('td');
      tdNo.className = 'cell-running';
      tdNo.textContent = tableBody.children.length + 1;
      tr.appendChild(tdNo);
    }
    columns.forEach(col => {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.value = data[col] || '';
      input.oninput = exportJSON_6;
      td.appendChild(input);
      tr.appendChild(td);
    });
    const tdDel = document.createElement('td');
    const btn = document.createElement('button');
    btn.textContent = '‡∏•‡∏ö';
    btn.onclick = () => {
      tr.remove();
      exportJSON_6();
      renderRunningNo_6();
    };
    tdDel.appendChild(btn);
    tr.appendChild(tdDel);
    tableBody.appendChild(tr);
    exportJSON_6();
  }

  function generateJSON_6() {
    const result = [];
    const showRunning = document.getElementById('toggle-running_6').checked;
    [...tableBody.children].forEach((row, index) => {
      const inputs = row.querySelectorAll('input');
      const item = {};
      if (showRunning) item.no = index + 1;
      columns.forEach((col, idx) => {
        item[col] = inputs[idx].value;
      });
      result.push(item);
    });
    jsonOutput.value = JSON.stringify(result, null, 2);
  }

  function exportJSON_6() {
    generateJSON_6();
  }

  function exportData_6() {
    generateJSON_6();
    const data = JSON.parse(jsonOutput.value);
    const fileName = document.getElementById('file-name_6').value.trim() || 'data';
    const fileType = document.getElementById('file-type_6').value;
    if (fileType === 'json') {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      downloadBlob(blob, fileName + '.json');
    } else if (fileType === 'csv') {
      const csv = jsonToCSV(data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      downloadBlob(blob, fileName + '.csv');
    } else if (fileType === 'xlsx') {
      exportToXLSX(data, fileName + '.xlsx');
    }
  }

  function downloadBlob(blob, fileName) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportToXLSX(jsonData, fileName) {
    const worksheet = XLSX.utils.json_to_sheet(jsonData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");
    XLSX.writeFile(workbook, fileName);
  }

  function jsonToCSV(jsonArray) {
    if (!jsonArray.length) return '';
    const keys = Object.keys(jsonArray[0]);
    const lines = jsonArray.map(obj => keys.map(k => `"${(obj[k] ?? '').toString().replace(/"/g, '""')}"`).join(','));
    return keys.join(',') + '\n' + lines.join('\n');
  }

  function handleFileImport_6() {
    const fileInput = document.getElementById('file-import_6');
    const file = fileInput.files[0];
    if (!file) return alert('üìÇ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô');
    const reader = new FileReader();
    const fileExt = file.name.split('.').pop().toLowerCase();
    reader.onload = function (e) {
      const content = e.target.result;
      if (fileExt === 'csv') {
        const data = CSVToJSON(content);
        processImportedData_6(data);
      } else if (fileExt === 'xlsx') {
        const workbook = XLSX.read(content, { type: 'binary' });
        const sheetName = workbook.SheetNames[0];
        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
        processImportedData_6(jsonData);
      } else if (fileExt === 'json') {
        try {
          const jsonData = JSON.parse(content);
          processImportedData_6(jsonData);
        } catch (err) {
          alert('‚ùå ‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
      } else {
        alert('‚ùå ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .csv, .xlsx ‡πÅ‡∏•‡∏∞ .json');
      }
    };
    if (fileExt === 'xlsx') {
      reader.readAsBinaryString(file);
    } else {
      reader.readAsText(file);
    }
  }

  function CSVToJSON(csv) {
    const parsed = Papa.parse(csv, {
      header: true,
      skipEmptyLines: true,
      dynamicTyping: false,
    });
    return parsed.data;
  }

  function copyJSONToClipboard_6() {
    const textarea = document.getElementById('json-output_6');
    textarea.select();
    textarea.setSelectionRange(0, 99999);
    document.execCommand('copy');
  }

  function processImportedData_6(data) {
    if (!Array.isArray(data)) {
      alert('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array');
      return;
    }
    columns = [...new Set(data.flatMap(obj => Object.keys(obj)).filter(k => k !== 'no'))];
    renderHeader_6();
    tableBody.innerHTML = '';
    data.forEach(item => addRow_6(item));
    generateJSON_6();
  }

  function importJSON_6() {
    const input = document.getElementById('json-input_6').value.trim();
    try {
      const parsed = JSON.parse(input);
      if (!Array.isArray(parsed)) throw '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array';
      processImportedData_6(parsed);
    } catch {
      const csvLike = input.includes('\t') ? input.replace(/\t/g, ',') : input;
      const lines = csvLike.split('\n').map(l => l.trim()).filter(Boolean);
      const headers = lines[0].split(',').map(h => h.trim());
      const data = lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i] || '');
        return obj;
      });
      processImportedData_6(data);
    }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  renderHeader_6();
  addRow_6();
</script>

 </div>
</div>


<div id="google_gen" class="card-content">
  <div class="card">
    <h3>üìù Google Sheets : Formula Generator</h3>


    <div class="row">
        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏π‡∏ï‡∏£:</label>
        <select id="formulaType_select_column" style="width: 100px;">
          <option value="xlookup_latest">XLOOKUP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (FILTER+SORT)</option>
          <option value="iferror">IFERROR ‡∏£‡∏≠‡∏ö‡∏™‡∏π‡∏ï‡∏£</option>
          <option value="vlookup">VLOOKUP ‡∏õ‡∏Å‡∏ï‡∏¥</option>
        </select>
</div>
<div class="row">
        <label>‡∏ä‡∏∑‡πà‡∏≠ Tab ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á:</label>
        <input type="text" id="targetSheet_select_column" style="width: 100px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô TEST_SUITE">
</div>
 <div class="row">
        <label>Cell ‡∏ó‡∏µ‡πà‡∏°‡∏µ Key (target):</label>
        <input type="text" id="targetKeyCell_select_column" style="width: 150px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô C8">
</div>
 <div class="row">
        <label>‡∏ä‡∏∑‡πà‡∏≠ Tab ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á (source):</label>
        <input type="text" id="sourceSheet_select_column" style="width: 150px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô upload_to_sheet">
</div>
 <div class="row">
        <label>‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (columns):</label>
        <input type="text" id="sourceCols_select_column" style="width: 150px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô A:E ‡∏´‡∏£‡∏∑‡∏≠ A-E ‡∏´‡∏£‡∏∑‡∏≠ 1-5">
</div>
 <div class="row">
        <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Key (source):</label>
        <input type="text" id="sourceKeyCol_select_column" style="width: 150px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô C">
</div>
 <div class="row">
        <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
        <input type="text" id="resultColInput_select_column" style="width: 150px;" placeholder="‡πÄ‡∏ä‡πà‡∏ô E ‡∏´‡∏£‡∏∑‡∏≠ 5">
</div>
      </div>
    

    <div class="section">
      <h4><label>üîπ‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:</label></h4>
      <textarea id="generatedFormula_select_column" readonly class="medium-output"></textarea><br>
      <button class="btn" onclick="copyFormula_select_column()">üìã Copy ‡∏™‡∏π‡∏ï‡∏£</button>
      <button class="btn btn-clear" onclick="clearInputs_select_column()">üßπ Clear</button>
    </div>
  

  <script>
    document.getElementById("formulaType_select_column").addEventListener("change", generateFormula_select_column);
    document.querySelectorAll("input, select").forEach(el => el.addEventListener("input", generateFormula_select_column));

    function columnLetterToNumber(col) {
      col = col.toUpperCase();
      let num = 0;
      for (let i = 0; i < col.length; i++) {
        num = num * 26 + (col.charCodeAt(i) - 64);
      }
      return num;
    }

    function numberToColumnLetter(n) {
      let result = "";
      while (n > 0) {
        const rem = (n - 1) % 26;
        result = String.fromCharCode(65 + rem) + result;
        n = Math.floor((n - 1) / 26);
      }
      return result;
    }

    function normalizeRangeInput(rangeInput) {
      if (/^[A-Z]-[A-Z]$/i.test(rangeInput)) {
        const parts = rangeInput.toUpperCase().split("-");
        return `${parts[0]}:${parts[1]}`;
      } else if (/^\d+-\d+$/.test(rangeInput)) {
        const parts = rangeInput.split("-").map(Number);
        return `${numberToColumnLetter(parts[0])}:${numberToColumnLetter(parts[1])}`;
      }
      return rangeInput;
    }

    function expandRangeIfNeeded(range, targetColLetter) {
      const match = range.match(/^([A-Z]+):([A-Z]+)$/);
      if (!match) return range;

      const startCol = match[1];
      let endCol = match[2];
      const startNum = columnLetterToNumber(startCol);
      let endNum = columnLetterToNumber(endCol);
      const targetNum = columnLetterToNumber(targetColLetter);

      if (targetNum > endNum) {
        endNum = targetNum;
        endCol = numberToColumnLetter(endNum);
        return `${startCol}:${endCol}`;
      }
      return range;
    }

    function generateFormula_select_column() {
  const type = document.getElementById("formulaType_select_column").value;
  const src = document.getElementById("sourceSheet_select_column").value.trim();
  let range = document.getElementById("sourceCols_select_column").value.trim();
  const keyCol = document.getElementById("sourceKeyCol_select_column").value.trim();
  const tgt = document.getElementById("targetSheet_select_column").value.trim();
  const keyCell = document.getElementById("targetKeyCell_select_column").value.trim();
  const resultInput = document.getElementById("resultColInput_select_column").value.trim();

  if (!(src && range && keyCol && tgt && keyCell && resultInput)) {
    document.getElementById("generatedFormula_select_column").value = "‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö";
    return;
  }

  range = normalizeRangeInput(range);
  const colLetter = isNaN(resultInput) ? resultInput : numberToColumnLetter(parseInt(resultInput));
  range = expandRangeIfNeeded(range, colLetter);
  const colIndex = isNaN(resultInput) ? columnLetterToNumber(resultInput) : parseInt(resultInput);

  let formula = "";
  if (type === "xlookup_latest") {
    formula = `=IFERROR(\n  INDEX(\n    SORT(\n      FILTER('${src}'!${range}, TRIM('${src}'!${keyCol}:${keyCol}) = TRIM(${keyCell})),\n      1, FALSE\n    ),\n    1, ${colIndex}\n  ),\n  "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"\n)`;
  } else if (type === "iferror") {
    formula = `=IFERROR(...‡∏™‡∏π‡∏ï‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...)`;
  } else if (type === "vlookup") {
    formula = `=VLOOKUP(${keyCell}, '${src}'!${range}, ${colIndex}, FALSE)`;
  }

  document.getElementById("generatedFormula_select_column").value = formula;
}


    function copyFormula_select_column() {
  const formula = document.getElementById("generatedFormula_select_column");
  formula.select(); // 
  document.execCommand("copy"); // 
 
}
    

    function clearInputs_select_column() {
      const ids = [
        "targetSheet_select_column",
        "targetKeyCell_select_column",
        "sourceSheet_select_column",
        "sourceCols_select_column",
        "sourceKeyCol_select_column",
        "resultColInput_select_column"
      ];
      ids.forEach(id => document.getElementById(id).value = "");
      document.getElementById("formulaType_select_column").selectedIndex = 0;
      document.getElementById("generatedFormula_select_column").value = "";
    }
  </script>
 </div>
 </div>
 
  
<div id="claimpay_wht" class="card-content">
  <div class="card">
   
   <div class="wrap">
    
    <h2>üß∞ Claim payment Tools (All-in-One)</h2>
    <p class="desc">‡∏£‡∏ß‡∏° 4 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Ä¢ ‡πÉ‡∏ä‡πâ dropdown ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ ‚Ä¢ by usa.lo (‡πÄ‡∏à‡πä‡∏ï‡∏¥‡πä‡∏î)</p>

    <div class="toolbar" style="display:flex;align-items:center;gap:.5rem;justify-content:flex-start;">
  <label for="wht-picker">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</label>
  <select id="wht-picker"
    style="width: 320px; height: 36px; padding: 4px 10px; border-radius: 8px; margin-right:.5rem;">
    <option value="wht-tool-1" selected>BBL e-WHT</option>
    <option value="wht-tool-2">BBL Transfer / PromptPay</option>
    <option value="wht-tool-3">SCB Smart Credit DCP</option>
    <option value="wht-tool-4">SCB Smart Credit ORFT</option>
  </select>
  <button class="brand" id="wht-open">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
  <button id="wht-reset">Reset</button>
</div>


    <div class="tool-host">

  <!-- ‡∏Ñ‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á tool-1 .. tool-4 ‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ -->
      <!-- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: -->
     <div id="wht-tool-1" class="tool-frame">
        <iframe title="BBL e-WHT"
          sandbox="allow-scripts allow-downloads allow-forms allow-modals allow-same-origin"
          srcdoc="<!DOCTYPE html><html><head><base target=&quot;_blank&quot;></head><!DOCTYPE html>
<html lang=&quot;th&quot;>
<head>
  <meta charset=&quot;UTF-8&quot;>
  <title>Claim Payment BBL e-WHT</title>
  <style>
    body { font-family: 'Sarabun', Arial, sans-serif; background: #f7f9fa; }
    .container { padding: 10px 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #c2c2c2; padding: 5px 6px; text-align: center; min-width: 110px; }
    th { background: #d3e6fd; color: #222; font-size: 1rem;}
    input[type=&quot;text&quot;] { width: 100px; padding: 3px 7px; border-radius: 4px; border: 1px solid #bbb;}
    .fix-cell input { background: #eaffea !important; }
    .readonly { background: #eaffea !important; color: #888; }
    .flex { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .btn { padding: 5px 16px; background: #7da7e8; border: none; color: #fff; border-radius: 4px; margin: 0 7px 10px 0; cursor: pointer; font-size: 1rem; }
    .btn:hover { background: #4a81c3;}
    .hidden { display: none; }
    #result { margin-top: 18px; font-size: 1.05em; background: #f9f9f9; border: 1px solid #eee; padding: 10px;}
    .scrollx { overflow-x: auto; }
  </style>
</head>
<body>
<div class=&quot;container&quot;>
  <h2>üè¶ BBL e-WHT Export File</h2>

    &lt;!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ --&gt;
  &lt;div style=&quot;background: #fff7d6; border: 1px solid #f2d76c; padding: 10px 14px; border-radius: 6px; color: #333; font-size: 1rem; margin-bottom: 15px;&quot;&gt;
  üìÑ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Format(.txt) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúImport‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúExport File‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    &lt;p&gt;üìå  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á ~Status (~Paid ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ/ ~Return ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚ùå)&lt;/p&gt;
  &lt;/div&gt;

  &lt;!-- ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° --&gt;
  &lt;div class=&quot;flex&quot;&gt;
    &lt;input type=&quot;file&quot; id=&quot;importFile&quot; accept=&quot;.txt&quot;&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;importTxt()&quot;&gt;üì•Import&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;saveTable()&quot;&gt;üíæSave&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;clearTable()&quot;&gt;üßπClear&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;copyPipe()&quot;&gt;üìãCopy | (Pipe)&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;copyConcat()&quot;&gt;üìãCopy (Concat)&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;exportTxt()&quot;&gt;üóÇÔ∏èExport&lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;



  &lt;div class=&quot;scrollx&quot;&gt;
    &lt;table id=&quot;wht-table&quot;&gt;
	  &lt;thead&gt;
      &lt;tr&gt;
        &lt;th&gt;Seq&lt;/th&gt;
        &lt;th&gt;~Batch Ref No&lt;/th&gt;
        &lt;th&gt;~Sub Batch Ref No&lt;/th&gt;
        &lt;th&gt;~Cust Ref No&lt;/th&gt;
        &lt;th&gt;~Payment Ref No&lt;/th&gt;
        &lt;th&gt;~Customer Code&lt;/th&gt;
        &lt;th&gt;~Debit Account No&lt;/th&gt;
        &lt;th&gt;~Product Code&lt;/th&gt;
        &lt;th&gt;~Payee Code&lt;/th&gt;
        &lt;th&gt;~Payee Name&lt;/th&gt;
        &lt;th&gt;~Payee Account No&lt;/th&gt;
        &lt;th&gt;~Credit Bank Code&lt;/th&gt;
        &lt;th&gt;~Bank Branch Code&lt;/th&gt;
        &lt;th&gt;~Payee Charge Code&lt;/th&gt;
        &lt;th&gt;~Swift Code&lt;/th&gt;
        &lt;th&gt;~Processing Date&lt;/th&gt;
        &lt;th&gt;~Value Date&lt;/th&gt;
        &lt;th&gt;~Payment Amount&lt;/th&gt;
        &lt;th&gt;~Payment Currency&lt;/th&gt;
        &lt;th&gt;~Buying Rate&lt;/th&gt;
        &lt;th&gt;~Selling Rate&lt;/th&gt;
        &lt;th&gt;~Fix Amount Mode&lt;/th&gt;
        &lt;th&gt;~Instrument No.&lt;/th&gt;
        &lt;th&gt;~Status&lt;/th&gt;
        &lt;th&gt;~Reason of Status&lt;/th&gt;
        &lt;th&gt;~WHT&lt;/th&gt;
        &lt;th&gt;~Internal ref&lt;/th&gt;
        &lt;th&gt;~WHT Running No.&lt;/th&gt;
        &lt;th&gt;~WHT Inc Type&lt;/th&gt;
        &lt;th&gt;~WHT Rate&lt;/th&gt;
        &lt;th&gt;~Inc Type Amt.&lt;/th&gt;
        &lt;th&gt;~WHT Amt.&lt;/th&gt;
        &lt;th&gt;~INV&lt;/th&gt;
        &lt;th&gt;~Internal ref&lt;/th&gt;
        &lt;th&gt;~Invoice Description&lt;/th&gt;
        &lt;th&gt;~Inv Amt&lt;/th&gt;
        &lt;th&gt;~VAT Amount&lt;/th&gt;
        &lt;th&gt;~Invoice No.&lt;/th&gt;
        &lt;th&gt;~PO No&lt;/th&gt;
        &lt;th&gt;~Inv. Date&lt;/th&gt;
      &lt;/tr&gt;
	 &lt;/thead&gt;
	  &lt;tbody id=&quot;tbody-table&quot;&gt;
      &lt;tr&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
        &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt; &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt; &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt; &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;  &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;  &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;  &lt;/tr&gt;
	   &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;

  &lt;div id=&quot;result&quot; class=&quot;hidden&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;script&gt;
// Declare a global variable to store the Invoice Description
let globalInvoiceDescription = &#x27;&#x27;;

// ---------------- CONFIG ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô ------------------
const FIELD_CONFIG = [
¬† // (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 8 ‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å, ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á)
¬† // 0: Seq
¬† { type: &quot;from_line&quot;,¬† startWith: &quot;003~&quot;, fieldIdx: 2 },
¬† // 1: ~Batch Ref No
¬† { type: &quot;fixed&quot;, value: &quot;~OCEANIN008048&quot; },
¬† // 2: ~Sub Batch Ref No
¬† { type: &quot;fixed&quot;, value: &quot;~1719&quot; },
¬† // 3: ~Cust Ref No¬†
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 8, prefix: &quot;~&quot; },
¬† // 4: ~Payment Ref No
¬† { type: &quot;fixed&quot;, value: &quot;~00BOCEANIN1011570&quot; },
¬† // 5: ~Customer Code
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 1, prefix: &quot;~&quot; },
¬† // 6: ~Debit Account No
¬† { type: &quot;fixed&quot;, value: &quot;~9250025955&quot; },
¬† // 7: ~Product Code
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 3, prefix: &quot;~&quot; },
¬† // 8: ~Payee Code	
¬† { type: &quot;fixed&quot;, value: &quot;~&quot; }, // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á fix ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
¬† // 9: ~Payee Name
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 43, prefix: &quot;~&quot; },
¬† // 10: ~Payee Account No
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 4, prefix: &quot;~&quot; },
¬† // 11: ~Credit Bank Code
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 37, prefix: &quot;~&quot; },
¬† // 12: ~Bank Branch Code
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 38, prefix: &quot;~&quot; },
¬† // 13: ~Payee Charge Code
¬† { type: &quot;fixed&quot;, value: &quot;~BEN&quot; },
¬† // 14: ~Swift Code
¬† { type: &quot;fixed&quot;, value: &quot;~014&quot; },
¬† // 15: ~Processing Date
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 5, prefix: &quot;~&quot; , dateFormat: true },
¬† // 16: ~Value Date
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 5, prefix: &quot;~&quot; , dateFormat: true },
¬† // 17: ~Payment Amount
¬† { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 33, prefix: &quot;~&quot; , decimal: 2 },
¬† // 18: ~Payment Currency
¬† { type: &quot;fixed&quot;, value: &quot;~THB&quot; },
¬† // 19: ~Buying Rate
¬† { type: &quot;fixed&quot;, value: &quot;~&quot; },
¬† // 20: ~Selling Rate
¬† { type: &quot;fixed&quot;, value: &quot;~&quot; },
¬† // 21: ~Fix Amount Mode
¬† { type: &quot;fixed&quot;, value: &quot;~C&quot; },
¬† // 22: ~Instrument No.
¬† { type: &quot;fixed&quot;, value: &quot;~&quot; },
¬† // 23: ~Status
¬† { type: &quot;dropdown&quot;, options: [&quot;~Paid&quot;, &quot;~Return&quot;], defaultValue: &quot;~Paid&quot; },
¬† // 24: ~Reason of Status
¬† { type: &quot;fixed&quot;, value: &quot;~&quot; },
¬† // 25: ~WHT
¬† { type: &quot;fixed&quot;, value: &quot;~WHT1&quot; },
¬† // 26: ~Internal ref
¬† { type: &quot;from_line&quot;, startWith: &quot;005~&quot;, fieldIdx: 1, prefix: &quot;~&quot; },
¬† // 27: ~WHT Running No.
¬† { type: &quot;fixed&quot;, value: &quot;~1&quot; },
¬† // 28: ~WHT Inc Type
¬† { type: &quot;fixed&quot;, value: &quot;~21&quot; },
¬† // 29: ~WHT Rate
¬† { type: &quot;from_line&quot;, startWith: &quot;005~&quot;, fieldIdx: 5, prefix: &quot;~&quot; , decimal: 2 },
¬† // 30: ~Inc Type Amt.
¬† { type: &quot;from_line&quot;, startWith: &quot;005~&quot;, fieldIdx: 6, prefix: &quot;~&quot; , decimal: 2 },
¬† // 31: ~WHT Amt.
¬† { type: &quot;from_line&quot;, startWith: &quot;005~&quot;, fieldIdx: 3, prefix: &quot;~&quot; , decimal: 2 },
¬† // 32: ~INV
¬† { type: &quot;fixed&quot;, value: &quot;~INV&quot; },
¬† // 33: ~Internal ref
¬† { type: &quot;from_line&quot;, startWith: &quot;009~&quot;, fieldIdx: 5, prefix: &quot;~&quot; },
¬† // 34: ~Invoice Description
¬† { type: &quot;from_line&quot;, startWith: &quot;001~&quot;, fieldIdx: 4, prefix: &quot;~&quot; },
¬† // 35: ~Inv Amt
¬† { type: &quot;from_line&quot;, startWith: &quot;009~&quot;, fieldIdx: 2, prefix: &quot;~&quot; , decimal: 2 },
¬† // 36: ~VAT Amount
¬† { type: &quot;from_line&quot;, startWith: &quot;009~&quot;, fieldIdx: 4, prefix: &quot;~&quot; , decimal: 2 },
¬† // 37: ~Invoice No.
¬† { type: &quot;from_line&quot;, startWith: &quot;009~&quot;, fieldIdx: 1, prefix: &quot;~&quot; },
¬† // 38: ~PO No
¬† { type: &quot;from_line&quot;, startWith: &quot;009~&quot;, fieldIdx: 1, prefix: &quot;~&quot; },
¬† // 38: ~Inv. Date
¬† { type: &quot;fixed&quot;, value: &quot;~&quot; },


];
// ---------- END CONFIG ----------------------------

function importTxt() {
¬† const fileInput = document.getElementById(&#x27;importFile&#x27;);
¬† if (!fileInput.files[0]) return alert(&#x27;‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå&#x27;);
¬† const reader = new FileReader();
¬† reader.onload = function(e) {
¬† ¬† let text = e.target.result.replace(/\r/g, &#x27;&#x27;);
¬† ¬† const lines = text.split(&#x27;\n&#x27;).filter(x =&gt; x.trim() !== &quot;&quot;);

¬† ¬† // 1. ‡πÅ‡∏¢‡∏Å Header/Detail/Footer
¬† ¬† const headerLine = lines.find(line =&gt; line.startsWith(&quot;001~&quot;)) || &quot;&quot;;
¬† ¬† const detailLines = lines.filter(line =&gt; /^(003|005|009)~/.test(line));

    // Capture the Invoice Description from the 001 line
    if (headerLine) {
        const headerFields = headerLine.split(&#x27;~&#x27;);
        if (headerFields[4] !== undefined) {
            globalInvoiceDescription = headerFields[4].trim();
        } else {
            globalInvoiceDescription = &#x27;&#x27;; // Clear if not found
        }
    } else {
        globalInvoiceDescription = &#x27;&#x27;; // Clear if no header line
    }

¬† ¬† // 2. Split blocks ‡∏ï‡∏≤‡∏° 003~
¬† ¬† let blocks = [];
¬† ¬† let curr = [];
¬† ¬† detailLines.forEach(line =&gt; {
¬† ¬† ¬† if (line.startsWith(&#x27;003~&#x27;) &amp;&amp; curr.length) {
¬† ¬† ¬† ¬† blocks.push(curr);
¬† ¬† ¬† ¬† curr = [];
¬† ¬† ¬† }
¬† ¬† ¬† curr.push(line);
¬† ¬† });
¬† ¬† if (curr.length) blocks.push(curr);

¬† ¬† // 3. Map Data
¬† ¬† const tbody = document.getElementById(&#x27;tbody-table&#x27;);
¬† ¬† tbody.innerHTML = &quot;&quot;;

¬† ¬† blocks.forEach((block, rowIdx) =&gt; {
¬† ¬† ¬† const tr = document.createElement(&#x27;tr&#x27;);
¬† ¬† ¬† FIELD_CONFIG.forEach((conf, idx) =&gt; {
¬† ¬† ¬† ¬† const td = document.createElement(&#x27;td&#x27;);

¬† ¬† ¬† ¬† if (conf.type === &quot;dropdown&quot;) { // Handle dropdown type
¬† ¬† ¬† ¬† ¬† const select = document.createElement(&#x27;select&#x27;);
¬† ¬† ¬† ¬† ¬† conf.options.forEach(optionText =&gt; {
¬† ¬† ¬† ¬† ¬† ¬† const option = document.createElement(&#x27;option&#x27;);
¬† ¬† ¬† ¬† ¬† ¬† option.value = optionText;
¬† ¬† ¬† ¬† ¬† ¬† option.textContent = optionText;
¬† ¬† ¬† ¬† ¬† ¬† select.appendChild(option);
¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† ¬† select.value = conf.defaultValue; // Set default value

¬† ¬† ¬† ¬† ¬† td.appendChild(select);
¬† ¬† ¬† ¬† } else { // Existing logic for input text fields
¬† ¬† ¬† ¬† ¬† const input = document.createElement(&#x27;input&#x27;);
¬† ¬† ¬† ¬† ¬† input.type = &quot;text&quot;;
¬† ¬† ¬† ¬† ¬† let val = &quot;&quot;;
¬† ¬† ¬† ¬† ¬† if (conf.type === &quot;fixed&quot;) {
¬† ¬† ¬† ¬† ¬† ¬† val = conf.value;
¬† ¬† ¬† ¬† ¬† ¬† td.classList.add(&quot;fix-cell&quot;);
¬† ¬† ¬† ¬† ¬† ¬† input.classList.add(&quot;readonly&quot;);
¬† ¬† ¬† ¬† ¬† ¬† input.readOnly = true;
¬† ¬† ¬† ¬† ¬† } else if (conf.type === &quot;from_line&quot;) {
¬† ¬† ¬† ¬† ¬† ¬† let line = null;
¬† ¬† ¬† ¬† ¬† ¬† if (conf.startWith === &quot;001~&quot;) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† line = headerLine;
¬† ¬† ¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† line = block.find(line =&gt; line.startsWith(conf.startWith));
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† if (line) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† const fields = line.split(&#x27;~&#x27;);
¬† ¬† ¬† ¬† ¬† ¬† ¬† val = fields[conf.fieldIdx] !== undefined ? fields[conf.fieldIdx].trim() : &quot;&quot;;
¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.prefix &amp;&amp; !val.startsWith(conf.prefix)) val = conf.prefix + val;
¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.dateFormat) val = conf.prefix + formatThaiDate(val);
¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.decimal &amp;&amp; !isNaN(Number(val.replace(conf.prefix, &quot;&quot;)))) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let num = Number(val.replace(conf.prefix, &quot;&quot;));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!conf.noDivide) num = num / 100;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† val = conf.prefix + num.toFixed(conf.decimal);
¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† input.value = val;
¬† ¬† ¬† ¬† ¬† td.appendChild(input);
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† tr.appendChild(td);
¬† ¬† ¬† });
¬† ¬† ¬† tbody.appendChild(tr);
¬† ¬† });
¬† };
¬† reader.readAsText(fileInput.files[0]);
}

function formatThaiDate(str) {
¬† // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÅ‡∏ö‡∏ö 27052025 ‡∏´‡∏£‡∏∑‡∏≠ ~27052025
¬† str = str.replace(/^~/, &quot;&quot;); // ‡πÄ‡∏≠‡∏≤ ~ ‡∏≠‡∏≠‡∏Å
¬† if (str.length !== 8) return str; // ‡∏ñ‡πâ‡∏≤ format ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á 8 ‡∏´‡∏•‡∏±‡∏Å return ‡πÄ‡∏î‡∏¥‡∏°
¬† const day = str.substring(0,2);
¬† const month = str.substring(2,4);
¬† const year = str.substring(6,8);
¬† const monthNames = [
¬† ¬† &#x27;&#x27;, &#x27;Jan&#x27;, &#x27;Feb&#x27;, &#x27;Mar&#x27;, &#x27;Apr&#x27;, &#x27;May&#x27;, &#x27;Jun&#x27;, &#x27;Jul&#x27;, &#x27;Aug&#x27;, &#x27;Sep&#x27;, &#x27;Oct&#x27;, &#x27;Nov&#x27;, &#x27;Dec&#x27;
¬† ];
¬† let mIdx = parseInt(month, 10);
¬† if (!mIdx || mIdx &gt; 12) return str;
¬† return day + &#x27;-&#x27; + monthNames[mIdx] + &#x27;-&#x27; + year;
}


function saveTable() {
¬† const rows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let arr = [];
¬† rows.forEach(tr =&gt; {
¬† ¬† let rowData = [];
¬† ¬† // Use getCellValue for saving as well
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; rowData.push(getCellValue(td)));
¬† ¬† arr.push(rowData);
¬† });
¬† document.getElementById(&#x27;result&#x27;).classList.remove(&#x27;hidden&#x27;);
¬† document.getElementById(&#x27;result&#x27;).innerText = JSON.stringify(arr, null, 2);
}

function clearTable() {
  const tbody = document.getElementById('tbody-table');
  if (tbody) {
    // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ (‡πÄ‡∏ß‡πâ‡∏ô readonly)
    tbody.querySelectorAll('input:not([readonly])').forEach(i => {
      if (i.type === 'checkbox' || i.type === 'radio') i.checked = false;
      else i.value = '';
    });
    tbody.querySelectorAll('select').forEach(sel => { sel.selectedIndex = 0; });
  }
  const fileInput = document.getElementById('importFile');
  if (fileInput) fileInput.value = '';

  const rs = document.getElementById('result');
  if (rs) { rs.classList.add('hidden'); rs.innerText = ''; }

  if (typeof globalInvoiceDescription !== 'undefined') globalInvoiceDescription = '';
}

// Helper function to get value from either input or select
function getCellValue(cellElement) {
¬† const input = cellElement.querySelector(&#x27;input&#x27;);
¬† if (input) {
¬† ¬† return input.value;
¬† }
¬† const select = cellElement.querySelector(&#x27;select&#x27;);
¬† if (select) {
¬† ¬† return select.value;
¬† }
¬† return &#x27;&#x27;; // Return empty string if neither found (shouldn&#x27;t happen with current setup)
}

// Copy ‡πÅ‡∏ö‡∏ö Pipe (|)
function copyPipe() {
¬† const headerRow = document.querySelector(&#x27;#wht-table thead tr&#x27;);
¬† let headerText = &#x27;&#x27;;
¬† if (headerRow) {
¬† ¬† headerText = Array.from(headerRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;|&#x27;);
¬† }

¬† const rows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let bodyText = Array.from(rows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;|&#x27;)
¬† ).join(&#x27;\n&#x27;);

¬† let fullText = headerText + (headerText ? &#x27;\n&#x27; : &#x27;&#x27;) + bodyText;
¬† copyToClipboard(fullText, &quot;‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Pipe (|) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!&quot;);
}

// Copy ‡πÅ‡∏ö‡∏ö Concat (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô)
function copyConcat() {
¬† const headerRow = document.querySelector(&#x27;#wht-table thead tr&#x27;);
¬† let headerText = &#x27;&#x27;;
¬† if (headerRow) {
¬† ¬† headerText = Array.from(headerRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;&#x27;);
¬† }

¬† const rows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let bodyText = Array.from(rows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;&#x27;)
¬† ).join(&#x27;\n&#x27;);

¬† copyToClipboard(headerText + (headerText ? &#x27;\n&#x27; : &#x27;&#x27;) + bodyText, &quot;‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Concat ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!&quot;);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö copy
function copyToClipboard(txt, msg) {
¬† if (navigator.clipboard) {
¬† ¬† navigator.clipboard.writeText(txt).then(() =&gt; {
¬† ¬† ¬† alert(msg);
¬† ¬† }).catch(err =&gt; {
¬† ¬† ¬† console.error(&#x27;Could not copy text: &#x27;, err);
¬† ¬† ¬† alert(&#x27;‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ: &#x27; + err.message);
¬† ¬† });
¬† } else {
¬† ¬† // Fallback for older browsers
¬† ¬† let textarea = document.createElement(&quot;textarea&quot;);
¬† ¬† textarea.value = txt;
¬† ¬† textarea.style.position = &#x27;fixed&#x27;; // Prevent scrolling to bottom
¬† ¬† textarea.style.opacity = 0; // Hide the textarea
¬† ¬† document.body.appendChild(textarea);
¬† ¬† textarea.focus();
¬† ¬† textarea.select();
¬† ¬† try {
¬† ¬† ¬† document.execCommand(&quot;copy&quot;);
¬† ¬† ¬† alert(msg);
¬† ¬† } catch (err) {
¬† ¬† ¬† console.error(&#x27;Could not copy text: &#x27;, err);
¬† ¬† ¬† alert(&#x27;‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ: &#x27; + err.message);
¬† ¬† } finally {
¬† ¬† ¬† document.body.removeChild(textarea);
¬† ¬† }
¬† }
}


function exportTxt() {
¬† const headerRow = document.querySelector(&#x27;#wht-table thead tr&#x27;);
¬† let headerText = &#x27;&#x27;;
¬† if (headerRow) {
¬† ¬† headerText = Array.from(headerRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;&#x27;);
¬† }

¬† const rows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let bodyText = Array.from(rows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;&#x27;)
¬† ).join(&#x27;\n&#x27;);

¬† let fullText = headerText + (headerText ? &#x27;\n&#x27; : &#x27;&#x27;) + bodyText;

¬† // Generate the timestamp for the filename
¬† const now = new Date();
¬† const day = String(now.getDate()).padStart(2, &#x27;0&#x27;);
¬† const month = String(now.getMonth() + 1).padStart(2, &#x27;0&#x27;);
¬† const year = String(now.getFullYear());
¬† const hours = String(now.getHours()).padStart(2, &#x27;0&#x27;);
¬† const minutes = String(now.getMinutes()).padStart(2, &#x27;0&#x27;);
¬† const seconds = String(now.getSeconds()).padStart(2, &#x27;0&#x27;);

¬† const timestamp = `${day}${month}${year}_${hours}${minutes}${seconds}`;
¬† let filename = `Result_BBL_e-WHT`;

    // Append globalInvoiceDescription if it exists
    if (globalInvoiceDescription) {
        // Sanitize the description for use in a filename (remove special chars, replace spaces)
        const sanitizedDescription = globalInvoiceDescription.replace(/[^a-zA-Z0-9-]/g, &#x27;_&#x27;).replace(/ /g, &#x27;_&#x27;);
        filename += `_${sanitizedDescription}`;
    }

¬† filename += `_${timestamp}.txt`;

¬† // Create a Blob with the text content
¬† const blob = new Blob([fullText], { type: &#x27;text/plain;charset=utf-8&#x27; });

¬† // Create a temporary URL for the Blob
¬† const url = URL.createObjectURL(blob);

¬† // Create a temporary anchor element
¬† const a = document.createElement(&#x27;a&#x27;);
¬† a.href = url;
¬† a.download = filename;

¬† // Programmatically click the anchor to trigger the download
¬† document.body.appendChild(a);
¬† a.click();

¬† // Clean up: remove the anchor and revoke the URL
¬† document.body.removeChild(a);
¬† URL.revokeObjectURL(url);

¬† alert(&#x27;‡πÑ‡∏ü‡∏•‡πå .txt ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!&#x27;);
}
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;&lt;/html&gt;"></iframe>
    </div>
    
    <div id="wht-tool-2" class="tool-frame" style="display:none;">
      <iframe title="BBL Transfer / PromptPay" sandbox="allow-scripts allow-downloads allow-forms allow-modals allow-same-origin" srcdoc="&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;base target=&quot;_blank&quot;&gt;&lt;/head&gt;&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;th&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;title&gt;Claim Payment BBL Transfer / PromptPay&lt;/title&gt;
  &lt;style&gt;
    body { font-family: &#x27;Sarabun&#x27;, Arial, sans-serif; background: #f7f9fa; }
    .container { padding: 10px 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 14px; }
    th, td { border: 1px solid #c2c2c2; padding: 5px 6px; text-align: center; min-width: 110px; }
    th { background: #d3e6fd; color: #222; font-size: 1rem;}
    input[type=&quot;text&quot;] { width: 100px; padding: 3px 7px; border-radius: 4px; border: 1px solid #bbb;}
    .fix-cell input { background: #eaffea !important; }
    .readonly { background: #eaffea !important; color: #888; }
    .flex { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .btn { padding: 5px 16px; background: #7da7e8; border: none; color: #fff; border-radius: 4px; margin: 0 7px 10px 0; cursor: pointer; font-size: 1rem; }
    .btn:hover { background: #4a81c3;}
    .hidden { display: none; }
    #result { margin-top: 18px; font-size: 1.05em; background: #f9f9f9; border: 1px solid #eee; padding: 10px;}
    .scrollx { overflow-x: auto; }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container&quot;&gt;
  &lt;h2&gt;üè¶ BBL Transfer / PromptPay Export File&lt;/h2&gt;
  
  &lt;!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ --&gt;
  &lt;div style=&quot;background: #fff7d6; border: 1px solid #f2d76c; padding: 10px 14px; border-radius: 6px; color: #333; font-size: 1rem; margin-bottom: 15px;&quot;&gt;
  üìÑ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Format(.txt) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúImport‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúExport File‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    &lt;p&gt;üìå  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á TXN_STATUS (Paid ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ/ Return ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚ùå)&lt;/p&gt;
  &lt;/div&gt;

  &lt;!-- ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° --&gt;
  &lt;div class=&quot;flex&quot;&gt;
    &lt;input type=&quot;file&quot; id=&quot;importFile&quot; accept=&quot;.txt&quot;&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;importTxt()&quot;&gt;üì•Import&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;saveTable()&quot;&gt;üíæSave&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;clearTable()&quot;&gt;üßπClear&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;copyPipe()&quot;&gt;üìãCopy | (Pipe)&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;copyConcat()&quot;&gt;üìãCopy (Concat)&lt;/button&gt;
    &lt;button class=&quot;btn&quot; onclick=&quot;exportTxt()&quot;&gt;üóÇÔ∏èExport&lt;/button&gt;
  &lt;/div&gt;

  &lt;div class=&quot;scrollx&quot;&gt;
    &lt;table id=&quot;detail-table&quot;&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;FULL_NAME&lt;/th&gt;
          &lt;th&gt;CUSTOMER_CODE&lt;/th&gt;
          &lt;th&gt;CUSTOMER_ID&lt;/th&gt;
          &lt;th&gt;Currency Code&lt;/th&gt;
          &lt;th&gt;Total of Customer Amount&lt;/th&gt;
          &lt;th&gt;Payment Product Code&lt;/th&gt;
          &lt;th&gt;Total of Product&lt;/th&gt;
          &lt;th&gt;Product Description&lt;/th&gt;
          &lt;th&gt;TXN_ID&lt;/th&gt;
          &lt;th&gt;CURRENCY_CODE1&lt;/th&gt;
          &lt;th&gt;TXN_STATUS&lt;/th&gt;
          &lt;th&gt;PROCESSING_DATE&lt;/th&gt;
          &lt;th&gt;PAYMENT_VALUE_DATE&lt;/th&gt;
          &lt;th&gt;Instrument Ref.No.&lt;/th&gt;
          &lt;th&gt;Payable location&lt;/th&gt;
          &lt;th&gt;Liquidation Date&lt;/th&gt;
          &lt;th&gt;BANK_BRANCH_CODE&lt;/th&gt;
          &lt;th&gt;Credit Bank Code&lt;/th&gt;
          &lt;th&gt;Credit A/C No&lt;/th&gt;
          &lt;th&gt;Instrument No.&lt;/th&gt;
          &lt;th&gt;DEBIT_DATE&lt;/th&gt;
          &lt;th&gt;Short Account No.&lt;/th&gt;
          &lt;th&gt;Debit Amount&lt;/th&gt;
          &lt;th&gt;Debit Lcy Amount&lt;/th&gt;
          &lt;th&gt;Customer Ref. No.&lt;/th&gt;
          &lt;th&gt;Debit Acc. No.&lt;/th&gt;
          &lt;th&gt;Payee Code&lt;/th&gt;
          &lt;th&gt;Payee Name&lt;/th&gt;
          &lt;th&gt;CF_AGEING_DAYS&lt;/th&gt;
          &lt;th&gt;CF_CHG_CODE&lt;/th&gt;
          &lt;th&gt;CF_CHARGE_TO&lt;/th&gt;
          &lt;th&gt;BATCH_CODE&lt;/th&gt;
          &lt;th&gt;SUB_BATCH_CODE&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody id=&quot;tbody-table&quot;&gt;
        &lt;tr&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
		  &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
		  &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td&gt;&lt;input type=&quot;text&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;

  &lt;div class=&quot;scrollx&quot;&gt;
    &lt;table id=&quot;footer-table&quot;&gt;
      &lt;thead&gt;
        &lt;tr&gt;
          &lt;th&gt;CS_COUNT&lt;/th&gt;
          &lt;th&gt;Grand Total&lt;/th&gt;
          &lt;th&gt;PRECISION1&lt;/th&gt;
        &lt;/tr&gt;
      &lt;/thead&gt;
      &lt;tbody id=&quot;fbody-table&quot;&gt;
        &lt;tr&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
          &lt;td class=&quot;fix-cell&quot;&gt;&lt;input type=&quot;text&quot; readonly class=&quot;readonly&quot;&gt;&lt;/td&gt;
        &lt;/tr&gt;
      &lt;/tbody&gt;
    &lt;/table&gt;
  &lt;/div&gt;

  &lt;div id=&quot;result&quot; class=&quot;hidden&quot;&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
// Define FIELD_CONFIG for the main detail table
const mainTableFIELD_CONFIG = [
  // 1: FULL_NAME
  { type: &quot;fixed&quot;, value: &quot;OCEAN LIFE INSURANCE PUBLIC COMPANY LIMITED&quot; },
  // 2: CUSTOMER_CODE
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 1 },
  // 3: CUSTOMER_ID
  { type: &quot;fixed&quot;, value: &quot;5656&quot; },
  // 4: Currency Code
  { type: &quot;fixed&quot;, value: &quot;THB&quot; },
  // 5: Total of Customer Amount
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 33, decimal: 2 },
  // 6: Payment Product Code
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 3 },
  // 7: Total of Product
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 33, decimal: 2 },
  // 8: Product Description
  { type: &quot;fixed&quot;, value: &quot;SMART NEXT DAY&quot; },
  // 9: TXN_ID
  { type: &quot;fixed&quot;, value: &quot;900254&quot; },
  // 10: CURRENCY_CODE1
  { type: &quot;fixed&quot;, value: &quot;THB&quot; },
  // 11: TXN_STATUS
  { type: &quot;dropdown&quot;, options: [&quot;Paid&quot;, &quot;Return&quot;], defaultValue: &quot;Paid&quot; },
  // 12: PROCESSING_DATE
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 5, dateFormat: true },
  // 13: PAYMENT_VALUE_DATE
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 5, dateFormat: true },
  // 14: Instrument Ref.No.
  { // New type for concatenation
    type: &quot;from_line&quot;, fieldIdx: 8,
    prefix: &quot;00BOCEANIN1011553/&quot;
  },
  // 15: Payable location
  { type: &quot;fixed&quot;, value: &quot;BANGKOK&quot; },
  // 16: Liquidation Date
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 5, dateFormat: true },
  // 17: BANK_BRANCH_CODE
  { type: &quot;fixed&quot;, value: &quot;0020101&quot; },
  // 18: Credit Bank Code
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 37 },
  // 19: Credit A/C No
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 4 , stripPrefix: &quot;I&quot;},
  // 20: Instrument No.
  { type: &quot;fixed&quot;, value: &quot;&quot; }, // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á fix ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
  // 21: DEBIT_DATE
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 5, dateFormat: true },
  // 22: Short Account No.
  { type: &quot;fixed&quot;, value: &quot;123456&quot; },
  // 23: Debit Amount
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 33, decimal: 2 },
  // 24: Debit Lcy Amount
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 33, decimal: 2 },
  // 25: Customer Ref. No.
  { type: &quot;fixed&quot;, value: &quot;OCEANIN&quot; },
  // 26: Debit Acc. No.
  { type: &quot;fixed&quot;, value: &quot;9250025955&quot; },
  // 27: Payee Code
  { type: &quot;fixed&quot;, value: &quot;&quot; }, // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á fix ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
  // 28: Payee Name
  { type: &quot;from_line&quot;, startWith: &quot;003~&quot;, fieldIdx: 43 },
  // 29: CF_AGEING_DAYS
  { type: &quot;fixed&quot;, value: &quot;4&quot; },
  // 30: CF_CHG_CODE
  { type: &quot;fixed&quot;, value: &quot;1&quot; },
  // 31: CF_CHARGE_TO
  { type: &quot;fixed&quot;, value: &quot;OUR&quot; },
  // 32: BATCH_CODE
  { type: &quot;fixed&quot;, value: &quot;OCEANIN101169&quot; },
  // 33: SUB_BATCH_CODE
  { type: &quot;fixed&quot;, value: &quot;&quot; }, // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á fix ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
];

// Define FIELD_CONFIG for the footer table
const footerFIELD_CONFIG = [
  // 1: CS_COUNT &gt;&gt; footer
  { type: &quot;from_line&quot;, startWith: &quot;100~&quot;, fieldIdx: 1 },
  // 2: Grand Total &gt;&gt; footer
  { type: &quot;from_line&quot;, startWith: &quot;100~&quot;, fieldIdx: 2, decimal: 2 },
  // 3: PRECISION1 &gt;&gt; footer
  { type: &quot;from_line&quot;, startWith: &quot;100~&quot;, fieldIdx: 1 },
];



function importTxt() {
¬† const fileInput = document.getElementById(&#x27;importFile&#x27;);
¬† if (!fileInput.files[0]) return alert(&#x27;‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå&#x27;);
¬† const reader = new FileReader();
¬† reader.onload = function(e) {
¬† ¬† let text = e.target.result.replace(/\r/g, &#x27;&#x27;);
¬† ¬† const lines = text.split(&#x27;\n&#x27;).filter(x =&gt; x.trim() !== &quot;&quot;);

¬† ¬† // Separate Header, Detail, and Footer lines
¬† ¬† const headerLine = lines.find(line =&gt; line.startsWith(&quot;001~&quot;)) || &quot;&quot;; // Not used for data, but good to have
¬† ¬† const detailLines = lines.filter(line =&gt; line.startsWith(&quot;003~&quot;)); // Filter only 003~ for details
¬† ¬† const footerLine = lines.find(line =&gt; line.startsWith(&quot;100~&quot;)) || &quot;&quot;; // Find 100~ for footer

    // Capture the Payment Product Code from the first 003~ line
    if (detailLines.length &gt; 0) {
        const firstDetailLineFields = detailLines[0].split(&#x27;~&#x27;);
        if (firstDetailLineFields[3] !== undefined) {
            globalPaymentProductCode = firstDetailLineFields[3].trim();
        } else {
            globalPaymentProductCode = &#x27;&#x27;; // Clear if not found
        }
    } else {
        globalPaymentProductCode = &#x27;&#x27;; // Clear if no detail lines
    }

¬† ¬† // Process Detail Table
¬† ¬† const tbodyDetail = document.getElementById(&#x27;tbody-table&#x27;);
¬† ¬† tbodyDetail.innerHTML = &quot;&quot;; // Clear existing rows

¬† ¬† detailLines.forEach(line =&gt; { // Iterate through each 003~ line for the detail table
¬† ¬† ¬† const tr = document.createElement(&#x27;tr&#x27;);

¬† ¬† ¬† // Populate detail table rows using mainTableFIELD_CONFIG
¬† ¬† ¬† mainTableFIELD_CONFIG.forEach((conf, idx) =&gt; {
¬† ¬† ¬† ¬† const td = document.createElement(&#x27;td&#x27;);
¬† ¬† ¬† ¬† let val = &quot;&quot;;

¬† ¬† ¬† ¬† if (conf.type === &quot;dropdown&quot;) {
¬† ¬† ¬† ¬† ¬† const select = document.createElement(&#x27;select&#x27;);
¬† ¬† ¬† ¬† ¬† conf.options.forEach(optionText =&gt; {
¬† ¬† ¬† ¬† ¬† ¬† const option = document.createElement(&#x27;option&#x27;);
¬† ¬† ¬† ¬† ¬† ¬† option.value = optionText;
¬† ¬† ¬† ¬† ¬† ¬† option.textContent = optionText;
¬† ¬† ¬† ¬† ¬† ¬† select.appendChild(option);
¬† ¬† ¬† ¬† ¬† });
¬† ¬† ¬† ¬† ¬† select.value = conf.defaultValue;
¬† ¬† ¬† ¬† ¬† td.appendChild(select);
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† const input = document.createElement(&#x27;input&#x27;);
¬† ¬† ¬† ¬† ¬† input.type = &quot;text&quot;;

¬† ¬† ¬† ¬† ¬† if (conf.type === &quot;fixed&quot;) {
¬† ¬† ¬† ¬† ¬† ¬† val = conf.value;
¬† ¬† ¬† ¬† ¬† ¬† td.classList.add(&quot;fix-cell&quot;);
¬† ¬† ¬† ¬† ¬† ¬† input.classList.add(&quot;readonly&quot;);
¬† ¬† ¬† ¬† ¬† ¬† input.readOnly = true;
¬† ¬† ¬† ¬† ¬† } else if (conf.type === &quot;from_line&quot;) {
¬† ¬† ¬† ¬† ¬† ¬† if (line) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† const detailFields = line.split(&#x27;~&#x27;);
¬† ¬† ¬† ¬† ¬† ¬† ¬† val = detailFields[conf.fieldIdx] !== undefined ? detailFields[conf.fieldIdx].trim() : &quot;&quot;;

¬† ¬† ¬† ¬† ¬† ¬† ¬† // Apply stripPrefix if defined in the config
¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.stripPrefix &amp;&amp; val.startsWith(conf.stripPrefix)) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† val = val.slice(conf.stripPrefix.length);
¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.prefix &amp;&amp; !val.startsWith(conf.prefix)) val = conf.prefix + val;
¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.dateFormat) val = formatThaiDate(val);
¬† ¬† ¬† ¬† ¬† ¬† ¬† if (conf.decimal &amp;&amp; !isNaN(Number(val.replace(conf.prefix || &quot;&quot;, &quot;&quot;)))) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let num = Number(val.replace(conf.prefix || &quot;&quot;, &quot;&quot;));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!conf.noDivide) num = num / 100;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† val = num.toFixed(conf.decimal);
¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† input.value = val;
¬† ¬† ¬† ¬† ¬† td.appendChild(input);
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† tr.appendChild(td);
¬† ¬† ¬† });
¬† ¬† ¬† tbodyDetail.appendChild(tr);
¬† ¬† });

¬† ¬† // Process Footer Table (no changes needed here related to the request)
¬† ¬† const fbodyTable = document.getElementById(&#x27;fbody-table&#x27;);
¬† ¬† fbodyTable.innerHTML = &quot;&quot;; // Clear existing footer rows

¬† ¬† if (footerLine) {
¬† ¬† ¬† const footerFields = footerLine.split(&#x27;~&#x27;);
¬† ¬† ¬† const trFooter = document.createElement(&#x27;tr&#x27;);

¬† ¬† ¬† footerFIELD_CONFIG.forEach((conf, idx) =&gt; {
¬† ¬† ¬† ¬† const td = document.createElement(&#x27;td&#x27;);
¬† ¬† ¬† ¬† const input = document.createElement(&#x27;input&#x27;);
¬† ¬† ¬† ¬† input.type = &quot;text&quot;;
¬† ¬† ¬† ¬† input.readOnly = true;
¬† ¬† ¬† ¬† td.classList.add(&quot;fix-cell&quot;);
¬† ¬† ¬† ¬† input.classList.add(&quot;readonly&quot;);

¬† ¬† ¬† ¬† let val = &quot;&quot;;
¬† ¬† ¬† ¬† if (conf.type === &quot;from_line&quot;) {
¬† ¬† ¬† ¬† ¬† val = footerFields[conf.fieldIdx] !== undefined ? footerFields[conf.fieldIdx].trim() : &quot;&quot;;
¬† ¬† ¬† ¬† ¬† if (conf.decimal &amp;&amp; !isNaN(Number(val))) {
¬† ¬† ¬† ¬† ¬† ¬† let num = Number(val);
¬† ¬† ¬† ¬† ¬† ¬† if (!conf.noDivide) num = num / 100;
¬† ¬† ¬† ¬† ¬† ¬† val = num.toFixed(conf.decimal);
¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† input.value = val;
¬† ¬† ¬† ¬† td.appendChild(input);
¬† ¬† ¬† ¬† trFooter.appendChild(td);
¬† ¬† ¬† });
¬† ¬† ¬† fbodyTable.appendChild(trFooter);
¬† ¬† }
¬† };
¬† reader.readAsText(fileInput.files[0]);
}

function formatThaiDate(str) {
¬† str = str.replace(/^~/, &quot;&quot;);
¬† if (str.length !== 8) return str;
¬† const day = str.substring(0,2);
¬† const month = str.substring(2,4);
¬† const year = str.substring(6,8);
¬† const monthNames = [
¬† ¬† &#x27;&#x27;, &#x27;Jan&#x27;, &#x27;Feb&#x27;, &#x27;Mar&#x27;, &#x27;Apr&#x27;, &#x27;May&#x27;, &#x27;Jun&#x27;, &#x27;Jul&#x27;, &#x27;Aug&#x27;, &#x27;Sep&#x27;, &#x27;Oct&#x27;, &#x27;Nov&#x27;, &#x27;Dec&#x27;
¬† ];
¬† let mIdx = parseInt(month, 10);
¬† if (!mIdx || mIdx &gt; 12) return str;
¬† return day + &#x27;-&#x27; + monthNames[mIdx] + &#x27;-&#x27; + year;
}

function saveTable() {
¬† const rows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let arr = [];
¬† rows.forEach(tr =&gt; {
¬† ¬† let rowData = [];
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; rowData.push(getCellValue(td)));
¬† ¬† arr.push(rowData);
¬† });
¬† document.getElementById(&#x27;result&#x27;).classList.remove(&#x27;hidden&#x27;);
¬† document.getElementById(&#x27;result&#x27;).innerText = JSON.stringify(arr, null, 2);
}

function clearTable() {
  const tbody = document.getElementById('tbody-table');
  if (tbody) {
    tbody.querySelectorAll('input:not([readonly])').forEach(i => {
      if (i.type === 'checkbox' || i.type === 'radio') i.checked = false;
      else i.value = '';
    });
    tbody.querySelectorAll('select').forEach(sel => { sel.selectedIndex = 0; });
  }

  const fbody = document.getElementById('fbody-table');
  if (fbody) {
    fbody.querySelectorAll('input').forEach(i => { if (i.type === 'checkbox' || i.type === 'radio') i.checked = false; else i.value = ''; });
    fbody.querySelectorAll('select').forEach(sel => { sel.selectedIndex = 0; });
  }

  const fileInput = document.getElementById('importFile');
  if (fileInput) fileInput.value = '';

  const rs = document.getElementById('result');
  if (rs) { rs.classList.add('hidden'); rs.innerText = ''; }

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏î‡πâ‡∏ß‡∏¢ (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß/‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô window)
  if (typeof window !== 'undefined') {
    if (!('globalPaymentProductCode' in window)) window.globalPaymentProductCode = '';
    else window.globalPaymentProductCode = '';
  }
}

function getCellValue(cellElement) {
¬† const input = cellElement.querySelector(&#x27;input&#x27;);
¬† if (input) {
¬† ¬† return input.value;
¬† }
¬† const select = cellElement.querySelector(&#x27;select&#x27;);
¬† if (select) {
¬† ¬† return select.value;
¬† }
¬† return &#x27;&#x27;;
}

// Copy ‡πÅ‡∏ö‡∏ö Pipe (|)
function copyPipe() {
¬† const headerRow = document.querySelector(&#x27;#detail-table thead tr&#x27;); // Target detail table header
¬† let headerText = &#x27;&#x27;;
¬† if (headerRow) {
¬† ¬† headerText = Array.from(headerRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;|&#x27;);
¬† }

¬† const detailRows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let bodyText = Array.from(detailRows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;|&#x27;)
¬† ).join(&#x27;\n&#x27;);

¬† const footerHeaderRow = document.querySelector(&#x27;#footer-table thead tr&#x27;); // Get footer table header
¬† let footerHeaderText = &#x27;&#x27;;
¬† if (footerHeaderRow) {
¬† ¬† footerHeaderText = Array.from(footerHeaderRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;|&#x27;);
¬† }
¬†¬†
¬† const footerRows = document.querySelectorAll(&#x27;#fbody-table tr&#x27;);
¬† let footerText = Array.from(footerRows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;|&#x27;)
¬† ).join(&#x27;\n&#x27;);

¬† let fullText = headerText + (headerText ? &#x27;\n&#x27; : &#x27;&#x27;) + bodyText;
¬† if (footerHeaderText) { // Add footer header if it exists
¬† ¬† fullText += &#x27;\n&#x27; + footerHeaderText;
¬† }
¬† if (footerText) {
¬† ¬† fullText += &#x27;\n&#x27; + footerText;
¬† }
¬† copyToClipboard(fullText, &quot;‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Pipe (|) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!&quot;);
}

// Copy ‡πÅ‡∏ö‡∏ö Concat (‡πÉ‡∏ä‡πâ Tab ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô)
function copyConcat() {
¬† const headerRow = document.querySelector(&#x27;#detail-table thead tr&#x27;);
¬† let headerText = &#x27;&#x27;;
¬† if (headerRow) {
¬† ¬† headerText = Array.from(headerRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;\t&#x27;); // ‡πÉ‡∏ä‡πâ Tab
¬† }

¬† const detailRows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let bodyText = Array.from(detailRows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;\t&#x27;) // ‡πÉ‡∏ä‡πâ Tab
¬† ).join(&#x27;\n&#x27;);
¬†¬†
¬† const footerHeaderRow = document.querySelector(&#x27;#footer-table thead tr&#x27;); // Get footer table header
¬† let footerHeaderText = &#x27;&#x27;;
¬† if (footerHeaderRow) {
¬† ¬† footerHeaderText = Array.from(footerHeaderRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;\t&#x27;); // ‡πÉ‡∏ä‡πâ Tab
¬† }

¬† const footerRows = document.querySelectorAll(&#x27;#fbody-table tr&#x27;);
¬† let footerText = Array.from(footerRows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;\t&#x27;) // ‡πÉ‡∏ä‡πâ Tab
¬† ).join(&#x27;\n&#x27;);

¬† let fullText = headerText + (headerText ? &#x27;\n&#x27; : &#x27;&#x27;) + bodyText;
¬† if (footerHeaderText) { // Add footer header if it exists
¬† ¬† fullText += &#x27;\n&#x27; + footerHeaderText;
¬† }
¬† if (footerText) {
¬† ¬† fullText += &#x27;\n&#x27; + footerText;
¬† }
¬† copyToClipboard(fullText, &quot;‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Concat (Tab-separated) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!&quot;);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö copy
function copyToClipboard(txt, msg) {
¬† if (navigator.clipboard) {
¬† ¬† navigator.clipboard.writeText(txt).then(() =&gt; {
¬† ¬† ¬† alert(msg);
¬† ¬† }).catch(err =&gt; {
¬† ¬† ¬† console.error(&#x27;Could not copy text: &#x27;, err);
¬† ¬† ¬† alert(&#x27;‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ: &#x27; + err.message);
¬† ¬† });
¬† } else {
¬† ¬† // Fallback for older browsers
¬† ¬† let textarea = document.createElement(&quot;textarea&quot;);
¬† ¬† textarea.value = txt;
¬† ¬† textarea.style.position = &#x27;fixed&#x27;;
¬† ¬† textarea.style.opacity = 0;
¬† ¬† document.body.appendChild(textarea);
¬† ¬† textarea.focus();
¬† ¬† textarea.select();
¬† ¬† try {
¬† ¬† ¬† document.execCommand(&quot;copy&quot;);
¬† ¬† ¬† alert(msg);
¬† ¬† } catch (err) {
¬† ¬† ¬† console.error(&#x27;Could not copy text: &#x27;, err);
¬† ¬† ¬† alert(&#x27;‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ: &#x27; + err.message);
¬† ¬† } finally {
¬† ¬† ¬† document.body.removeChild(textarea);
¬† ¬† }
¬† }
}

// Export ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå .txt (‡πÉ‡∏ä‡πâ Tab ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏° footer)
function exportTxt() {
¬† const headerRow = document.querySelector(&#x27;#detail-table thead tr&#x27;);
¬† let headerText = &#x27;&#x27;;
¬† if (headerRow) {
¬† ¬† headerText = Array.from(headerRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;\t&#x27;); // ‡πÉ‡∏ä‡πâ Tab
¬† }

¬† const detailRows = document.querySelectorAll(&#x27;#tbody-table tr&#x27;);
¬† let bodyText = Array.from(detailRows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;\t&#x27;) // ‡πÉ‡∏ä‡πâ Tab
¬† ).join(&#x27;\n&#x27;);
¬†¬†
¬† const footerHeaderRow = document.querySelector(&#x27;#footer-table thead tr&#x27;); // Get footer table header
¬† let footerHeaderText = &#x27;&#x27;;
¬† if (footerHeaderRow) {
¬† ¬† footerHeaderText = Array.from(footerHeaderRow.querySelectorAll(&#x27;th&#x27;)).map(th =&gt; th.innerText).join(&#x27;\t&#x27;); // ‡πÉ‡∏ä‡πâ Tab
¬† }

¬† const footerRows = document.querySelectorAll(&#x27;#fbody-table tr&#x27;);
¬† let footerText = Array.from(footerRows).map(tr =&gt;
¬† ¬† Array.from(tr.querySelectorAll(&#x27;td&#x27;)).map(td =&gt; getCellValue(td)).join(&#x27;\t&#x27;) // ‡πÉ‡∏ä‡πâ Tab
¬† ).join(&#x27;\n&#x27;);

¬† let fullText = headerText + (headerText ? &#x27;\n&#x27; : &#x27;&#x27;) + bodyText;
¬† if (footerHeaderText) { // Add footer header if it exists
¬† ¬† fullText += &#x27;\n&#x27; + footerHeaderText;
¬† }
¬† if (footerText) {
¬† ¬† fullText += &#x27;\n&#x27; + footerText;
¬† }

¬† const now = new Date();
¬† const day = String(now.getDate()).padStart(2, &#x27;0&#x27;);
¬† const month = String(now.getMonth() + 1).padStart(2, &#x27;0&#x27;);
¬† const year = String(now.getFullYear());
¬† const hours = String(now.getHours()).padStart(2, &#x27;0&#x27;);
¬† const minutes = String(now.getMinutes()).padStart(2, &#x27;0&#x27;);
¬† const seconds = String(now.getSeconds()).padStart(2, &#x27;0&#x27;);

¬† const timestamp = `${day}${month}${year}_${hours}${minutes}${seconds}`;
¬† let filename = `Result_BBL`;

    // Append globalPaymentProductCode if it exists
    const __gppc = (typeof window !== 'undefined' && 'globalPaymentProductCode' in window) ? window.globalPaymentProductCode : ''; 
    if (__gppc) {
        // Sanitize the product code for use in a filename (remove special chars, replace spaces)
        const sanitizedProductCode = __gppc.replace(/[^a-zA-Z0-9-]/g, &#x27;_&#x27;).replace(/ /g, &#x27;_&#x27;);
        filename += `_${sanitizedProductCode}`;
    }

¬† filename += `_${timestamp}.txt`;

¬† const blob = new Blob([fullText], { type: &#x27;text/plain;charset=utf-8&#x27; });
¬† const url = URL.createObjectURL(blob);
¬† const a = document.createElement(&#x27;a&#x27;);
¬† a.href = url;
¬† a.download = filename;

¬† document.body.appendChild(a);
¬† a.click();
¬† document.body.removeChild(a);
¬† URL.revokeObjectURL(url);

¬† alert(&#x27;‡πÑ‡∏ü‡∏•‡πå .txt ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!&#x27;);
}
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;&lt;/html&gt;"></iframe>
    </div>
    
    <div id="wht-tool-3" class="tool-frame" style="display:none;">
      <iframe title="SCB Smart Credit DCP" sandbox="allow-scripts allow-downloads allow-forms allow-modals allow-same-origin" srcdoc="&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;base target=&quot;_blank&quot;&gt;&lt;/head&gt;&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;th&quot;&gt;
&lt;head&gt;
  &lt;title&gt;Claim Payment SCB Smart Credit DCP&lt;/title&gt;
&lt;style&gt;
  body { 
    font-family: &#x27;Sarabun&#x27;, Arial, sans-serif; 
    background: #f7f9fa; 
  }
  .container { 
    padding: 20px; 
  }
  .btn { 
    padding: 5px 16px; 
    background: #7da7e8; 
    border: none; 
    color: #fff; 
    border-radius: 4px; 
    margin-right: 10px; 
    cursor: pointer; 
    font-size: 1rem; 
  }
  .btn:hover { 
    background: #4a81c3; 
  }
  .controls {
    margin-bottom: 20px;
  }
  textarea { 
    width: 100%; 
    height: 300px; 
    white-space: pre; 
    font-family: monospace; 
    font-size: 0.95rem;
    padding: 10px;
    border: 1px solid #ccc; 
    border-radius: 5px;
    background-color: #fff;
    resize: vertical;
  }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container&quot;&gt;
  &lt;h2&gt;üèõÔ∏è SCB Smart Credit DCP Export File&lt;/h2&gt;
  
  &lt;!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ --&gt;
  &lt;div style=&quot;background: #fff7d6; border: 1px solid #f2d76c; padding: 10px 14px; border-radius: 6px; color: #333; font-size: 1rem; margin-bottom: 15px;&quot;&gt;
  üìÑ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Format(.txt) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúImport‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúExport File‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    &lt;p&gt;üìå  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ó‡∏µ‡πà Payment Status (Success(S) ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ/ Fail(F) ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚ùå)&lt;/p&gt;
  &lt;/div&gt;
  
  &lt;meta charset=&quot;windows-874&quot;&gt;
  
  &lt;!-- ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° --&gt;
  &lt;div class=&quot;flex&quot;&gt;
  &lt;input type=&quot;file&quot; id=&quot;inputFile&quot; accept=&quot;.txt&quot;&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;convertFile()&quot;&gt;üì•Import&lt;/button&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;clearOutput()&quot;&gt;üßπClear&lt;/button&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;copyOutput()&quot;&gt;üìãCopy Output&lt;/button&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;saveFile()&quot;&gt;üóÇÔ∏èExport&lt;/button&gt;
  &lt;br&gt;
  &lt;br&gt;  
  &lt;div class=&quot;flex&quot;&gt;
  &lt;label for=&quot;status&quot;&gt;Payment Status:&lt;/label&gt;
  &lt;select id=&quot;status&quot; style=&quot;padding: 5px; border-radius: 4px;&quot;&gt;
    &lt;option value=&quot;S&quot; selected&gt;Success (S)&lt;/option&gt;
    &lt;option value=&quot;F&quot;&gt;Fail  (F)&lt;/option&gt;
  &lt;/select&gt;
&lt;/div&gt;
  &lt;br&gt;
  &lt;textarea id=&quot;output&quot; readonly&gt;&lt;/textarea&gt;
 
  &lt;/div&gt;

¬† &lt;script&gt;
¬† ¬† // Declare a global variable to store fileRef
¬† ¬† let globalFileRef = &#x27;&#x27;;

¬† ¬† // Function to clear the output textarea
¬† ¬†function clearOutput() {
¬† ¬†document.getElementById(&#x27;output&#x27;).value = &#x27;&#x27;;
¬† ¬†globalFileRef = &#x27;&#x27;; // Clear fileRef when clearing output
¬† ¬†}
¬† ¬† // Reads the file content as text with specified encoding
¬† ¬† function readFileAsText(file, encoding = &#x27;windows-874&#x27;) {
¬† ¬† ¬† return new Promise((resolve, reject) =&gt; {
¬† ¬† ¬† ¬† const reader = new FileReader();
¬† ¬† ¬† ¬† reader.onload = () =&gt; resolve(reader.result);
¬† ¬† ¬† ¬† reader.onerror = reject;
¬† ¬† ¬† ¬† reader.readAsText(file, encoding);
¬† ¬† ¬† });
¬† ¬† }

¬† ¬† // Helper function to pad a string (right-aligned by default, or left-aligned with &#x27;0&#x27; for numbers)
¬† ¬† const pad = (value, length, char = &#x27; &#x27;, rightPad = true) =&gt; {
¬† ¬† ¬† let str = String(value || &#x27;&#x27;); // Ensure value is a string, handle null/undefined
¬† ¬† ¬† if (str.length &gt; length) {
¬† ¬† ¬† ¬† return str.substring(0, length);
¬† ¬† ¬† }
¬† ¬† ¬† if (rightPad) {
¬† ¬† ¬† ¬† return str.padEnd(length, char);
¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† return str.padStart(length, char);
¬† ¬† ¬† }
¬† ¬† };

¬† ¬† // Helper function to parse fixed-width string segments
¬† ¬† // IMPORTANT: &#x27;start&#x27; and &#x27;end&#x27; parameters should be 1-based column numbers
¬† ¬† // This function converts them to 0-based for JavaScript&#x27;s slice method.
¬† ¬† const parseFixed = (line, start, end) =&gt; {
¬† ¬† ¬† if (!line) return &#x27;&#x27;;
¬† ¬† ¬† // slice(startIndex, endIndex) extracts up to (but not including) endIndex.
¬† ¬† ¬† // So, for 1-based [start, end], it&#x27;s slice(start-1, end).
¬† ¬† ¬† return line.slice(start - 1, end).trim(); // .trim() removes leading/trailing spaces
¬† ¬† };

¬† ¬† async function convertFile() {
¬† ¬† ¬† const file = document.getElementById(&#x27;inputFile&#x27;).files[0];
¬† ¬† ¬† if (!file) {
¬† ¬† ¬† ¬† alert(&#x27;Please select a file first!!!&#x27;);
¬† ¬† ¬† ¬† return;
¬† ¬† ¬† }

¬† ¬† ¬† const raw = await readFileAsText(file);
¬† ¬† ¬† // Split by newline characters and filter out any empty lines.
¬† ¬† ¬† const lines = raw.split(/\r?\n/).filter(line =&gt; line.trim());

¬† ¬† ¬† let output = &#x27;&#x27;;

¬† ¬† ¬† // Objects/arrays to store parsed data from the input file
¬† ¬† ¬† let line001Data = {};
¬† ¬† ¬† let line002Data = {};
¬† ¬† ¬† let creditDetails = []; // Stores all 003 records
¬† ¬† ¬† let payeeDetails = {};¬† // Stores all 004 records, keyed by CreditSequenceNumber for easy lookup
¬† ¬† ¬† let line999Data = {};

¬† ¬† ¬† // --- First Pass: Parse all input lines and extract data ---
¬† ¬† ¬† // This loop iterates through each non-empty line of the input file
¬† ¬† ¬† for (const line of lines) {
¬† ¬† ¬† ¬† const recordType = line.substring(0, 3); // The first 3 characters define the record type

¬† ¬† ¬† ¬† if (recordType === &#x27;001&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 001 (Header) record
¬† ¬† ¬† ¬† ¬† line001Data = {
¬† ¬† ¬† ¬† ¬† ¬† companyId: parseFixed(line, 4, 15),
¬† ¬† ¬† ¬† ¬† ¬† fileRef: parseFixed(line, 16, 47),
¬† ¬† ¬† ¬† ¬† ¬† createdDate: parseFixed(line, 48, 55), // YYYYMMDD
¬† ¬† ¬† ¬† ¬† ¬† createdTime: parseFixed(line, 56, 61), // HHMMSS
¬† ¬† ¬† ¬† ¬† ¬† channelId: parseFixed(line, 62, 64),
¬† ¬† ¬† ¬† ¬† ¬† batchRef: parseFixed(line, 65, 96),
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† globalFileRef = line001Data.fileRef; // Store fileRef globally
¬† ¬† ¬† ¬† ¬† console.log(&#x27;Parsed 001:&#x27;, line001Data); // DEBUG: Log parsed 001 data to console
¬† ¬† ¬† ¬† } else if (recordType === &#x27;002&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 002 (Batch Header) record
¬† ¬† ¬† ¬† ¬† line002Data = {
¬† ¬† ¬† ¬† ¬† ¬† productCode: parseFixed(line, 4, 6),
¬† ¬† ¬† ¬† ¬† ¬† valueDate: parseFixed(line, 7, 14), // YYYYMMDD
¬† ¬† ¬† ¬† ¬† ¬† debitAccountNo: parseFixed(line, 15, 39),
¬† ¬† ¬† ¬† ¬† ¬† typeOfDebitAccount: parseFixed(line, 40, 41),
¬† ¬† ¬† ¬† ¬† ¬† debitBranchCode: parseFixed(line, 42, 45),
¬† ¬† ¬† ¬† ¬† ¬† debitCurrency: parseFixed(line, 46, 48),
¬† ¬† ¬† ¬† ¬† ¬† debitAmount: parseFixed(line, 49, 64),
¬† ¬† ¬† ¬† ¬† ¬† internalReference: parseFixed(line, 65, 72),
¬† ¬† ¬† ¬† ¬† ¬† noCredits: parseFixed(line, 73, 78),
¬† ¬† ¬† ¬† ¬† ¬† feeDebitAccount: parseFixed(line, 79, 93),
¬† ¬† ¬† ¬† ¬† ¬† filler: parseFixed(line, 94, 102),
¬† ¬† ¬† ¬† ¬† ¬† mediaClearingCycle: parseFixed(line, 103, 103),
¬† ¬† ¬† ¬† ¬† ¬† accountTypeFee: parseFixed(line, 104, 105),
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† console.log(&#x27;Parsed 002:&#x27;, line002Data); // DEBUG: Log parsed 002 data to console
¬† ¬† ¬† ¬† } else if (recordType === &#x27;003&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 003 (Credit Detail) record
¬† ¬† ¬† ¬† ¬† const detail = {
¬† ¬† ¬† ¬† ¬† ¬† creditSeqNumber: parseFixed(line, 4, 9),
¬† ¬† ¬† ¬† ¬† ¬† creditAccount: parseFixed(line, 10, 34),
¬† ¬† ¬† ¬† ¬† ¬† creditAmount: parseFixed(line, 35, 50),
¬† ¬† ¬† ¬† ¬† ¬† creditCurrency: parseFixed(line, 51, 53),
¬† ¬† ¬† ¬† ¬† ¬† internalReference003: parseFixed(line, 54, 61),
¬† ¬† ¬† ¬† ¬† ¬† whtPresent: parseFixed(line, 62, 62),
¬† ¬† ¬† ¬† ¬† ¬† invoiceDetailsPresent: parseFixed(line, 63, 63),
¬† ¬† ¬† ¬† ¬† ¬† creditAdviceRequired: parseFixed(line, 64, 64),
¬† ¬† ¬† ¬† ¬† ¬† deliveryMode: parseFixed(line, 65, 65),
¬† ¬† ¬† ¬† ¬† ¬† pickupLocation: parseFixed(line, 66, 69),
¬† ¬† ¬† ¬† ¬† ¬† whtFormType: parseFixed(line, 70, 71),
¬† ¬† ¬† ¬† ¬† ¬† whtTaxRunningNo: parseFixed(line, 72, 85),
¬† ¬† ¬† ¬† ¬† ¬† whtAttachNo: parseFixed(line, 86, 91),
¬† ¬† ¬† ¬† ¬† ¬† noofWhtDetails: parseFixed(line, 92, 93),
¬† ¬† ¬† ¬† ¬† ¬† totalWHTAmount: parseFixed(line, 94, 109),
¬† ¬† ¬† ¬† ¬† ¬† noofInvoiceDetails: parseFixed(line, 110, 115),
¬† ¬† ¬† ¬† ¬† ¬† totalInvoiceAmount: parseFixed(line, 116, 131),
¬† ¬† ¬† ¬† ¬† ¬† whtPayType: parseFixed(line, 132, 132),
¬† ¬† ¬† ¬† ¬† ¬† whtRemark: parseFixed(line, 133, 172),
¬† ¬† ¬† ¬† ¬† ¬† whtDeductDate: parseFixed(line, 173, 180),
¬† ¬† ¬† ¬† ¬† ¬† receivingBankCode: parseFixed(line, 181, 183),
¬† ¬† ¬† ¬† ¬† ¬† receivingBankName: parseFixed(line, 184, 218),
¬† ¬† ¬† ¬† ¬† ¬† receivingBranchCode: parseFixed(line, 219, 222),
¬† ¬† ¬† ¬† ¬† ¬† receivingBranchName: parseFixed(line, 223, 257),
¬† ¬† ¬† ¬† ¬† ¬† whtSignatory: parseFixed(line, 258, 258),
¬† ¬† ¬† ¬† ¬† ¬† beneficiaryNotification: parseFixed(line, 259, 259),
¬† ¬† ¬† ¬† ¬† ¬† customerReferenceNumber: parseFixed(line, 260, 279),
¬† ¬† ¬† ¬† ¬† ¬† chequeReferenceDocumentType: parseFixed(line, 280, 280),
¬† ¬† ¬† ¬† ¬† ¬† paymentTypeCode: parseFixed(line, 281, 283),
¬† ¬† ¬† ¬† ¬† ¬† servicesType: parseFixed(line, 284, 285),
¬† ¬† ¬† ¬† ¬† ¬† remark: parseFixed(line, 286, 335),
¬† ¬† ¬† ¬† ¬† ¬† scbRemark: parseFixed(line, 336, 353),
¬† ¬† ¬† ¬† ¬† ¬† beneficiaryCharge: parseFixed(line, 354, 355)
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† creditDetails.push(detail);
¬† ¬† ¬† ¬† ¬† // console.log(&#x27;Parsed 003:&#x27;, detail); // DEBUG: Can be very verbose if many 003 records
¬† ¬† ¬† ¬† } else if (recordType === &#x27;004&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 004 (Payee Detail) record
¬† ¬† ¬† ¬† ¬† const seq = parseFixed(line, 12, 17); // Credit Sequence Number is the key to link with 003 records
¬† ¬† ¬† ¬† ¬† const payee = {
¬† ¬† ¬† ¬† ¬† ¬† internalReference004: parseFixed(line, 4, 11),
¬† ¬† ¬† ¬† ¬† ¬† creditSequenceNumber: seq,
¬† ¬† ¬† ¬† ¬† ¬† payee1IDCard: parseFixed(line, 18, 32),
¬† ¬† ¬† ¬† ¬† ¬† payee1NameT: parseFixed(line, 33, 132),
¬† ¬† ¬† ¬† ¬† ¬† payee1Address1: parseFixed(line, 133, 202),
¬† ¬† ¬† ¬† ¬† ¬† payee1Address2: parseFixed(line, 203, 272),
¬† ¬† ¬† ¬† ¬† ¬† payee1Address3: parseFixed(line, 273, 342),
¬† ¬† ¬† ¬† ¬† ¬† payee1TaxID: parseFixed(line, 343, 352),
¬† ¬† ¬† ¬† ¬† ¬† payee1NameE: parseFixed(line, 353, 422),
¬† ¬† ¬† ¬† ¬† ¬† payee1FaxNumber: parseFixed(line, 423, 432),
¬† ¬† ¬† ¬† ¬† ¬† payee1MobilePhoneNumber: parseFixed(line, 433, 442),
¬† ¬† ¬† ¬† ¬† ¬† payee1EmailAddress: parseFixed(line, 443, 506),
¬† ¬† ¬† ¬† ¬† ¬† payee2NameT: parseFixed(line, 507, 606),
¬† ¬† ¬† ¬† ¬† ¬† payee2Address1: parseFixed(line, 607, 676),
¬† ¬† ¬† ¬† ¬† ¬† payee2Address2: parseFixed(line, 677, 746),
¬† ¬† ¬† ¬† ¬† ¬† payee2Address3: parseFixed(line, 747, 816)
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† payeeDetails[seq] = payee;
		¬† console.log(`Parsed 004 - Storing key: &#x27;${seq}&#x27;, Payee Name: &#x27;${payee.payee1NameT}&#x27;`);
		¬† console.log(&quot;Current payeeDetails object keys:&quot;, Object.keys(payeeDetails));

¬† ¬† ¬† ¬† ¬† // console.log(&#x27;Parsed 004:&#x27;, payee); // DEBUG: Can be verbose
¬† ¬† ¬† ¬† } else if (recordType === &#x27;999&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 999 (File Trailer) record
¬† ¬† ¬† ¬† ¬† line999Data = {
¬† ¬† ¬† ¬† ¬† ¬† totalOfDebits: parseFixed(line, 4, 9),
¬† ¬† ¬† ¬† ¬† ¬† totalOfCredits: parseFixed(line, 10, 15),
¬† ¬† ¬† ¬† ¬† ¬† totalAmountFooter: parseFixed(line, 16, 31),
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† console.log(&#x27;Parsed 999:&#x27;, line999Data); // DEBUG: Log parsed 999 data to console
¬† ¬† ¬† ¬† }
¬† ¬† ¬† }

¬† ¬† ¬† // --- Validation Check: Ensure essential header/footer data was successfully parsed ---
¬† ¬† ¬† // If any of these key fields are missing or empty, it indicates a parsing problem.
¬† ¬† ¬† if (!line001Data.createdDate || !line002Data.valueDate || !line999Data.totalOfCredits || !line001Data.fileRef) {
¬† ¬† ¬† ¬† ¬† alert(&#x27;Error: Data not found&#x27;);
¬† ¬† ¬† ¬† ¬† document.getElementById(&#x27;output&#x27;).value = &quot;Error: Missing essential header/footer data. Please check the browser&#x27;s console (F12) for detailed parsing logs.&quot;;
¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† }

¬† ¬† ¬† // --- Second Pass: Generate Output Records (500, 510, 599) ---

¬† ¬† ¬† // 500 Record: File Header
¬† ¬† ¬† // Based on your example: 50020250721132625C20250721001 CBZ2271 DCP S1 6997 20250721
¬† ¬† ¬† let line500 = &#x27;500&#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 3 chars: Record Type
¬† ¬† ¬† line500 += pad(line002Data.valueDate, 8);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 8 chars: Value Date (YYYYMMDD from 002)
¬† ¬† ¬† line500 += pad(line001Data.createdTime, 6);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 6 chars: Created Time (HHMMSS from 001)
¬† ¬† ¬† line500 += pad(line001Data.fileRef, 32);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 32 chars: File Reference (from 001). Will be right-padded if shorter.
¬† ¬† ¬† line500 += pad(line001Data.companyId, 12);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 12 chars: Company ID (from 001)
¬† ¬† ¬† line500 += pad(line002Data.productCode, 70);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Product Code (from 002) (e.g., &#x27;DCP&#x27;)
¬† ¬† ¬† line500 += pad(&#x27;S1&#x27;, 20);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 2 chars: Channel Id
¬† ¬† ¬† line500 += pad(line001Data.batchRef, 35);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 35 chars: Batch Reference (from 001)
¬† ¬† ¬† line500 += pad(line002Data.valueDate, 8);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 8 chars: Value Date (YYYYMMDD from 002)
¬† ¬† ¬† output += line500 + &#x27;\n&#x27;;
¬† ¬† ¬† console.log(&#x27;Generated 500:&#x27;, line500); // DEBUG: Log the fully constructed 500 record
¬† ¬† ¬† // Note: channelId from 001 parsing is 3 chars, but example shows &#x27;S1&#x27; (2 chars).
¬† ¬† ¬† // If your spec says 2, ensure 001 parsing aligns or pad to 2. Let&#x27;s pad to 2 based on example.
//¬† ¬† ¬† line500 += pad(line001Data.channelId, 2);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 2 chars: Channel ID (from 001) (e.g., &#x27;S1&#x27;)
//¬† ¬† ¬† line500 += &#x27; &#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 1 char: Fixed space
//¬† ¬† ¬† line500 += pad(line001Data.batchRef, 35);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 35 chars: Batch Reference (from 001)
//¬† ¬† ¬† line500 += pad(line002Data.valueDate, 8);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 8 chars: Value Date (from 002) - Appears duplicated in example format
//¬† ¬† ¬† output += line500 + &#x27;\n&#x27;;
//¬† ¬† ¬† console.log(&#x27;Generated 500:&#x27;, line500); // DEBUG: Log the fully constructed 500 record
//
¬† ¬† ¬† // 510 Records: Payment Results (Loop through each credit detail found in 003 records)
¬† ¬† ¬† // Example format: 510THB00000001914450009432424719 ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏ô‡∏±‡∏ô‡∏ó‡∏≤ ‡∏ô‡∏±‡∏ô‡∏ó‡πÇ‡∏ä‡∏ï‡∏¥ SIAM COMMERCIAL BANK PUBLIC COMPANY014PASSIONE RAYONG BRANCH 0815202507000005 SAPPROVED OR COMPLETED SUC 0000000191445000 202507000005 000000000000000
¬† ¬† ¬† for (const credit of creditDetails) {
¬† ¬† ¬† ¬† // Find the corresponding payee data (from 004 record) using credit sequence number as key
¬† ¬† ¬† ¬† const payee = payeeDetails[credit.creditSeqNumber] || {}; // Use empty object if no 004 found for this 003

¬† ¬† ¬† ¬† let line510 = &#x27;510&#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 3 chars: Record Type
¬† ¬† ¬† ¬† line510 += pad(credit.creditCurrency, 3);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Payment Currency (from 003)
¬† ¬† ¬† ¬† line510 += pad(credit.creditAmount, 16, &#x27;0&#x27;, false);¬† ¬† ¬† ¬† ¬†// 16 chars: Payment Amount (from 003), left-padded with zeros
¬† ¬† ¬† ¬† line510 += pad(credit.creditAccount, 25);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 25 chars: Beneficiary Account (from 003)
¬† ¬† ¬† ¬† line510 += pad(payee.payee1NameT, 70);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 70 chars: Beneficiary Name (from 004)
¬† ¬† ¬† ¬† line510 += pad(payee.payee1TaxID, 10);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 10 chars: Beneficiary Tax ID (from 004)
¬† ¬† ¬† ¬† line510 += pad(credit.receivingBankName, 35);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 35 chars: Beneficiary Bank Name (from 003)
¬† ¬† ¬† ¬† line510 += pad(credit.receivingBankCode, 3);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Beneficiary Bank Code (from 003)
¬† ¬† ¬† ¬† line510 += pad(credit.receivingBranchName, 35);¬† ¬† ¬† ¬† ¬† ¬† ¬†// 35 chars: Beneficiary Branch Name (from 003)
¬† ¬† ¬† ¬† line510 += pad(credit.receivingBranchCode, 4);¬† ¬† ¬† ¬† ¬† ¬† ¬†// 4 chars: Beneficiary Branch Code (from 003)
¬† ¬† ¬† ¬† // Bank Reference: Using CustomerReferenceNumber from 003 as it matches example&#x27;s position
¬† ¬† ¬† ¬† line510 += pad(credit.customerReferenceNumber, 16);¬† ¬† ¬† ¬† ¬†// 16 chars: Bank Reference (from 003)
¬† ¬† ¬† ¬† const status = document.getElementById(&#x27;status&#x27;).value;
¬† ¬† ¬† ¬† line510 += status;¬† // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å dropdown ‡πÅ‡∏ó‡∏ô &#x27;S&#x27;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 1 char: Processing Status (fixed to &#x27;S&#x27; for success)
¬† ¬† ¬† ¬† // Processing Remarks: Using the specific string from your example, padded to 124 chars
¬† ¬† ¬† ¬† line510 += pad(&#x27;APPROVED OR COMPLETED SUC&#x27;, 124);¬† ¬† ¬† ¬† ¬† ¬†// 124 chars: Processing Remarks (fixed string, right-padded)
¬† ¬† ¬† ¬† line510 += pad(credit.creditAmount, 16, &#x27;0&#x27;, false);¬† ¬† ¬† ¬† ¬†// 16 chars: Net Payment Amount (from 003), left-padded with zeros
¬† ¬† ¬† ¬† line510 += pad(&#x27;&#x27;, 7);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 7 chars: Cheque Number (empty, or parse if available in 003/004)
¬† ¬† ¬† ¬† line510 += pad(credit.customerReferenceNumber, 20);¬† ¬† ¬† ¬† ¬†// 20 chars: Customer Reference Number (from 003)
¬† ¬† ¬† ¬† line510 += pad(&#x27;&#x27;, 14);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 14 chars: WHT Serial Number (empty)
¬† ¬† ¬† ¬† line510 += pad(payee.payee1IDCard, 15);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 15 chars: Tax ID / ID Card (from 004)
¬† ¬† ¬† ¬† line510 += pad(&#x27;&#x27;, 8);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 8 chars: Cheque Number (empty, appears duplicated in example&#x27;s end)
¬† ¬† ¬† ¬† output += line510 + &#x27;\n&#x27;;
¬† ¬† ¬† ¬† console.log(&#x27;Generated 510:&#x27;, line510); // DEBUG: Can be verbose if many 510 records
¬† ¬† ¬† }

¬† ¬† ¬† // 599 Record: File Trailer
¬† ¬† ¬† // Example format: 59900000001000000001914450000
¬† ¬† ¬† let line599 = &#x27;599&#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 3 chars: Record Type
¬† ¬† ¬† // Total Transactions: using totalOfCredits from 999, left-padded with zeros to 8 chars
¬† ¬† ¬† line599 += pad(line999Data.totalOfCredits, 8, &#x27;0&#x27;, false);
¬† ¬† ¬† // Total Amount: using totalAmountFooter from 999, left-padded with zeros to 18 chars
¬† ¬† ¬† line599 += pad(line999Data.totalAmountFooter, 17, &#x27;0&#x27;,false);
	¬† line599 += pad(&#x27;0&#x27;, 1);¬†
¬† ¬† ¬† output += line599 + &#x27;\n&#x27;; // Add final newline
¬† ¬† ¬† console.log(&#x27;Generated 599:&#x27;, line599); // DEBUG: Log the fully constructed 599 record

¬† ¬† ¬† document.getElementById(&#x27;output&#x27;).value = output;
¬† ¬† }

¬† ¬† // Function to copy the output to clipboard
¬† ¬† function copyOutput() {
¬† ¬† ¬† const ta = document.getElementById(&#x27;output&#x27;);
¬† ¬† ¬† ta.select(); // Selects all text in the textarea
¬† ¬† ¬† document.execCommand(&#x27;copy&#x27;); // Copies the selected text to clipboard
¬† ¬† ¬† alert(&#x27;Successful&#x27;); // Notifies the user
¬† ¬† }

function getFormattedDateTime() {
¬† const now = new Date();
¬† const pad = (n) =&gt; n.toString().padStart(2, &#x27;0&#x27;);

¬† const dd = pad(now.getDate());
¬† const mm = pad(now.getMonth() + 1); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0
¬† const yyyy = now.getFullYear();
¬† const hh = pad(now.getHours());
¬† const min = pad(now.getMinutes());
¬† const ss = pad(now.getSeconds());

¬† return `${dd}${mm}${yyyy}_${hh}${min}${ss}`;
}

// Modified saveFile() function
function saveFile() {
¬† const outputText = document.getElementById(&#x27;output&#x27;).value;
¬† const blob = new Blob([outputText], { type: &#x27;text/plain;charset=windows-874&#x27; });

¬† const a = document.createElement(&#x27;a&#x27;);
¬† a.href = URL.createObjectURL(blob);

¬† // Construct filename including fileRef if available
¬† const dateTimeStr = getFormattedDateTime();
¬† let fileName = `Result_SCB_DCP`;
¬† if (globalFileRef) {
¬† ¬† fileName += `_${globalFileRef}`;
¬† }
¬† fileName += `_${dateTimeStr}.txt`;
¬† a.download = fileName;

¬† a.click();
¬† URL.revokeObjectURL(a.href);
}
¬† &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;&lt;/html&gt;"></iframe>
    </div>
    
    <div id="wht-tool-4" class="tool-frame" style="display:none;">
      <iframe title="SCB Smart Credit ORFT" sandbox="allow-scripts allow-downloads allow-forms allow-modals allow-same-origin" srcdoc="&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;base target=&quot;_blank&quot;&gt;&lt;/head&gt;&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;th&quot;&gt;
&lt;head&gt;
  &lt;title&gt;Claim Payment SCB Smart Credit ORFT&lt;/title&gt;
&lt;style&gt;
  body { 
    font-family: &#x27;Sarabun&#x27;, Arial, sans-serif; 
    background: #f7f9fa; 
  }
  .container { 
    padding: 20px; 
  }
  .btn { 
    padding: 5px 16px; 
    background: #7da7e8; 
    border: none; 
    color: #fff; 
    border-radius: 4px; 
    margin-right: 10px; 
    cursor: pointer; 
    font-size: 1rem; 
  }
  .btn:hover { 
    background: #4a81c3; 
  }
  .controls {
    margin-bottom: 20px;
  }
  textarea { 
    width: 100%; 
    height: 300px; 
    white-space: pre; 
    font-family: monospace; 
    font-size: 0.95rem;
    padding: 10px;
    border: 1px solid #ccc; 
    border-radius: 5px;
    background-color: #fff;
    resize: vertical;
  }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class=&quot;container&quot;&gt;
  &lt;h2&gt;üèõÔ∏è SCB Smart Credit ORFT Export File&lt;/h2&gt;
  
  &lt;!-- ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ --&gt;
  &lt;div style=&quot;background: #fff7d6; border: 1px solid #f2d76c; padding: 10px 14px; border-radius: 6px; color: #333; font-size: 1rem; margin-bottom: 15px;&quot;&gt;
  üìÑ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå Format(.txt) ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúImport‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° &lt;strong&gt;‚ÄúExport File‚Äù&lt;/strong&gt; ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    &lt;p&gt;üìå  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ‡∏ó‡∏µ‡πà Payment Status (Success(S) ‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ/ Fail(F) ‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‚ùå)&lt;/p&gt;
  &lt;/div&gt;
  
  &lt;meta charset=&quot;windows-874&quot;&gt;
  
  &lt;!-- ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° --&gt;
  &lt;div class=&quot;flex&quot;&gt;
  &lt;input type=&quot;file&quot; id=&quot;inputFile&quot; accept=&quot;.txt&quot;&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;convertFile()&quot;&gt;üì•Import&lt;/button&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;clearOutput()&quot;&gt;üßπClear&lt;/button&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;copyOutput()&quot;&gt;üìãCopy Output&lt;/button&gt;
  &lt;button class=&quot;btn&quot; onclick=&quot;saveFile()&quot;&gt;üóÇÔ∏èExport&lt;/button&gt;
  &lt;br&gt;
  &lt;br&gt;    
  &lt;div class=&quot;flex&quot;&gt;
  &lt;label for=&quot;status&quot;&gt;Payment Status:&lt;/label&gt;
  &lt;select id=&quot;status&quot; style=&quot;padding: 5px; border-radius: 4px;&quot;&gt;
    &lt;option value=&quot;S&quot; selected&gt;Success (S)&lt;/option&gt;
    &lt;option value=&quot;F&quot;&gt;Fail  (F)&lt;/option&gt;
  &lt;/select&gt;
&lt;/div&gt;
  &lt;br&gt;
  &lt;textarea id=&quot;output&quot; readonly&gt;&lt;/textarea&gt;
 
  &lt;/div&gt;


¬† &lt;script&gt;
    // Declare a global variable to store fileRef
    let globalFileRef = &#x27;&#x27;;
¬†¬†
¬† ¬† // Function to clear the output textarea
¬† ¬†function clearOutput() {
¬† ¬†document.getElementById(&#x27;output&#x27;).value = &#x27;&#x27;;
    globalFileRef = &#x27;&#x27;; // Clear fileRef when clearing output
¬† ¬†}
¬† ¬† // Reads the file content as text with specified encoding
¬† ¬† function readFileAsText(file, encoding = &#x27;windows-874&#x27;) {
¬† ¬† ¬† return new Promise((resolve, reject) =&gt; {
¬† ¬† ¬† ¬† const reader = new FileReader();
¬† ¬† ¬† ¬† reader.onload = () =&gt; resolve(reader.result);
¬† ¬† ¬† ¬† reader.onerror = reject;
¬† ¬† ¬† ¬† reader.readAsText(file, encoding);
¬† ¬† ¬† });
¬† ¬† }

¬† ¬† // Helper function to pad a string (right-aligned by default, or left-aligned with &#x27;0&#x27; for numbers)
¬† ¬† const pad = (value, length, char = &#x27; &#x27;, rightPad = true) =&gt; {
¬† ¬† ¬† let str = String(value || &#x27;&#x27;); // Ensure value is a string, handle null/undefined
¬† ¬† ¬† if (str.length &gt; length) {
¬† ¬† ¬† ¬† return str.substring(0, length);
¬† ¬† ¬† }
¬† ¬† ¬† if (rightPad) {
¬† ¬† ¬† ¬† return str.padEnd(length, char);
¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† return str.padStart(length, char);
¬† ¬† ¬† }
¬† ¬† };

¬† ¬† // Helper function to parse fixed-width string segments
¬† ¬† // IMPORTANT: &#x27;start&#x27; and &#x27;end&#x27; parameters should be 1-based column numbers
¬† ¬† // This function converts them to 0-based for JavaScript&#x27;s slice method.
¬† ¬† const parseFixed = (line, start, end) =&gt; {
¬† ¬† ¬† if (!line) return &#x27;&#x27;;
¬† ¬† ¬† // slice(startIndex, endIndex) extracts up to (but not including) endIndex.
¬† ¬† ¬† // So, for 1-based [start, end], it&#x27;s slice(start-1, end).
¬† ¬† ¬† return line.slice(start - 1, end).trim(); // .trim() removes leading/trailing spaces
¬† ¬† };

¬† ¬† async function convertFile() {
¬† ¬† ¬† const file = document.getElementById(&#x27;inputFile&#x27;).files[0];
¬† ¬† ¬† if (!file) {
¬† ¬† ¬† ¬† alert(&#x27;Please select a file first!!!&#x27;);
¬† ¬† ¬† ¬† return;
¬† ¬† ¬† }

¬† ¬† ¬† const raw = await readFileAsText(file);
¬† ¬† ¬† // Split by newline characters and filter out any empty lines.
¬† ¬† ¬† const lines = raw.split(/\r?\n/).filter(line =&gt; line.trim());

¬† ¬† ¬† let output = &#x27;&#x27;;

¬† ¬† ¬† // Objects/arrays to store parsed data from the input file
¬† ¬† ¬† let line001Data = {};
¬† ¬† ¬† let line002Data = {};
¬† ¬† ¬† let creditDetails = []; // Stores all 003 records
¬† ¬† ¬† //let payeeDetails = {};¬† // Stores all 004 records, keyed by CreditSequenceNumber for easy lookup
¬† ¬† ¬† let line999Data = {};

¬† ¬† ¬† // --- First Pass: Parse all input lines and extract data ---
¬† ¬† ¬† // This loop iterates through each non-empty line of the input file
¬† ¬† ¬† for (const line of lines) {
¬† ¬† ¬† ¬† const recordType = line.substring(0, 3); // The first 3 characters define the record type

¬† ¬† ¬† ¬† if (recordType === &#x27;001&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 001 (Header) record
¬† ¬† ¬† ¬† ¬† line001Data = {
¬† ¬† ¬† ¬† ¬† ¬† companyId: parseFixed(line, 4, 15),
¬† ¬† ¬† ¬† ¬† ¬† fileRef: parseFixed(line, 16, 47),
¬† ¬† ¬† ¬† ¬† ¬† createdDate: parseFixed(line, 48, 55), // YYYYMMDD
¬† ¬† ¬† ¬† ¬† ¬† createdTime: parseFixed(line, 56, 61), // HHMMSS
¬† ¬† ¬† ¬† ¬† ¬† channelId: parseFixed(line, 62, 64),
¬† ¬† ¬† ¬† ¬† };
            globalFileRef = line001Data.fileRef; // Store fileRef globally
¬† ¬† ¬† ¬† ¬† console.log(&#x27;Parsed 001:&#x27;, line001Data); // DEBUG: Log parsed 001 data to console
¬† ¬† ¬† ¬† } else if (recordType === &#x27;002&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 002 (Batch Header) record
¬† ¬† ¬† ¬† ¬† line002Data = {
¬† ¬† ¬† ¬† ¬† ¬† productCode: parseFixed(line, 4, 6),
¬† ¬† ¬† ¬† ¬† ¬† valueDate: parseFixed(line, 7, 14), // YYYYMMDD
¬† ¬† ¬† ¬† ¬† ¬† TaxID: parseFixed(line, 15, 27),			
¬† ¬† ¬† ¬† ¬† ¬† debitAccountNo: parseFixed(line, 28, 52),
¬† ¬† ¬† ¬† ¬† ¬† typeOfDebitAccount: parseFixed(line, 53, 54),
¬† ¬† ¬† ¬† ¬† ¬† debitBranchCode: parseFixed(line, 55, 58),
¬† ¬† ¬† ¬† ¬† ¬† debitCurrency: parseFixed(line, 59, 61),
¬† ¬† ¬† ¬† ¬† ¬† debitAmount: parseFixed(line, 62, 77),
¬† ¬† ¬† ¬† ¬† ¬† internalReference: parseFixed(line, 78,	85),
¬† ¬† ¬† ¬† ¬† ¬† noCredits: parseFixed(line, 86,	91),
¬† ¬† ¬† ¬† ¬† ¬† feeDebitAccount: parseFixed(line, 92, 106),
¬† ¬† ¬† ¬† ¬† ¬† AccountTypeFee: parseFixed(line, 107, 108),
¬† ¬† ¬† ¬† ¬† ¬† DebitBranchCode: parseFixed(line, 109, 112),
¬† ¬† ¬† ¬† ¬† ¬† TransactionRef: parseFixed(line, 113, 144),
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† console.log(&#x27;Parsed 002:&#x27;, line002Data); // DEBUG: Log parsed 002 data to console
¬† ¬† ¬† ¬† } else if (recordType === &#x27;003&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 003 (Credit Detail) record
¬† ¬† ¬† ¬† ¬† const detail = {
¬† ¬† ¬† ¬† ¬† ¬† creditSeqNumber: parseFixed(line, 4, 9),
¬† ¬† ¬† ¬† ¬† ¬† creditAccount: parseFixed(line, 10, 34),
			BeneficiaryName: parseFixed(line, 35, 104),
¬† ¬† ¬† ¬† ¬† ¬† creditAmount: parseFixed(line, 105, 120),
¬† ¬† ¬† ¬† ¬† ¬† creditCurrency: parseFixed(line, 121, 123),
¬† ¬† ¬† ¬† ¬† ¬† ReceivingBankName: parseFixed(line, 124, 158),
¬† ¬† ¬† ¬† ¬† ¬† ReceivingBankCode: parseFixed(line, 159, 162),
¬† ¬† ¬† ¬† ¬† ¬† CIDID: parseFixed(line, 163, 175),
¬† ¬† ¬† ¬† ¬† ¬† MobileNo: parseFixed(line, 176,	185),
¬† ¬† ¬† ¬† ¬† ¬† InternalReference: parseFixed(line, 186, 193),
¬† ¬† ¬† ¬† ¬† ¬† TransactionRemark: parseFixed(line, 194, 225),
¬† ¬† ¬† ¬† ¬† ¬† ProxyType: parseFixed(line, 226, 228),
¬† ¬† ¬† ¬† ¬† ¬† Filler: parseFixed(line, 229, 274),
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† creditDetails.push(detail);
¬† ¬† ¬† ¬† ¬† // console.log(&#x27;Parsed 003:&#x27;, detail); // DEBUG: Can be very verbose if many 003 records
¬† ¬† ¬† ¬† } else if (recordType === &#x27;999&#x27;) {
¬† ¬† ¬† ¬† ¬† // Parse fields specific to the 999 (File Trailer) record
¬† ¬† ¬† ¬† ¬† line999Data = {
¬† ¬† ¬† ¬† ¬† ¬† totalOfDebits: parseFixed(line, 4, 9),
¬† ¬† ¬† ¬† ¬† ¬† totalOfCredits: parseFixed(line, 10, 15),
¬† ¬† ¬† ¬† ¬† ¬† totalAmountFooter: parseFixed(line, 16, 31),
¬† ¬† ¬† ¬† ¬† };
¬† ¬† ¬† ¬† ¬† console.log(&#x27;Parsed 999:&#x27;, line999Data); // DEBUG: Log parsed 999 data to console
¬† ¬† ¬† ¬† }
¬† ¬† ¬† }

¬† ¬† ¬† // --- Validation Check: Ensure essential header/footer data was successfully parsed ---
¬† ¬† ¬† // If any of these key fields are missing or empty, it indicates a parsing problem.
¬† ¬† ¬† if (!line001Data.createdDate || !line002Data.valueDate || !line999Data.totalOfCredits || !line001Data.fileRef) {
¬† ¬† ¬† ¬† ¬† alert(&#x27;Error: Data not found&#x27;);
¬† ¬† ¬† ¬† ¬† document.getElementById(&#x27;output&#x27;).value = &quot;Error: Missing essential header/footer data. Please check the browser&#x27;s console (F12) for detailed parsing logs.&quot;;
¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† }

¬† ¬† ¬† // --- Second Pass: Generate Output Records (500, 510, 599) ---

¬† ¬† ¬† // 500 Record: File Header
¬† ¬† ¬† // Based on your example: 50020250721132625C20250721001 CBZ2271 DCP S1 6997 20250721
¬† ¬† ¬† let line500 = &#x27;500&#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 3 chars: Record Type
¬† ¬† ¬† line500 += pad(line002Data.valueDate, 8);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 8 chars: Value Date (YYYYMMDD from 002)
¬† ¬† ¬† line500 += pad(line001Data.createdTime, 6);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 6 chars: Created Time (HHMMSS from 001)
¬† ¬† ¬† line500 += pad(line001Data.fileRef, 32);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 32 chars: File Reference (from 001). Will be right-padded if shorter.
¬† ¬† ¬† line500 += pad(line001Data.companyId, 12);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 12 chars: Company ID (from 001)
¬† ¬† ¬† line500 += pad(line002Data.productCode, 70);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Product Code (from 002) (e.g., &#x27;DCP&#x27;)
¬† ¬† ¬† line500 += pad(&#x27;S1&#x27;, 20);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 2 chars: Channel Id
¬† ¬† ¬† line500 += pad(line002Data.TransactionRef, 35);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 35 chars: Batch Reference (from 001)
¬† ¬† ¬† line500 += pad(line002Data.valueDate, 8);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 8 chars: Value Date (YYYYMMDD from 002)
¬† ¬† ¬† output += line500 + &#x27;\n&#x27;;
¬† ¬† ¬† console.log(&#x27;Generated 500:&#x27;, line500); // DEBUG: Log the fully constructed 500 record
¬† ¬† ¬† // Note: channelId from 001 parsing is 3 chars, but example shows &#x27;S1&#x27; (2 chars).

¬† ¬† // 510 Records: Payment Results (Loop through each credit detail found in 003 records)
¬† ¬† const paymentStatus = document.getElementById(&#x27;status&#x27;).value; // Get selected status

¬† ¬† for (const credit of creditDetails) {
¬† ¬† ¬† let line510 = &#x27;510&#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Record Type
¬† ¬† ¬† line510 += pad(credit.creditCurrency, 3);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 3 chars: Payment Currency (from 003)
¬† ¬† ¬† line510 += pad(credit.creditAmount, 16, &#x27;0&#x27;, false);¬† ¬† ¬† // 16 chars: Payment Amount (from 003), left-padded with zeros
¬† ¬† ¬† line510 += pad(credit.creditAccount, 25);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 25 chars: Beneficiary Account (from 003)
¬† ¬† ¬† line510 += pad(credit.BeneficiaryName, 70);¬† ¬† ¬† ¬† ¬† ¬† ¬† // 70 chars: Beneficiary Name (from 003)
¬† ¬† ¬† line510 += pad(credit.BeneficiaryName, 70);¬† ¬† ¬† ¬† ¬† ¬† ¬† // 70 chars: Beneficiary Name (from 003)
¬† ¬† ¬† line510 += pad(credit.ReceivingBankName, 35);¬† ¬† ¬† ¬† ¬† ¬† // 35 chars: Beneficiary Bank Name (from 003)
¬† ¬† ¬† line510 += pad(credit.ReceivingBankCode, 3);¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Beneficiary Bank Code (from 003)
¬† ¬† ¬† line510 += pad(credit.ProxyType, 3);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Proxy Type (from 003)
¬† ¬† ¬† line510 += pad(credit.CIDID, 13);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 13 chars: CID ID (from 003)
¬† ¬† ¬† line510 += pad(credit.MobileNo, 10);¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 10 chars: Mobile No (from 003)
¬† ¬† ¬† line510 += pad(credit.TransactionRemark, 32);¬† ¬† ¬† ¬† ¬† ¬† // 32 chars: Transaction Remark (from 003)
¬† ¬† ¬† line510 += paymentStatus;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // 1 char: Processing Status (from dropdown)
¬† ¬† ¬† line510 += pad(&#x27;APPROVED OR COMPLETED SUC&#x27;, 100);¬† ¬† ¬† ¬† ¬†// 100 chars: Processing Remarks (fixed string, right-padded)
¬† ¬† ¬† output += line510 + &#x27;\n&#x27;;
¬† ¬† ¬† console.log(&#x27;Generated 510:&#x27;, line510);
¬† ¬† }

¬† ¬† // 599 Record: File Trailer
¬† ¬† let line599 = &#x27;599&#x27;;¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// 3 chars: Record Type
¬† ¬† // Total Transactions: using totalOfCredits from 999, left-padded with zeros to 8 chars
¬† ¬† line599 += pad(line999Data.totalOfCredits, 8, &#x27;0&#x27;, false);
¬† ¬† // Total Amount: using totalAmountFooter from 999, left-padded with zeros to 16 chars
¬† ¬† line599 += pad(line999Data.totalAmountFooter, 16, &#x27;0&#x27;,false);
¬† ¬† output += line599 + &#x27;\n&#x27;; // Add final newline
¬† ¬† console.log(&#x27;Generated 599:&#x27;, line599);

¬† ¬† document.getElementById(&#x27;output&#x27;).value = output;
¬† }

¬† ¬† // Function to copy the output to clipboard
¬† ¬† function copyOutput() {
¬† ¬† ¬† const ta = document.getElementById(&#x27;output&#x27;);
¬† ¬† ¬† ta.select(); // Selects all text in the textarea
¬† ¬† ¬† document.execCommand(&#x27;copy&#x27;); // Copies the selected text to clipboard
¬† ¬† ¬† alert(&#x27;Successful&#x27;); // Notifies the user
¬† ¬† }

function getFormattedDateTime() {
¬† const now = new Date();
¬† const pad = (n) =&gt; n.toString().padStart(2, &#x27;0&#x27;);

¬† const dd = pad(now.getDate());
¬† const mm = pad(now.getMonth() + 1); // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0
¬† const yyyy = now.getFullYear();
¬† const hh = pad(now.getHours());
¬† const min = pad(now.getMinutes());
¬† const ss = pad(now.getSeconds());

¬† return `${dd}${mm}${yyyy}_${hh}${min}${ss}`;
}

// Modified saveFile() function
function saveFile() {
¬† const outputText = document.getElementById(&#x27;output&#x27;).value;
¬† const blob = new Blob([outputText], { type: &#x27;text/plain;charset=windows-874&#x27; });

¬† const a = document.createElement(&#x27;a&#x27;);
¬† a.href = URL.createObjectURL(blob);

¬† // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞ fileRef
¬† const dateTimeStr = getFormattedDateTime();
¬† let fileName = `Result_SCB_ORFT`;
¬† if (globalFileRef) {
¬† ¬† fileName += `_${globalFileRef}`;
¬† }
¬† fileName += `_${dateTimeStr}.txt`;
¬† a.download = fileName;

¬† a.click();
¬† URL.revokeObjectURL(a.href);
}
¬† &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
&lt;/html&gt;"></iframe>
    </div>
      </div>
    </div>
  </div>
  

  <script>
    const picker = document.getElementById('wht-picker');
    const openBtn = document.getElementById('wht-open');
    const resetBtn = document.getElementById('wht-reset');
    const frames = Array.from(document.querySelectorAll('#claimpay_wht .tool-frame'));

    function resetFrame(frameDiv) {
      const oldIframe = frameDiv.querySelector('iframe');
      if (!oldIframe) return;
      const fresh = oldIframe.cloneNode(true);   // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î state ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      frameDiv.innerHTML = '';
      frameDiv.appendChild(fresh);
    }

    function showTool(id, doReset = true) {
      frames.forEach(div => {
        const active = (div.id === id);
        div.style.display = active ? '' : 'none';
        if (active && doReset) resetFrame(div);
      });
    }

    picker.addEventListener('change', e => showTool(e.target.value, true));
    resetBtn.addEventListener('click', () => {
      const div = document.getElementById(picker.value);
      if (div) resetFrame(div);
    });
    openBtn.addEventListener('click', () => {
      const iframe = document.querySelector('#' + picker.value + ' iframe');
      if (!iframe) return;
      const html = iframe.srcdoc || '<!doctype html><title>Empty</title>';
      const url = URL.createObjectURL(new Blob([html], { type: 'text/html;charset=utf-8' }));
      window.open(url, '_blank');
    });

    window.addEventListener('DOMContentLoaded', () => {
      if (!picker.value) picker.value = picker.options[0].value;
      showTool(picker.value, true);
    });
  </script>
</div>
</div>

	
<div id="SPLife_Gen_TextFile" class="card-content">
  <div class="card">
    <h2>üìù Generator Text File - SP-Life</h2>	
	<div class="picker">
  <label for="templatePicker"><b>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°:</b></label>
  
  <select id="templatePicker" style="width: 320px; height: 36px; padding: 4px 10px; border-radius: 8px; margin-right:.5rem;">
    <option value="cbsplife" selected>Counter Bank (CBSPLIFE)</option>
    <option value="ol52">Direct Debit (OL52_MLTA)</option>
    <option value="ol55">Direct Debit (OL55_MRTA)</option>
  </select>
</div>

    

<!-- ======================= CBSPLIFE (FIXED) ======================= -->
<section id="app_cbsplife" class="app-section">
  <h2>üìÑ Generator Text File - Counter Bank For SP-Life</h2>

  <style>
  /* ===== OL55 header layout ===== */
  #cbsplife-header{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    column-gap:24px;      /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° */
    row-gap:16px;         /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
  }
  #cbsplife-header .pair{
    display:flex;
    align-items:center;
    gap:12px;             /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á label ‡∏Å‡∏±‡∏ö control */
  }
  #cbsplife-header .pair label{ font-weight:600; }

  /* ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏ß‡∏≤‡∏¢‡∏∑‡∏î‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Account ‡∏¢‡∏≤‡∏ß */
  #cbsplife-header .grow{ flex:1 1 520px; }

  /* ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß */
  #cbsplife-header .full{ flex:1 0 100%; }

  /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ó‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  #cbsplife-header select,
  #cbsplife-header input[type="text"],
  #cbsplife-header input[type="date"]{
    height:36px;
    padding:4px 10px;
    border-radius:8px;
  }
 
  #txnDate_CBSPLIFE{ width:160px; }

  /* ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å: ‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
  @media (max-width: 900px){
    #cbsplife-header .pair{ flex:1 0 100%; }
  }
  #outputArea_CBSPLIFE{
    width: 100%;
    height: clamp(100px, 45vh, 100px); /* ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô + responsive */
    min-height: 80px;
    padding: 12px;
    border-radius: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;      /* ‡∏•‡∏≤‡∏Å‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    box-sizing: border-box;
  }
</style>


  <!-- Header -->
  <div id="cbsplife-header">
  <div class="pair">
    <label for="payType_CBSPLIFE">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞:</label>
    <select id="payType_CBSPLIFE">
      <option value="OL11">MRTA = OL11</option>
      <option value="OL01" selected>MLTA = OL01</option>
    </select>
  </div>

  <div class="pair">
    <label for="txnDate_CBSPLIFE">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
    <input type="date" id="txnDate_CBSPLIFE">
  </div>
</div>


  <div class="hint">
    * ‡∏ñ‡πâ‡∏≤ Customer Name ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô ANSI (TIS-620)
  </div>

  <!-- Table -->
  <table id="detailTable_CBSPLIFE">
    <thead>
      <tr>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ <br><span class="tiny">(DDMMYYYY)</span></th>
        <th>Customer Name</th>
        <th>Ref.1.<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠)</span></th>
        <th>Ref.2 <br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)</span></th>
        <th>Branch Code<br><span class="tiny">(‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤)</span></th>
        <th>Amount (THB)<br><span class="tiny">(‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô)</span></th>
        <th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="toolbar">
    <button onclick="CBSPLIFE.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    <button onclick="CBSPLIFE.clearRows()">üßπ Clear</button>
    <button onclick="CBSPLIFE.generateText()">üìÑ Generate</button>
    <button onclick="CBSPLIFE.copyOutput()">üìã Copy</button>
    <button onclick="CBSPLIFE.downloadTxt()">üíæ Export</button>
  </div>

  <h3>üì¶ Text Output</h3>
  <textarea id="outputArea_CBSPLIFE" readonly></textarea>
</section>

<!-- ======================= OL52 ======================= -->
<section id="app_ol52" class="app-section">
  <h2>üìÑ Generator Text File - Direct Debit For OL52_MLTA SP-Life (BAAC 034)</h2>
<style>
  /* ===== OL52 header layout ===== */
  #ol52-header{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    column-gap:24px;         /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
    row-gap:16px;            /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
  }
  #ol52-header .pair{
    display:flex;
    align-items:center;
    gap:12px;                /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á label ‡∏Å‡∏±‡∏ö control */
  }
  #ol52-header .pair label{ font-weight:600; }

  /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Account ‡∏¢‡∏≤‡∏ß‡∏ï‡∏≤‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
  #ol52-header .pair.grow{ flex:1 1 520px; }

  /* ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß */
  #ol52-header .pair.full{ flex:1 0 100%; }

  /* ‡∏Ç‡∏ô‡∏≤‡∏î control */
  #ol52-header select,
  #ol52-header input[type="text"],
  #ol52-header input[type="date"]{
    height:36px;
    padding:4px 10px;
    border-radius:8px;
  }
  #ol52-header #compCode_SPLIFEOL52{ width:250px; }
  #ol52-header #companyAcc_SPLIFEOL52{ width:180px; max-width:100%; }
  #ol52-header #txnDate_SPLIFEOL52{ width:160px; }

  /* ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å: ‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏π‡πà‡∏•‡∏á‡∏Ñ‡∏ô‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
  @media (max-width: 900px){
    #ol52-header .pair{ flex:1 0 100%; }
    #ol52-header #companyAcc_SPLIFEOL52{ width:100%; }
  }
  
  /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î/‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤ Text Output */
  #outputArea_SPLIFEOL52{
    width: 100%;
    height: clamp(100px, 45vh, 100px); /* ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô + responsive */
    min-height: 80px;
    padding: 12px;
    border-radius: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;      /* ‡∏•‡∏≤‡∏Å‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    box-sizing: border-box;
  }
</style>

<div id="ol52-header">
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡∏ã‡πâ‡∏≤‡∏¢ -->
  <div class="pair">
    <label for="compCode_SPLIFEOL52">Comp.Code:</label>
    <select id="compCode_SPLIFEOL52">
      <option value="OL5206">‡πÑ‡∏ó‡∏¢‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏Ø OL5206</option>
      <option value="MT5206">‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‡∏Ø MT5206</option>
      <option value="AK5206">‡∏≠‡∏≤‡∏Ñ‡πÄ‡∏ô‡∏¢‡πå‡∏Ø AK5206</option>
      <option value="TH5206">‡πÑ‡∏ó‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ø TH5206</option>
    </select>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡∏Ç‡∏ß‡∏≤ (‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ) -->
  <div class="pair grow">
    <label for="companyAcc_SPLIFEOL52">Company Account No.:</label>
    <input id="companyAcc_SPLIFEOL52" type="text" readonly>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 -->
  <div class="pair full">
    <label for="txnDate_SPLIFEOL52">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
    <input type="date" id="txnDate_SPLIFEOL52">
  </div>
</div>


  <div class="hint">
    * ‡∏ñ‡πâ‡∏≤ Account Name ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô ANSI (TIS-620)
  </div>

  <table id="detailTable_SPLIFEOL52">
    <thead>
      <tr>
        <th>Customer Acc No<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</span></th>
        <th>Txn Code<br><span class="tiny">(C/D)</span></th>
        <th>Amount (THB)<br><span class="tiny">(‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô)</span></th>
        <th>Service Type<br><span class="tiny">("00")</span></th>
        <th>Status<br><span class="tiny">(‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</span></th>
        <th>Ref. no<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ)</span></th>
        <th>ID Card<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)</span></th>
        <th>Branch Code<br><span class="tiny">(‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤)</span></th>
        <th>Branch Name<br><span class="tiny">(‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤)</span></th>
        <th>POST DATE (DDMMYY)<br><span class="tiny">(‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ)</span></th>
        <th>Account Name<br><span class="tiny">(‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</span></th>
        <th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="toolbar">
    <button onclick="OL52.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    <button onclick="OL52.clearRows()">üßπ Clear</button>
    <button onclick="OL52.generateText()">üìÑ Generate</button>
    <button onclick="OL52.copyOutput()">üìã Copy</button>
    <button onclick="OL52.downloadTxt()">üíæ Export</button>
  </div>

  
  


  <h3>üì¶ Text Output</h3>
  <textarea id="outputArea_SPLIFEOL52" readonly></textarea>
</section>

<!-- ======================= OL55 ======================= -->
<section id="app_ol55" class="app-section">
  <h2>üìÑ Generator Text File - Direct Debit For OL55_MRTA SP-Life (BAAC 034)</h2>

  <style>
  /* ===== OL55 header layout ===== */
  #ol55-header{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    column-gap:24px;      /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° */
    row-gap:16px;         /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
  }
  #ol55-header .pair{
    display:flex;
    align-items:center;
    gap:12px;             /* ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á label ‡∏Å‡∏±‡∏ö control */
  }
  #ol55-header .pair label{ font-weight:600; }

  /* ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏ß‡∏≤‡∏¢‡∏∑‡∏î‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á Account ‡∏¢‡∏≤‡∏ß */
  #ol55-header .grow{ flex:1 1 520px; }

  /* ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß */
  #ol55-header .full{ flex:1 0 100%; }

  /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏∏‡∏°‡πÇ‡∏ó‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  #ol55-header select,
  #ol55-header input[type="text"],
  #ol55-header input[type="date"]{
    height:36px;
    padding:4px 10px;
    border-radius:8px;
  }
  #compCode_SPLIFEOL55{ width:250px; }
  #companyAcc_SPLIFEOL55{ width:180px; max-width:100%; }
  #txnDate_SPLIFEOL55{ width:160px; }

  /* ‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å: ‡πÅ‡∏ï‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */
  @media (max-width: 900px){
    #ol55-header .pair{ flex:1 0 100%; }
    #companyAcc_SPLIFEOL55{ width:100%; }
  }
  #outputArea_SPLIFEOL55{
    width: 100%;
    height: clamp(100px, 45vh, 100px); /* ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô + responsive */
    min-height: 80px;
    padding: 12px;
    border-radius: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;      /* ‡∏•‡∏≤‡∏Å‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
    box-sizing: border-box;
  }
</style>

<div id="ol55-header">
  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡∏ã‡πâ‡∏≤‡∏¢ -->
  <div class="pair">
    <label for="compCode_SPLIFEOL55">Comp.Code:</label>
    <select id="compCode_SPLIFEOL55">
      <option value="OL5506">‡πÑ‡∏ó‡∏¢‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏Ø OL5506</option>
      <option value="MT5506">‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡πÑ‡∏ó‡∏¢‡∏Ø MT5506</option>
      <option value="AK5506">‡∏≠‡∏≤‡∏Ñ‡πÄ‡∏ô‡∏¢‡πå‡∏Ø AK5506</option>
      <option value="TH5506">‡πÑ‡∏ó‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ø TH5506</option>
    </select>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 ‡∏Ç‡∏ß‡∏≤ (‡∏¢‡∏∑‡∏î‡πÑ‡∏î‡πâ) -->
  <div class="pair grow">
    <label for="companyAcc_SPLIFEOL55">Company Account No.:</label>
    <input id="companyAcc_SPLIFEOL55" type="text" readonly>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 -->
  <div class="pair full">
    <label for="txnDate_SPLIFEOL55">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</label>
    <input type="date" id="txnDate_SPLIFEOL55">
  </div>
</div>


  <div class="hint">
    * ‡∏ñ‡πâ‡∏≤ Account Name ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô ANSI (TIS-620)
  </div>

  <table id="detailTable_SPLIFEOL55">
    <thead>
      <tr>
        <th>Customer Acc No<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</span></th>
        <th>Txn Code<br><span class="tiny">(C/D)</span></th>
        <th>Amount (THB)<br><span class="tiny">(‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô)</span></th>
        <th>Service Type<br><span class="tiny">("00")</span></th>
        <th>Status<br><span class="tiny">(‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞)</span></th>
        <th>Ref. no<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ)</span></th>
        <th>ID Card<br><span class="tiny">(‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)</span></th>
        <th>Branch Code<br><span class="tiny">(‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤)</span></th>
        <th>Branch Name<br><span class="tiny">(‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤)</span></th>
        <th>POST DATE (DDMMYY)<br><span class="tiny">(‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ)</span></th>
        <th>Account Name<br><span class="tiny">(‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ)</span></th>
        <th>‡∏•‡∏ö</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="toolbar">
    <button onclick="OL55.addRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
    <button onclick="OL55.clearRows()">üßπ Clear</button>
    <button onclick="OL55.generateText()">üìÑ Generate</button>
    <button onclick="OL55.copyOutput()">üìã Copy</button>
    <button onclick="OL55.downloadTxt()">üíæ Export</button>
  </div>

  <h3>üì¶ Text Output</h3>
  <textarea id="outputArea_SPLIFEOL55" readonly></textarea>
</section>

<script>
/* ================= MODULE: CBSPLIFE ================= */
const CBSPLIFE = (function(){
  const BANK_CODE = "034";
  const COMPANY_NAME = "0000000000OCEAN LIFE INSURANCE PUBLIC - ";
  const HEADER_FILLER_77_88 = "020007745770";

  const padR = (s,len)=> (s??"").toString().padEnd(len," ").slice(0,len);
  const padL = (s,len,ch="0")=> (s??"").toString().padStart(len,ch).slice(-len);
  const onlyDigits = s => (s||"").replace(/\D+/g,"");
  function ddmmyyyy(dateStr){
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = String(d.getFullYear());
    return dd+mm+yyyy;
  }
  function toCentsN(val, n){
    const num = parseFloat(String(val).replace(/[^\d.]/g,""));
    const cents = isNaN(num) ? 0 : Math.round(num*100);
    return String(cents).padStart(n,"0");
  }

  function fillPostDate(){
    const el = document.getElementById("txnDate_CBSPLIFE");
    if (!el || !el.value) return;
    const base = ddmmyyyy(el.value);
    document.querySelectorAll("#detailTable_CBSPLIFE tbody .postdate_CBSPLIFE").forEach(inp => inp.value = base);
  }

  function addRow(){
    const tbody = document.querySelector("#detailTable_CBSPLIFE tbody");
    const tr = document.createElement("tr");
    const post = ddmmyyyy(document.getElementById("txnDate_CBSPLIFE").value || new Date());
    tr.innerHTML = `
      <td><input class="postdate_CBSPLIFE" type="text" maxlength="8" placeholder="DDMMYYYY" value="${post}"/></td>
      <td><input class="accname_CBSPLIFE" type="text" maxlength="50" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" value="QA SPLifeFile"/></td>
      <td><input class="refno_CBSPLIFE"   type="text" maxlength="10" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ (10)" value="8068000095" /></td>
      <td><input class="idcard_CBSPLIFE"  type="text" maxlength="13" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (13)" value="2746506702371"/></td>
      <td><input class="branchcode_CBSPLIFE" type="text" maxlength="4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (4)" value="1007"/></td>
      <td><input class="amount_CBSPLIFE"  type="text" inputmode="decimal" pattern="^\\d+(\\.\\d{0,2})?$" value="500.00"/></td>
      <td><button onclick="this.closest('tr').remove()">üóë</button></td>
    `;
    tbody.appendChild(tr);
  }
  function clearRows(){
    document.querySelector("#detailTable_CBSPLIFE tbody").innerHTML = "";
    document.getElementById("outputArea_CBSPLIFE").value = "";
    addRow(); fillPostDate();
  }
  function buildHeader(){
    const seq = "000001";
    const compName = padR(COMPANY_NAME, 40);
    const payCode  = document.getElementById("payType_CBSPLIFE").value || "OL11";
    const post8    = ddmmyyyy(document.getElementById("txnDate_CBSPLIFE").value || new Date());
    const arr = Array.from({length:195}, ()=>" ");
    const put = (pos, text, len) => {
      const s = (text||"").toString().padEnd(len," ").slice(0,len);
      for (let i=0;i<len;i++) arr[pos-1+i] = s[i];
    };
    put(1 , "H", 1);
    put(2 , seq, 6);
    put(8 , BANK_CODE, 3);
    put(11, compName, 40);
    put(51, padR(payCode,4), 4);
    put(61, post8, 8);
    put(77, HEADER_FILLER_77_88, 12);
    return arr.join("");
  }
  function buildTrailer(dCount, totalAmtThb){
    const drNo6   = String(dCount).padStart(6, "0");
    const drAmt13 = String(Math.round((totalAmtThb || 0) * 100)).padStart(13,"0");
    const arr = Array.from({length:132}, () => " ");
    const put = (pos, text, len) => {
      const s = (text ?? "").toString().padEnd(len, " ").slice(0, len);
      for (let i = 0; i < len; i++) arr[pos - 1 + i] = s[i];
    };
    put(1 , "T", 1);
    put(2 , "0000", 4);
    put(6 , "034", 3);
    put(9 , "0000000000000000000000000000000", 31);
    put(40, drAmt13, 13);
    put(53, drNo6, 6);
    put(67, " ".repeat(66), 66);
    return arr.join("");
  }
  function buildDetailLine(seqNumber, row){
    const post8     = padL((row.querySelector(".postdate_CBSPLIFE")?.value || "").replace(/\D+/g,""), 8, "0");
    const accName50 = padR(row.querySelector(".accname_CBSPLIFE")?.value || "", 50);
    const refno20   = padR((row.querySelector(".refno_CBSPLIFE")?.value || "").slice(0,20), 20);
    const id13      = padL(onlyDigits(row.querySelector(".idcard_CBSPLIFE")?.value || ""), 13, "0");
    const br4       = padL(onlyDigits(row.querySelector(".branchcode_CBSPLIFE")?.value || ""), 4, "0");
    const amt13     = toCentsN(row.querySelector(".amount_CBSPLIFE")?.value || "0", 13);
    const arr = Array.from({length: 332}, () => " ");
    const put = (pos, text, len) => {
      const s = (text || "").toString().padEnd(len, " ").slice(0, len);
      for (let i = 0; i < len; i++) arr[pos - 1 + i] = s[i];
    };
    put(1 , "D", 1);
    put(2 , "000002", 6);
    put(8 , "034", 3);
    put(11, "0000000000", 10);
    put(21, post8, 8);
    put(29, "080851", 6);
    put(35, accName50, 50);
    put(85, refno20, 20);
    put(105, id13, 13);
    put(145, "0", 1);
    put(146, br4, 4);
    put(150, "019CCSH0000000", 15);
    put(164, amt13, 13);
    return arr.join("");
  }
  function generateText(){
    const tbody = document.querySelector("#detailTable_CBSPLIFE tbody");
    const rows = [...tbody.querySelectorAll("tr")];
    const header = buildHeader();
    let totalAmount = 0;
    const details = rows.map((row, idx)=>{
      const amt = parseFloat(row.querySelector(".amount_CBSPLIFE")?.value || "0") || 0;
      totalAmount += amt;
      return buildDetailLine(idx + 2, row);
    });
    const trailer = buildTrailer(rows.length, totalAmount);
    document.getElementById("outputArea_CBSPLIFE").value = [header, ...details, trailer].join("\n");
  }
  function copyOutput(){
    const ta = document.getElementById("outputArea_CBSPLIFE");
    ta.select(); document.execCommand("copy");
  }
  function downloadTxt(){
    const raw = document.getElementById("outputArea_CBSPLIFE").value;
    const contentCRLF = raw.replace(/\n/g, "\r\n");
    const bytes = (function encodeTIS620(str){
      const out = [];
      for (const ch of str){
        const code = ch.codePointAt(0);
        if (code <= 0x7F) out.push(code);
        else if (code >= 0x0E01 && code <= 0x0E5B) out.push(code - 0x0E00 + 0xA0);
        else out.push(0x3F);
      }
      return new Uint8Array(out);
    })(contentCRLF);
    const payCode = (document.getElementById("payType_CBSPLIFE")?.value || "OL11");
    const dateDDMMYYYY = ddmmyyyy(document.getElementById("txnDate_CBSPLIFE")?.value || new Date());
    const filename = `${payCode}_${dateDDMMYYYY}.txt`;
    const blob = new Blob([bytes], { type: "text/plain;charset=TIS-620" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  }
  function init(){
    const dt = document.getElementById("txnDate_CBSPLIFE");
    dt.valueAsDate = new Date();
    dt.addEventListener("input", fillPostDate);
    dt.addEventListener("change", fillPostDate);
    addRow(); fillPostDate();
  }
  return {init, addRow, clearRows, generateText, copyOutput, downloadTxt};
})();

/* ================= MODULE: OL52 ================= */
const OL52 = (function(){
  const BANK_CODE = "034";
  const COMPANY_NAME = "‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß";
  const COMPANY_ACC_BY_CODE = {
    OL5206: "000820050702",
    MT5206: "000050015003",
    AK5206: "010020365885",
    TH5206: "010582207017",
  };
  const padR = (s,len)=> (s??"").toString().padEnd(len," ").slice(0,len);
  const padL = (s,len,ch="0")=> (s??"").toString().padStart(len,ch).slice(-len);
  const onlyDigits = s => (s||"").replace(/\D+/g,"");
  function ddmmyyyy(dateStr){
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = String(d.getFullYear());
    return dd+mm+yyyy;
  }
  function ddmmyy(dateStr){ const s = ddmmyyyy(dateStr); return s ? (s.slice(0,4) + s.slice(6)) : ""; }
  function toCentsN(val, n=12){
    const num = parseFloat(String(val).replace(/[^\d.]/g,""));
    const cents = isNaN(num) ? 0 : Math.round(num*100);
    return String(cents).padStart(n,"0");
  }
  function ddmmyy_to_BEyymmdd(s){
    s = (s || "").replace(/\D+/g, "");
    if (s.length !== 6) return padL(s, 6, "0");
    const dd = s.slice(0,2), mm = s.slice(2,4), yy = parseInt(s.slice(4,6), 10);
    const yyBE = ((yy + 43) % 100).toString().padStart(2, "0");
    return yyBE + mm + dd;
  }
  function syncCompanyAccount(){
    const cc = document.getElementById("compCode_SPLIFEOL52").value;
    document.getElementById("companyAcc_SPLIFEOL52").value = COMPANY_ACC_BY_CODE[cc] || "";
  }
  function fillPostDate(){
    const el = document.getElementById("txnDate_SPLIFEOL52");
    if (!el || !el.value) return;
    const base = ddmmyy(el.value);
    document.querySelectorAll("#detailTable_SPLIFEOL52 tbody .postdate_SPLIFEOL52").forEach(inp => inp.value = base);
  }
  function addRow(){
    const tbody = document.querySelector("#detailTable_SPLIFEOL52 tbody");
    const tr = document.createElement("tr");
    const post = ddmmyy(document.getElementById("txnDate_SPLIFEOL52").value || new Date());
    tr.innerHTML = `
      <td><input class="custacc_SPLIFEOL52" type="text" maxlength="12" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 12 ‡∏´‡∏•‡∏±‡∏Å" value="020018580370" /></td>
      <td>
        <select class="txncode_SPLIFEOL52">
          <option value="D">D (Debit)</option>
          <option value="C">C (Credit)</option>
        </select>
      </td>
      <td><input class="amount_SPLIFEOL52" type="text" inputmode="decimal" pattern="^\\d+(\\.\\d{0,2})?$" value="500.00" /></td>
      <td>
        <select class="servicetype_SPLIFEOL52">
          <option value="00" selected>00</option>
          <option value="01">01</option>
          <option value="02">02</option>
        </select>
      </td>
      <td>
        <select class="status_SPLIFEOL52">
          <option value="0" selected>0 = PAST</option>
          <option value="9">9 = ORIGINAL (for input)</option>
          <option value="1">1 = INSUFFICIENT FUND</option>
          <option value="2">2 = CLOSE/NO FOUND ACCOUNT</option>
          <option value="3">3 = ACCOUNT BLOCK/OTHER</option>
          <option value="4">4 = INVALID ACCOUNT NUMBER</option>
          <option value="5">5 = MUST BE CHECK</option>
        </select>
      </td>
      <td><input class="refno_SPLIFEOL52" type="text" maxlength="12" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï" value="100567001511" /></td>
      <td><input class="idcard_SPLIFEOL52" type="text" maxlength="13" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (13)" value="2746506702371" /></td>
      <td><input class="branchcode_SPLIFEOL52" type="text" maxlength="4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (4)" value="1007"/></td>
      <td><input class="branchname_SPLIFEOL52" type="text" maxlength="15" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤" value="‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"/></td>
      <td><input class="postdate_SPLIFEOL52" type="text" maxlength="6" value="${post}" /></td>
      <td><input class="accname_SPLIFEOL52" type="text" maxlength="31" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" value="QA SPLifeFile" /></td>
      <td><button onclick="this.closest('tr').remove()">üóë</button></td>
    `;
    tbody.appendChild(tr);
  }
  function clearRows(){
    document.querySelector("#detailTable_SPLIFEOL52 tbody").innerHTML = "";
    document.getElementById("outputArea_SPLIFEOL52").value = "";
    addRow();  fillPostDate();
  }
  function buildHeader(){
    const seq = "000001";
    const compCode = document.getElementById("compCode_SPLIFEOL52").value;
    const compAcc  = padL(document.getElementById("companyAcc_SPLIFEOL52").value||"", 12, "0");
    const compName = padR(COMPANY_NAME, 25);
    const postDate6 = ddmmyy(document.getElementById("txnDate_SPLIFEOL52").value || new Date());
    const raw = "H" + seq + BANK_CODE + compAcc + compName + postDate6 + compCode;
    return padR(raw, 195);
  }
  function buildTrailer(dCount, totalAmtThb){
    const seq6     = String(dCount + 2).padStart(6, "0");
    const compAcc  = (document.getElementById("companyAcc_SPLIFEOL52").value || "").toString().padStart(12,"0").slice(-12);
    const drNo     = String(dCount).padStart(7, "0");
    const drAmt15  = String(Math.round((totalAmtThb||0)*100)).padStart(15,"0");
    const crNo     = "0000000";
    const crAmt15  = "000000000000000";
    const filler66 = " ".repeat(66);
    const arr = Array.from({length:132}, ()=>" ");
    const put = (pos, text, len) => { const s = (text||"").toString().padEnd(len," ").slice(0,len); for (let i=0;i<len;i++) arr[pos-1+i] = s[i]; };
    put(1 , "T", 1);
    put(2 , seq6, 6);
    put(8 , BANK_CODE, 3);
    put(11, compAcc, 12);
    put(23, drNo, 7);
    put(30, drAmt15, 15);
    put(45, crNo, 7);
    put(52, crAmt15, 15);
    put(67, filler66, 66);
    return arr.join("");
  }
  function buildDetailLine(seqNumber, row){
    const custAcc = padL(onlyDigits(row.querySelector(".custacc_SPLIFEOL52")?.value || ""), 12, "0");
    const txnCode = (row.querySelector(".txncode_SPLIFEOL52")?.value || "D").slice(0,1);
    const amtThb  = row.querySelector(".amount_SPLIFEOL52")?.value || "0";
    const service = padL(row.querySelector(".servicetype_SPLIFEOL52")?.value || "00", 2, "0");
    const status  = (row.querySelector(".status_SPLIFEOL52")?.value || "0").slice(0,1);
    const refno   = padR((row.querySelector(".refno_SPLIFEOL52")?.value || "").slice(0,12), 12);
    const idcard  = padL(onlyDigits(row.querySelector(".idcard_SPLIFEOL52")?.value || ""), 13, "0");
    const brCode  = padL(onlyDigits(row.querySelector(".branchcode_SPLIFEOL52")?.value || ""), 4, "0");
    const brName  = padR(row.querySelector(".branchname_SPLIFEOL52")?.value || "", 15);
    const postUI  = padL(row.querySelector(".postdate_SPLIFEOL52")?.value || "", 6, "0");
    const postOut = ddmmyy_to_BEyymmdd(postUI);
    const accName = padR(row.querySelector(".accname_SPLIFEOL52")?.value || "", 31);
    const seq6 = String(seqNumber).padStart(6,"0");
    const amt12 = toCentsN(amtThb, 12);
    const arr = Array.from({length:132}, ()=>" ");
    const put = (pos, text, len) => { const s = padR(text, len); for (let i=0;i<len;i++) arr[pos-1+i] = s[i] ?? " "; };
    put(1 , "D", 1);
    put(2 , seq6, 6);
    put(8 , BANK_CODE, 3);
    put(11, custAcc, 12);
    put(23, txnCode, 1);
    put(24, amt12, 12);
    put(36, service, 2);
    put(38, status, 1);
    put(39, refno, 12);
    put(51, idcard, 13);
    put(64, brCode, 4);
    put(68, brName, 15);
    put(83, postOut, 6);
    put(98, accName, 31);
    return arr.join("");
  }
  function generateText(){
    const tbody = document.querySelector("#detailTable_SPLIFEOL52 tbody");
    const rows = [...tbody.querySelectorAll("tr")];
    const header = buildHeader();
    let totalAmount = 0;
    const details = rows.map((row, idx)=>{
      const amt = parseFloat(row.querySelector(".amount_SPLIFEOL52")?.value || "0") || 0;
      totalAmount += amt;
      return buildDetailLine(idx + 2, row);
    });
    const trailer = buildTrailer(rows.length, totalAmount);
    document.getElementById("outputArea_SPLIFEOL52").value = [header, ...details, trailer].join("\n");
  }
  function copyOutput(){ const ta = document.getElementById("outputArea_SPLIFEOL52"); ta.select(); document.execCommand("copy"); }
  function downloadTxt(){
    const raw = document.getElementById("outputArea_SPLIFEOL52").value;
    const contentCRLF = raw.replace(/\n/g, "\r\n");
    const bytes = (function encodeTIS620(str){
      const out = [];
      for (const ch of str){
        const code = ch.codePointAt(0);
        if (code <= 0x7F){ out.push(code); }
        else if (code >= 0x0E01 && code <= 0x0E5B){ out.push(code - 0x0E00 + 0xA0); }
        else { out.push(0x3F); }
      }
      return new Uint8Array(out);
    })(contentCRLF);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([bytes], { type: "text/plain;charset=TIS-620" }));
    a.download = "OL52_MLTA_ANSI.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function init(){
    document.getElementById("txnDate_SPLIFEOL52").valueAsDate = new Date();
    document.getElementById("txnDate_SPLIFEOL52").addEventListener("input", fillPostDate);
    document.getElementById("txnDate_SPLIFEOL52").addEventListener("change", fillPostDate);
    document.getElementById("compCode_SPLIFEOL52").addEventListener("change", syncCompanyAccount);
    syncCompanyAccount();
    addRow(); fillPostDate();
  }
  return {init, addRow, clearRows, generateText, copyOutput, downloadTxt};
})();

/* ================= MODULE: OL55 ================= */
const OL55 = (function(){
  const BANK_CODE = "034";
  const COMPANY_NAME = "‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏•‡∏î‡∏•‡∏á";
  const COMPANY_ACC_BY_CODE = {
    OL5506: "000820050702",
    MT5506: "000050015003",
    AK5506: "010020365885",
    TH5506: "010582207017",
  };
  const padR = (s,len)=> (s??"").toString().padEnd(len," ").slice(0,len);
  const padL = (s,len,ch="0")=> (s??"").toString().padStart(len,ch).slice(-len);
  const onlyDigits = s => (s||"").replace(/\D+/g,"");
  function ddmmyyyy(dateStr){
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = String(d.getFullYear());
    return dd+mm+yyyy;
  }
  function ddmmyy(dateStr){ const s = ddmmyyyy(dateStr); return s ? (s.slice(0,4) + s.slice(6)) : ""; }
  function toCentsN(val, n=12){
    const num = parseFloat(String(val).replace(/[^\d.]/g,""));
    const cents = isNaN(num) ? 0 : Math.round(num*100);
    return String(cents).padStart(n,"0");
  }
  function ddmmyy_to_BEyymmdd(s){
    s = (s || "").replace(/\D+/g, "");
    if (s.length !== 6) return padL(s, 6, "0");
    const dd = s.slice(0,2), mm = s.slice(2,4), yy = parseInt(s.slice(4,6), 10);
    const yyBE = ((yy + 43) % 100).toString().padStart(2, "0");
    return yyBE + mm + dd;
  }
  function syncCompanyAccount(){
    const cc = document.getElementById("compCode_SPLIFEOL55").value;
    document.getElementById("companyAcc_SPLIFEOL55").value = COMPANY_ACC_BY_CODE[cc] || "";
  }
  function fillPostDate(){
    const el = document.getElementById("txnDate_SPLIFEOL55");
    if (!el || !el.value) return;
    const base = ddmmyy(el.value);
    document.querySelectorAll("#detailTable_SPLIFEOL55 tbody .postdate_SPLIFEOL55").forEach(inp => inp.value = base);
  }
  function addRow(){
    const tbody = document.querySelector("#detailTable_SPLIFEOL55 tbody");
    const tr = document.createElement("tr");
    const post = ddmmyy(document.getElementById("txnDate_SPLIFEOL55").value || new Date());
    tr.innerHTML = `
      <td><input class="custacc_SPLIFEOL55" type="text" maxlength="12" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 12 ‡∏´‡∏•‡∏±‡∏Å" value="020018580370" /></td>
      <td>
        <select class="txncode_SPLIFEOL55">
          <option value="D">D (Debit)</option>
          <option value="C">C (Credit)</option>
        </select>
      </td>
      <td><input class="amount_SPLIFEOL55" type="text" inputmode="decimal" pattern="^\\d+(\\.\\d{0,2})?$" value="500.00" /></td>
      <td>
        <select class="servicetype_SPLIFEOL55">
          <option value="00" selected>00</option>
          <option value="01">01</option>
          <option value="02">02</option>
        </select>
      </td>
      <td>
        <select class="status_SPLIFEOL55">
          <option value="0" selected>0 = PAST</option>
          <option value="9">9 = ORIGINAL (for input)</option>
          <option value="1">1 = INSUFFICIENT FUND</option>
          <option value="2">2 = CLOSE/NO FOUND ACCOUNT</option>
          <option value="3">3 = ACCOUNT BLOCK/OTHER</option>
          <option value="4">4 = INVALID ACCOUNT NUMBER</option>
          <option value="5">5 = MUST BE CHECK</option>
        </select>
      </td>
      <td><input class="refno_SPLIFEOL55" type="text" maxlength="14" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï" value="10056700151144" /></td>
      <td><input class="idcard_SPLIFEOL55" type="text" maxlength="13" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä. (13)" value="2746506702371" /></td>
      <td><input class="branchcode_SPLIFEOL55" type="text" maxlength="4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤ (4)" value="1007"/></td>
      <td><input class="branchname_SPLIFEOL55" type="text" maxlength="15" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤" value="‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà"/></td>
      <td><input class="postdate_SPLIFEOL55" type="text" maxlength="6" value="${post}" /></td>
      <td><input class="accname_SPLIFEOL55" type="text" maxlength="31" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" value="QA SPLifeFile" /></td>
      <td><button onclick="this.closest('tr').remove()">üóë</button></td>
    `;
    tbody.appendChild(tr);
  }
  function clearRows(){
    document.querySelector("#detailTable_SPLIFEOL55 tbody").innerHTML = "";
    document.getElementById("outputArea_SPLIFEOL55").value = "";
    addRow();  fillPostDate();
  }
  function buildHeader(){
    const seq = "000001";
    const compCode = document.getElementById("compCode_SPLIFEOL55").value;
    const compAcc  = padL(document.getElementById("companyAcc_SPLIFEOL55").value||"", 12, "0");
    const compName = padR(COMPANY_NAME, 25);
    const postDate6 = ddmmyy(document.getElementById("txnDate_SPLIFEOL55").value || new Date());
    const raw = "H" + seq + BANK_CODE + compAcc + compName + postDate6 + compCode;
    return padR(raw, 195);
  }
  function buildTrailer(dCount, totalAmtThb){
    const seq6     = String(dCount + 2).padStart(6, "0");
    const compAcc  = (document.getElementById("companyAcc_SPLIFEOL55").value || "").toString().padStart(12,"0").slice(-12);
    const drNo     = String(dCount).padStart(7, "0");
    const drAmt15  = String(Math.round((totalAmtThb||0)*100)).padStart(15,"0");
    const crNo     = "0000000";
    const crAmt15  = "000000000000000";
    const filler66 = " ".repeat(66);
    const arr = Array.from({length:132}, ()=>" ");
    const put = (pos, text, len) => { const s = (text||"").toString().padEnd(len," ").slice(0,len); for (let i=0;i<len;i++) arr[pos-1+i] = s[i]; };
    put(1 , "T", 1);
    put(2 , seq6, 6);
    put(8 , "034", 3);
    put(11, compAcc, 12);
    put(23, drNo, 7);
    put(30, drAmt15, 15);
    put(45, crNo, 7);
    put(52, crAmt15, 15);
    put(67, filler66, 66);
    return arr.join("");
  }
  function buildDetailLine(seqNumber, row){
    const custAcc = padL(onlyDigits(row.querySelector(".custacc_SPLIFEOL55")?.value || ""), 12, "0");
    const txnCode = (row.querySelector(".txncode_SPLIFEOL55")?.value || "D").slice(0,1);
    const amtThb  = row.querySelector(".amount_SPLIFEOL55")?.value || "0";
    const service = padL(row.querySelector(".servicetype_SPLIFEOL55")?.value || "00", 2, "0");
    const status  = (row.querySelector(".status_SPLIFEOL55")?.value || "0").slice(0,1);
    const refno   = padR((row.querySelector(".refno_SPLIFEOL55")?.value || "").slice(0,14), 14);
    const idcard  = padL(onlyDigits(row.querySelector(".idcard_SPLIFEOL55")?.value || ""), 13, "0");
    const brCode  = padL(onlyDigits(row.querySelector(".branchcode_SPLIFEOL55")?.value || ""), 4, "0");
    const brName  = padR(row.querySelector(".branchname_SPLIFEOL55")?.value || "", 15);
    const postUI  = padL(row.querySelector(".postdate_SPLIFEOL55")?.value || "", 6, "0");
    const postOut = ddmmyy_to_BEyymmdd(postUI);
    const accName = padR(row.querySelector(".accname_SPLIFEOL55")?.value || "", 31);
    const seq6 = String(seqNumber).padStart(6,"0");
    const amt12 = toCentsN(amtThb, 12);
    const arr = Array.from({length:132}, ()=>" ");
    const put = (pos, text, len) => { const s = padR(text, len); for (let i=0;i<len;i++) arr[pos-1+i] = s[i] ?? " "; };
    put(1 , "D", 1);
    put(2 , seq6, 6);
    put(8 , "034", 3);
    put(11, custAcc, 12);
    put(23, txnCode, 1);
    put(24, amt12, 12);
    put(36, service, 2);
    put(38, status, 1);
    put(39, refno, 14);
    put(53, idcard, 13);
    put(66, brCode, 4);
    put(70, brName, 15);
    put(83, postOut, 6);
    put(98, accName, 31);
    return arr.join("");
  }
  function generateText(){
    const tbody = document.querySelector("#detailTable_SPLIFEOL55 tbody");
    const rows = [...tbody.querySelectorAll("tr")];
    const header = buildHeader();
    let totalAmount = 0;
    const details = rows.map((row, idx)=>{
      const amt = parseFloat(row.querySelector(".amount_SPLIFEOL55")?.value || "0") || 0;
      totalAmount += amt;
      return buildDetailLine(idx + 2, row);
    });
    const trailer = buildTrailer(rows.length, totalAmount);
    document.getElementById("outputArea_SPLIFEOL55").value = [header, ...details, trailer].join("\n");
  }
  function copyOutput(){ const ta = document.getElementById("outputArea_SPLIFEOL55"); ta.select(); document.execCommand("copy"); }
  function downloadTxt(){
    const raw = document.getElementById("outputArea_SPLIFEOL55").value;
    const contentCRLF = raw.replace(/\n/g, "\r\n");
    const bytes = (function encodeTIS620(str){
      const out = [];
      for (const ch of str){
        const code = ch.codePointAt(0);
        if (code <= 0x7F){ out.push(code); }
        else if (code >= 0x0E01 && code <= 0x0E5B){ out.push(code - 0x0E00 + 0xA0); }
        else { out.push(0x3F); }
      }
      return new Uint8Array(out);
    })(contentCRLF);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([bytes], { type: "text/plain;charset=TIS-620" }));
    a.download = "OL55_MRTA_ANSI.txt";
    a.click();
    URL.revokeObjectURL(a.href);
  }
  function init(){
    document.getElementById("txnDate_SPLIFEOL55").valueAsDate = new Date();
    document.getElementById("txnDate_SPLIFEOL55").addEventListener("input", fillPostDate);
    document.getElementById("txnDate_SPLIFEOL55").addEventListener("change", fillPostDate);
    document.getElementById("compCode_SPLIFEOL55").addEventListener("change", syncCompanyAccount);
    syncCompanyAccount();
    addRow(); fillPostDate();
  }
  return {init, addRow, clearRows, generateText, copyOutput, downloadTxt};
})();

/* ====== Section switcher (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏°‡∏î‡∏π‡∏• ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á TDZ/ReferenceError) ====== */
(function(){
  const picker = document.getElementById('templatePicker');
  const sections = {
    cbsplife: {el: document.getElementById('app_cbsplife'), init: ()=>CBSPLIFE.init()},
    ol52    : {el: document.getElementById('app_ol52')   , init: ()=>OL52.init()},
    ol55    : {el: document.getElementById('app_ol55')   , init: ()=>OL55.init()},
  };
  const inited = {cbsplife:false, ol52:false, ol55:false};

  function showSection(key){
    Object.values(sections).forEach(s => s.el.style.display='none');
    const s = sections[key];
    s.el.style.display='block';
    if(!inited[key]){ s.init(); inited[key]=true; }
  }

  picker.addEventListener('change', e => showSection(e.target.value));
  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á dropdown
  showSection(picker.value);
})();

/* ==========================================================
   CBSPLIFE ‚Äî Import (CSV/TSV/TXT/JSON + XLSX-if-available)
   * ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°: ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏∏‡πà‡∏° Import ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏¥‡∏° CBSPLIFE.handleFile
   * ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ CBSPLIFE.addRow() ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Üí logic ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡∏Ñ‡∏£‡∏ö
   * ‡πÅ‡∏°‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ ‡πÜ ‡∏Å‡∏±‡∏ô)
   * ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, Customer Name, Ref1, Ref2, Branch Code, Amount
   ========================================================== */
(function () {
  // ‡∏°‡∏µ CBSPLIFE ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°
  if (!window.CBSPLIFE) window.CBSPLIFE = {};
  const NS = window.CBSPLIFE;

  // ---------- Inject ‡∏õ‡∏∏‡πà‡∏° Import + input[file] ‡πÄ‡∏Ç‡πâ‡∏≤ toolbar ‡∏Ç‡∏≠‡∏á CBSPLIFE ----------
  document.addEventListener('DOMContentLoaded', function () {
    try {
      const app = document.querySelector('#app_cbsplife');
      if (!app) return;
      const toolbar = app.querySelector('.toolbar');
      if (!toolbar) return;

      // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥
      if (app.querySelector('#cbsplifeImport')) return;

      const fileInput = document.createElement('input');
      fileInput.id = 'cbsplifeImport';
      fileInput.type = 'file';
      fileInput.accept = '.csv,.tsv,.txt,.xlsx,.json';
      fileInput.hidden = true;
      fileInput.addEventListener('change', function (e) {
        const f = e.target.files && e.target.files[0];
        NS.handleFile && NS.handleFile(f);
        e.target.value = ''; // reset ‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà trigger
      });

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = '‚¨ÜÔ∏è Import';
      btn.addEventListener('click', () => fileInput.click());

      toolbar.appendChild(fileInput);
      toolbar.appendChild(btn);
    } catch (err) {
      console.error('CBSPLIFE Import UI init failed:', err);
    }
  });

  // ---------- Public: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå ----------
  NS.handleFile = async function (file) {
    if (!file) return;
    try {
      const ext = (file.name.split('.').pop() || '').toLowerCase();

      let rows = [];
      if (['csv', 'tsv', 'txt'].includes(ext)) {
        const text = await file.text();
        rows = parseDelimited(text);
      } else if (ext === 'json') {
        const text = await file.text();
        const data = JSON.parse(text);
        rows = Array.isArray(data) ? data : (data.rows || []);
      } else if (ext === 'xlsx') {
        if (typeof window.XLSX === 'undefined') {
          alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ SheetJS (XLSX) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô .xlsx\\n‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .csv ‡πÅ‡∏•‡πâ‡∏ß import ‡πÅ‡∏ó‡∏ô');
          return;
        }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      } else {
        alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö');
        return;
      }

      const normalized = normalizeRows(rows);
      if (!normalized.length) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏°‡∏õ‡πÑ‡∏î‡πâ\\n(‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, Customer Name, Ref1, Ref2, Branch Code, Amount)');
        return;
      }

      populateTable(normalized); // append ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
      toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${normalized.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    } catch (err) {
      console.error(err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå');
    }
  };

  // ---------- Helpers ----------
  function parseDelimited(text) {
    // ‡πÄ‡∏î‡∏≤‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô: ; > \t > ,
    const sample = text.split(/\r?\n/).slice(0, 2).join('\n');
    const delim = sample.includes(';') ? ';' : (sample.includes('\t') ? '\t' : ',');
    const lines = text.split(/\r?\n/).filter(Boolean);
    if (lines.length === 0) return [];

    const headers = lines[0].split(delim).map((h) => h.trim());
    return lines.slice(1).map((line) => {
      const cells = line.split(delim).map((c) => c.trim());
      const obj = {};
      headers.forEach((h, i) => (obj[h] = cells[i] ?? ''));
      return obj;
    });
  }

  function normalizeRows(rows) {
    // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ key ‡∏õ‡∏Å‡∏ï‡∏¥
    const norm = (s) =>
      String(s || '')
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .replace(/\./g, '')
        .replace(/\(.*?\)/g, '')
        .trim();

    const set = (arr) => new Set(arr.map(norm));
    const keys = {
      date:   set(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', 'ddmmyyyy', 'date', 'txn date', 'txn_date', 'post date', 'postdate']),
      name:   set(['customer name', 'customer', 'account name', '‡∏ä‡∏∑‡πà‡∏≠', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢']),
      ref1:   set(['ref1', '‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠', 'ref', 'ref 1']),
      ref2:   set(['ref2', '‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'id', 'id card', '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', 'ref 2']),
      branch: set(['branch code', '‡∏™‡∏≤‡∏Ç‡∏≤', 'branch']),
      amount: set(['amount', 'amount thb', '‡∏¢‡∏≠‡∏î', '‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô'])
    };

    const out = [];
    for (const r of rows) {
      const pick = (want) => {
        for (const k of Object.keys(r)) if (want.has(norm(k))) return r[k];
        for (const k of Object.keys(r)) if ([...want].some((w) => norm(k).includes(w))) return r[k];
        return '';
      };

      let date = pick(keys.date);
      let name = pick(keys.name);
      let ref1 = pick(keys.ref1);
      let ref2 = pick(keys.ref2);
      let branch = pick(keys.branch);
      let amount = pick(keys.amount);

      if (!(date || name || ref1 || ref2 || branch || amount)) continue;

      date = toDDMMYYYY(date);
      amount = toMoney(amount);

      out.push({ date, name, ref1, ref2, branch, amount });
    }
    return out;
  }

  function toDDMMYYYY(v) {
    if (!v) return '';
    const s = String(v).trim();

    // already DDMMYYYY
    if (/^\d{8}$/.test(s)) return s;

    // 2025-11-10 / 10-11-2025 / 10/11/25
    const m = s.match(/(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})/);
    if (m) {
      let [_, a, b, c] = m; a = +a; b = +b; c = +c;
      let dd, mm, yyyy;
      if (a > 31) { yyyy = a; mm = b; dd = c; }        // yyyy-mm-dd
      else if (c > 31) { dd = a; mm = b; yyyy = c; }   // dd-mm-yyyy
      else { dd = a; mm = b; yyyy = (c < 100 ? 2000 + c : c); } // dd-mm-yy
      return `${pad(dd)}${pad(mm)}${String(yyyy).padStart(4, '0')}`;
    }

    // dd mm yyyy
    const m2 = s.match(/^(\d{1,2})\s(\d{1,2})\s(\d{2,4})$/);
    if (m2) {
      const dd = +m2[1], mm = +m2[2], yRaw = m2[3];
      const yyyy = +yRaw + (yRaw.length === 2 ? 2000 : 0);
      return `${pad(dd)}${pad(mm)}${String(yyyy).padStart(4, '0')}`;
    }

    // fallback: ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç 8 ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
    return s.replace(/\D/g, '').slice(0, 8);
    function pad(n){ return String(n).padStart(2,'0'); }
  }

  function toMoney(v) {
    const n = Number(String(v).replace(/[^0-9.\-]/g, ''));
    return isFinite(n) ? n.toFixed(2) : '';
  }

  function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, {
      position: 'fixed',
      left: '50%',
      top: '20px',
      transform: 'translateX(-50%)',
      background: '#1f2937',
      color: '#fff',
      padding: '8px 14px',
      borderRadius: '8px',
      fontSize: '14px',
      zIndex: 9999,
      boxShadow: '0 4px 12px rgba(0,0,0,.2)',
    });
    document.body.appendChild(t);
    setTimeout(() => { t.style.transition = 'opacity .35s'; t.style.opacity = '0'; }, 1200);
    setTimeout(() => t.remove(), 1700);
  }

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ addRow() ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏™‡πà input class ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  function populateTable(rows) {
    const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
    if (!tbody) return;

    rows.forEach((r) => {
      if (typeof NS.addRow === 'function') NS.addRow(); // ‡πÉ‡∏ä‡πâ function ‡πÄ‡∏î‡∏¥‡∏°

      const lastRow = tbody.querySelector('tr:last-child');
      if (!lastRow) return;

      // class ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
      const iDate   = lastRow.querySelector('.postdate_CBSPLIFE');
      const iName   = lastRow.querySelector('.accname_CBSPLIFE');
      const iRef1   = lastRow.querySelector('.refno_CBSPLIFE');
      const iRef2   = lastRow.querySelector('.idcard_CBSPLIFE');
      const iBranch = lastRow.querySelector('.branchcode_CBSPLIFE');
      const iAmt    = lastRow.querySelector('.amount_CBSPLIFE');

      if (iDate)   iDate.value   = r.date   ?? '';
      if (iName)   iName.value   = r.name   ?? '';
      if (iRef1)   iRef1.value   = r.ref1   ?? '';
      if (iRef2)   iRef2.value   = r.ref2   ?? '';
      if (iBranch) iBranch.value = r.branch ?? '';
      if (iAmt)    iAmt.value    = r.amount ?? '';
    });
  }
})();
/* ==========================================================
   CBSPLIFE ‚Äî Template downloader (CSV)  ‚ùó‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°
   - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° "üì• Template" ‡πÄ‡∏Ç‡πâ‡∏≤ toolbar ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ #app_cbsplife
   - ‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå CSV header ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö parser: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, Customer Name, Ref1, Ref2, Branch Code, Amount
   - ‡πÉ‡∏™‡πà‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 1 ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï (‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
   ========================================================== */
(function () {
  document.addEventListener('DOMContentLoaded', function () {
    try {
      const app = document.querySelector('#app_cbsplife');
      if (!app) return;
      const toolbar = app.querySelector('.toolbar');
      if (!toolbar) return;

      // ‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥ ‡∏ñ‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å
      if (app.querySelector('#cbsplifeTemplateBtn')) return;

      // ‡∏õ‡∏∏‡πà‡∏° Template
      const btnTpl = document.createElement('button');
      btnTpl.id = 'cbsplifeTemplateBtn';
      btnTpl.type = 'button';
      btnTpl.textContent = 'üì• Template';
      btnTpl.addEventListener('click', downloadCBSPLIFETemplate);

      // ‡πÅ‡∏ó‡∏£‡∏Å‡πÑ‡∏ß‡πâ "‡∏Å‡πà‡∏≠‡∏ô" ‡∏õ‡∏∏‡πà‡∏° Import ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Template ‚Üí Import
      const importBtn = app.querySelector('#cbsplifeImport');
      if (importBtn && importBtn.nextSibling && importBtn.nextSibling.nodeName === 'BUTTON') {
        toolbar.insertBefore(btnTpl, importBtn.nextSibling); // ‡∏ß‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Import ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
      } else {
        toolbar.appendChild(btnTpl);
      }
    } catch (err) {
      console.error('CBSPLIFE Template UI init failed:', err);
    }
  });

  // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï CSV
  function downloadCBSPLIFETemplate() {
    // header ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏°‡∏õ‡πÉ‡∏ô normalizeRows
    const headers = [
      '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',      // DDMMYYYY
      'Customer Name',
      'Ref1',                 // ‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠
      'Ref2',                 // ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô
      'Branch Code',
      'Amount'                // THB
    ];

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á)
    const sample = [
      '10112025',
      'QA SPLifeFile',
      '8068000095',
      '2746506702371',
      '1007',
      '500.00'
    ];

    const csv = toCSV([headers, sample]);
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'CBSPLIFE_template.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function toCSV(rows) {
    return rows
      .map(cols => cols.map(escapeCSV).join(','))
      .join('\r\n');
  }

  function escapeCSV(v) {
    const s = String(v ?? '');
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ " ‡πÅ‡∏•‡∏∞ escape ""
    if (/[",\r\n]/.test(s)) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }
})();

/* ================== PATCH: Robust CSV importer for CBSPLIFE ==================
   - ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞ parser/normalizer/handleFile ‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô Import
   - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ "..." , BOM, ; , \t
   - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ header ‡∏à‡∏∞ map ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå [date,name,ref1,ref2,branch,amount]
   - ‡πÑ‡∏°‡πà‡∏•‡∏ö/‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ logic ‡∏≠‡∏∑‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å CBSPLIFE.addRow() ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
==============================================================================*/
(function () {
  if (!window.CBSPLIFE) return;
  const NS = window.CBSPLIFE;

  // ---------- Utils ----------
  const stripBOM = (s) => s.replace(/^\uFEFF/, '');
  const trimQuotes = (s) => {
    s = String(s ?? '');
    if (s.length >= 2 && s[0] === '"' && s[s.length - 1] === '"') {
      return s.slice(1, -1).replace(/""/g, '"').trim();
    }
    return s.trim();
  };
  const detectDelim = (line) => {
    const cand = [',', ';', '\t'];
    let best = ',', max = -1;
    for (const d of cand) {
      const c = (line.match(new RegExp(escapeReg(d), 'g')) || []).length;
      if (c > max) { max = c; best = d; }
    }
    return best;
  };
  function escapeReg(ch){ return ch === '\t' ? '\\t' : ch.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

  // CSV to array-of-arrays (handles quotes/newlines correctly)
  function csvToRows(text) {
    text = stripBOM(text);
    const firstLine = (text.split(/\r?\n/)[0] ?? '');
    const delim = detectDelim(firstLine);

    const rows = [];
    let cur = [], field = '', inQuotes = false, i = 0;

    while (i < text.length) {
      const ch = text[i];

      if (ch === '"') {
        if (!inQuotes) { inQuotes = true; i++; continue; }
        // inside quotes
        if (text[i + 1] === '"') { field += '"'; i += 2; continue; } // escaped ""
        inQuotes = false; i++; continue; // closing quote
      }

      if (!inQuotes && ch === delim) {
        cur.push(trimQuotes(field)); field = ''; i++; continue;
      }
      if (!inQuotes && (ch === '\n' || (ch === '\r' && text[i + 1] !== '\n'))) {
        cur.push(trimQuotes(field)); field = '';
        // push row if not empty (or allow empty but most tools put blank last line)
        if (cur.some(v => String(v).length > 0)) rows.push(cur);
        cur = [];
        i++; continue;
      }
      if (!inQuotes && ch === '\r' && text[i + 1] === '\n') {
        cur.push(trimQuotes(field)); field = '';
        if (cur.some(v => String(v).length > 0)) rows.push(cur);
        cur = [];
        i += 2; continue;
      }

      field += ch; i++;
    }
    // tail
    if (field.length > 0 || cur.length > 0) {
      cur.push(trimQuotes(field));
      if (cur.some(v => String(v).length > 0)) rows.push(cur);
    }
    return rows;
  }

  // map arrays -> objects using header (if present) or positional fallback
  function rowsToObjects(rows) {
    if (!rows.length) return [];

    // header detection: if any cell in first row has letters/Thai ‚Üí treat as header
    const looksHeader = rows[0].some(c => /[A-Za-z‡∏Å-‡∏Æ]/.test(String(c)));
    if (!looksHeader) {
      // positional fallback
      return rows.map(r => ({
        date:   r[0] ?? '',
        name:   r[1] ?? '',
        ref1:   r[2] ?? '',
        ref2:   r[3] ?? '',
        branch: r[4] ?? '',
        amount: r[5] ?? ''
      }));
    }

    // header-map
    const header = rows[0].map(h => normalizeKey(h));
    const data = rows.slice(1);
    return data.map(r => {
      const obj = {};
      header.forEach((h, idx) => obj[h.original || h.key || (`col${idx}`)] = r[idx] ?? '');
      // pick by synonyms
      return {
        date:   pickBySynonym(obj, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','ddmmyyyy','date','txn date','txn_date','post date','postdate']),
        name:   pickBySynonym(obj, ['customer name','customer','account name','‡∏ä‡∏∑‡πà‡∏≠','‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢']),
        ref1:   pickBySynonym(obj, ['ref1','‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠','ref','ref 1']),
        ref2:   pickBySynonym(obj, ['ref2','‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','id','id card','‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','ref 2']),
        branch: pickBySynonym(obj, ['branch code','‡∏™‡∏≤‡∏Ç‡∏≤','branch']),
        amount: pickBySynonym(obj, ['amount','amount thb','‡∏¢‡∏≠‡∏î','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô']),
      };
    });
  }

  function normalizeKey(k) {
    const s = String(k || '')
      .replace(/^\uFEFF/, '')
      .toLowerCase()
      .replace(/\s+/g, ' ')
      .replace(/\./g, '')
      .replace(/\(.*?\)/g, '')
      .trim();
    return { key: s, original: String(k||'').trim() };
  }
  function pickBySynonym(obj, names) {
    const keys = Object.keys(obj);
    const norm = (s)=> String(s||'').toLowerCase().replace(/\s+/g,' ').replace(/\./g,'').replace(/\(.*?\)/g,'').trim();
    for (const n of names) {
      for (const k of keys) if (norm(k) === norm(n)) return obj[k];
    }
    for (const n of names) {
      for (const k of keys) if (norm(k).includes(norm(n))) return obj[k];
    }
    return '';
  }

  // date/money helpers (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏õ‡∏•‡∏Å ‡πÜ)
  function toDDMMYYYY(v) {
    if (!v) return '';
    const s = String(v).trim();
    if (/^\d{8}$/.test(s)) return s;
    const m = s.match(/(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})/);
    if (m) {
      let [_, a, b, c] = m; a=+a; b=+b; c=+c;
      let dd, mm, yyyy;
      if (a > 31) { yyyy=a; mm=b; dd=c; }
      else if (c > 31) { dd=a; mm=b; yyyy=c; }
      else { dd=a; mm=b; yyyy=(c<100?2000+c:c); }
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`;
    }
    const m2 = s.match(/^(\d{1,2})\s(\d{1,2})\s(\d{2,4})$/);
    if (m2) {
      const dd=+m2[1], mm=+m2[2], y=m2[3]; const yyyy = +y + (y.length===2?2000:0);
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`;
    }
    return s.replace(/\D/g,'').slice(0,8);
  }
  function toMoney(v) {
    const n = Number(String(v).replace(/[^0-9.\-]/g,''));
    return isFinite(n) ? n.toFixed(2) : '';
  }

  // ---------- override handleFile ----------
  NS.handleFile = async function(file){
    if(!file) return;
    try{
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      let objs = [];

      if (['csv','tsv','txt'].includes(ext)) {
        const text = await file.text();
        const rows = csvToRows(text);
        objs = rowsToObjects(rows);
      } else if (ext === 'json') {
        const text = await file.text();
        const data = JSON.parse(text);
        const arr = Array.isArray(data) ? data : (data.rows || []);
        // ‡∏ñ‡πâ‡∏≤ JSON ‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á object ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡πá normalize ‡∏ï‡∏£‡∏á ‡πÜ
        objs = arr.map(o => ({
          date:   o.date   ?? o['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'] ?? o.ddmmyyyy ?? '',
          name:   o.name   ?? o['Customer Name'] ?? '',
          ref1:   o.ref1   ?? o['Ref1'] ?? o['Ref 1'] ?? '',
          ref2:   o.ref2   ?? o['Ref2'] ?? o['Ref 2'] ?? '',
          branch: o.branch ?? o['Branch Code'] ?? '',
          amount: o.amount ?? o['Amount'] ?? o['Amount (THB)'] ?? ''
        }));
      } else if (ext === 'xlsx') {
        if (typeof XLSX === 'undefined') {
          alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ SheetJS (XLSX) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô .xlsx\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô .csv ‡πÅ‡∏•‡πâ‡∏ß import ‡πÅ‡∏ó‡∏ô');
          return;
        }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:''}); // array-of-arrays
        objs = rowsToObjects(aoa);
      } else {
        alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö');
        return;
      }

      // final normalize
      const normalized = objs.map(r => ({
        date:   toDDMMYYYY(r.date),
        name:   String(r.name ?? '').trim(),
        ref1:   String(r.ref1 ?? '').trim(),
        ref2:   String(r.ref2 ?? '').trim(),
        branch: String(r.branch ?? '').trim(),
        amount: toMoney(r.amount)
      })).filter(r => (r.date||r.name||r.ref1||r.ref2||r.branch||r.amount));

      if (!normalized.length) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏°‡∏õ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå');
        return;
      }

      // append ‡πÅ‡∏ñ‡∏ß (‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
      const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
      normalized.forEach(r => {
        if (typeof NS.addRow === 'function') NS.addRow();
        const lastRow = tbody.querySelector('tr:last-child');
        if (!lastRow) return;
        (lastRow.querySelector('.postdate_CBSPLIFE')   || {}).value = r.date;
        (lastRow.querySelector('.accname_CBSPLIFE')    || {}).value = r.name;
        (lastRow.querySelector('.refno_CBSPLIFE')      || {}).value = r.ref1;
        (lastRow.querySelector('.idcard_CBSPLIFE')     || {}).value = r.ref2;
        (lastRow.querySelector('.branchcode_CBSPLIFE') || {}).value = r.branch;
        (lastRow.querySelector('.amount_CBSPLIFE')     || {}).value = r.amount;
      });

      toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${normalized.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }catch(err){
      console.error(err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå');
    }
  };

  // mini toast (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#1f2937',color:'#fff',padding:'8px 14px',borderRadius:'8px',fontSize:'14px',zIndex:9999,boxShadow:'0 4px 12px rgba(0,0,0,.2)'});
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; },1200);
    setTimeout(()=> t.remove(), 1700);
  }
})();
/* ===== PATCH: populateTable ‚Äì append ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡πâ‡∏≤‡∏á row ‡∏ï‡∏≤‡∏° index (‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°) ===== */
(function () {
  if (!window.CBSPLIFE) return;
  const NS = window.CBSPLIFE;

  // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà populateTable ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏â‡∏µ‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î index ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
  function populateTableFixed(rows) {
    const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
    if (!tbody || !rows?.length) return;

    // 1) ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
    const start = tbody.querySelectorAll('tr').length;

    // 2) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö n ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏Å addRow() ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏á logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    if (typeof NS.addRow === 'function') {
      for (let i = 0; i < rows.length; i++) NS.addRow();
    }

    // 3) ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà start + 1)
    rows.forEach((r, i) => {
      const row = tbody.querySelector(`tr:nth-child(${start + i + 1})`);
      if (!row) return;
      const el = (sel) => row.querySelector(sel);

      const iDate   = el('.postdate_CBSPLIFE');
      const iName   = el('.accname_CBSPLIFE');
      const iRef1   = el('.refno_CBSPLIFE');
      const iRef2   = el('.idcard_CBSPLIFE');
      const iBranch = el('.branchcode_CBSPLIFE');
      const iAmt    = el('.amount_CBSPLIFE');

      if (iDate)   iDate.value   = r.date   ?? '';
      if (iName)   iName.value   = r.name   ?? '';
      if (iRef1)   iRef1.value   = r.ref1   ?? '';
      if (iRef2)   iRef2.value   = r.ref2   ?? '';
      if (iBranch) iBranch.value = r.branch ?? '';
      if (iAmt)    iAmt.value    = r.amount ?? '';
    });
  }

  // ‡∏ú‡∏π‡∏Å‡∏ó‡∏±‡∏ö populateTable ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô Import ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ)
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ expose ‡πÑ‡∏ß‡πâ‡∏ö‡∏ô namespace ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö handleFile
  NS.__populateTableFixed = populateTableFixed;

  // ‡∏ñ‡πâ‡∏≤‡∏ù‡∏±‡πà‡∏á import ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠ populateTable (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ) ‡∏Å‡πá‡∏™‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ä‡∏µ‡πâ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‚Äî‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÉ‡∏´‡πâ overwrite ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ reference
    const importExt = window; // scope ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô IIFE; ‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á alias ‡πÉ‡∏ô namespace
    if (NS.populateTable) NS.populateTable = populateTableFixed;
  } catch (e) {
    /* no-op */
  }

  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ handleFile ‡∏Ç‡∏≠‡∏á‡πÅ‡∏û‡∏ï‡∏ä‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å populateTable() ‡πÅ‡∏ö‡∏ö local-scope
  // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ monkey-patch ‡∏ú‡πà‡∏≤‡∏ô window.CBSPLIFE.handleFile ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß
  if (typeof NS.handleFile === 'function' && !NS.__patched_multi_row) {
    const orig = NS.handleFile;
    NS.handleFile = async function(file){
      // ‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ parse ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà intercept ‚Äò‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß‚Äô
      // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏î‡∏±‡∏Å‡∏î‡πâ‡∏ß‡∏¢ event ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      const pushRows = [];
      // hook ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß: ‡πÉ‡∏´‡πâ orig ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÅ‡∏ó‡∏ô populateTable (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å)
      // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢: ‡πÉ‡∏™‡πà bridge ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô namespace ‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
      NS.__collectRows = (arr) => { if (Array.isArray(arr)) pushRows.push(...arr); };

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥
      await orig.apply(this, arguments);

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ collect ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡∏°‡πà
      if (pushRows.length) {
        populateTableFixed(pushRows);
      }
    };
    NS.__patched_multi_row = true;
  }
})();
/* ==== FIX: ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° index (‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°) ==== */
(function () {
  if (!window.CBSPLIFE) return;
  const NS = window.CBSPLIFE;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ addRow() ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  function ensureRows(tbody, targetCount) {
    const have = tbody.querySelectorAll('tr').length;
    if (typeof NS.addRow === 'function') {
      for (let i = have; i < targetCount; i++) NS.addRow();
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á index (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ :last-child)
  function fillRows(tbody, startIndex, rows) {
    rows.forEach((r, i) => {
      const row = tbody.querySelector(`tr:nth-child(${startIndex + i + 1})`);
      if (!row) return;
      const q = (sel) => row.querySelector(sel);

      const iDate   = q('.postdate_CBSPLIFE');
      const iName   = q('.accname_CBSPLIFE');
      const iRef1   = q('.refno_CBSPLIFE');
      const iRef2   = q('.idcard_CBSPLIFE');
      const iBranch = q('.branchcode_CBSPLIFE');
      const iAmt    = q('.amount_CBSPLIFE');

      if (iDate)   iDate.value   = r.date   ?? '';
      if (iName)   iName.value   = r.name   ?? '';
      if (iRef1)   iRef1.value   = r.ref1   ?? '';
      if (iRef2)   iRef2.value   = r.ref2   ?? '';
      if (iBranch) iBranch.value = r.branch ?? '';
      if (iAmt)    iAmt.value    = r.amount ?? '';
    });
  }

  // --- ‡∏™‡∏≠‡∏î‡πÅ‡∏ó‡∏£‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤ flow ‡∏Ç‡∏≠‡∏á handleFile ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ ---
  // ‡∏ñ‡πâ‡∏≤ handleFile ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà ‡πÄ‡∏£‡∏≤‡∏à‡∏∞ wrap ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á "‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß" ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏ß‡∏£‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏ö
  if (typeof NS.handleFile === 'function' && !NS.__fix_row_append) {
    const origHandle = NS.handleFile;

    NS.handleFile = async function (file) {
      // ‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° parse/normalize ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞ intercept ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      // ‡∏ó‡∏≥‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏á‡πà‡∏≤‡∏¢: ‡πÄ‡∏Å‡πá‡∏ö normalized ‡∏ä‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÉ‡∏ô namespace ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á
      let normalizedCaptured = null;

      // hook ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î import ‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á normalized ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤
      NS.__collectRows = (arr) => { normalizedCaptured = Array.isArray(arr) ? arr.slice() : null; };

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡∏ã‡∏∂‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏õ parse ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏Å populateTable/‡∏Ø‡∏•‡∏Ø ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)
      await origHandle.apply(this, arguments);

      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á normalized ‡∏°‡∏≤‡∏´‡∏≤‡πÄ‡∏£‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ä‡πâ (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å populateTable(normalized))
      // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å __collectRows ‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏Å‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å populateTable(normalized):
      //   if (window.CBSPLIFE && CBSPLIFE.__collectRows) CBSPLIFE.__collectRows(normalized);
      // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢
      const rows = normalizedCaptured;
      if (!rows || !rows.length) return;

      const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
      if (!tbody) return;

      const start = tbody.querySelectorAll('tr').length; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
      ensureRows(tbody, start + rows.length);
      fillRows(tbody, start, rows);
    };

    NS.__fix_row_append = true;
  }
})();
/* ================== CBSPLIFE Import ‚Äî FINAL drop-in ==================
   ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞ window.CBSPLIFE.handleFile ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß
   ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV/TSV/TXT/JSON ‡πÅ‡∏•‡∏∞ XLSX (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ window.XLSX)
   ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ CBSPLIFE.addRow() ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°
======================================================================*/
(function () {
  if (!window.CBSPLIFE) return;
  const NS = window.CBSPLIFE;

  // ---------- CSV utils (robust for LibreOffice/Excel) ----------
  const stripBOM = (s) => s.replace(/^\uFEFF/, "");
  const trimQuotes = (s) => {
    s = String(s ?? "");
    if (s.length >= 2 && s[0] === '"' && s[s.length - 1] === '"')
      return s.slice(1, -1).replace(/""/g, '"');
    return s;
  };
  const detectDelim = (firstLine) => {
    const cand = [",", ";", "\t"];
    let best = ",", max = -1;
    for (const d of cand) {
      const c = (firstLine.match(new RegExp(d === "\t" ? "\\t" : d, "g")) || []).length;
      if (c > max) { max = c; best = d; }
    }
    return best;
  };
  function csvToRows(text) {
    text = stripBOM(text);
    const delim = detectDelim(text.split(/\r?\n/)[0] || ",");
    const rows = [];
    let cur = [], field = "", inQ = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      if (ch === '"') {
        if (!inQ) { inQ = true; continue; }
        if (text[i + 1] === '"') { field += '"'; i++; continue; }
        inQ = false; continue;
      }
      if (!inQ && ch === delim) { cur.push(trimQuotes(field).trim()); field = ""; continue; }
      if (!inQ && ch === "\r" && text[i + 1] === "\n") {
        cur.push(trimQuotes(field).trim()); field = "";
        if (cur.some(v => String(v).length)) rows.push(cur); cur = []; i++; continue;
      }
      if (!inQ && (ch === "\n" || ch === "\r")) {
        cur.push(trimQuotes(field).trim()); field = "";
        if (cur.some(v => String(v).length)) rows.push(cur); cur = []; continue;
      }
      field += ch;
    }
    if (field.length || cur.length) { cur.push(trimQuotes(field).trim()); if (cur.some(v => String(v).length)) rows.push(cur); }
    return rows;
  }

  // map header or position -> objects
  function rowsToObjects(rows) {
    if (!rows.length) return [];
    const looksHeader = rows[0].some(c => /[A-Za-z‡∏Å-‡∏Æ]/.test(String(c)));
    if (!looksHeader) {
      return rows.map(r => ({
        date:   r[0] ?? "", name: r[1] ?? "", ref1: r[2] ?? "",
        ref2:   r[3] ?? "", branch: r[4] ?? "", amount: r[5] ?? ""
      }));
    }
    const header = rows[0].map(h => norm(h));
    const data = rows.slice(1);
    return data.map(r => {
      const obj = {};
      header.forEach((h,i)=> obj[h] = r[i] ?? "");
      return {
        date:   pick(obj, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','ddmmyyyy','date','txn date','txn_date','post date','postdate']),
        name:   pick(obj, ['customer name','customer','account name','‡∏ä‡∏∑‡πà‡∏≠','‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢']),
        ref1:   pick(obj, ['ref1','‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠','ref','ref 1']),
        ref2:   pick(obj, ['ref2','‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','id','id card','‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','ref 2']),
        branch: pick(obj, ['branch code','‡∏™‡∏≤‡∏Ç‡∏≤','branch']),
        amount: pick(obj, ['amount','amount thb','‡∏¢‡∏≠‡∏î','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô']),
      };
    });
  }
  const norm = (s)=> String(s||'').replace(/^\uFEFF/,'').toLowerCase().replace(/\s+/g,' ').replace(/\(.*?\)/g,'').replace(/\./g,'').trim();
  function pick(obj, names) {
    for (const n of names) for (const k of Object.keys(obj)) if (norm(k)===norm(n)) return obj[k];
    for (const n of names) for (const k of Object.keys(obj)) if (norm(k).includes(norm(n))) return obj[k];
    return '';
  }

  // format helpers
  function toDDMMYYYY(v){
    if (!v) return '';
    const s = String(v).trim();
    if (/^\d{8}$/.test(s)) return s;
    const m = s.match(/(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})/);
    if (m){
      let [_,a,b,c]=m; a=+a; b=+b; c=+c;
      let dd,mm,yyyy;
      if (a>31){ yyyy=a; mm=b; dd=c; }
      else if (c>31){ dd=a; mm=b; yyyy=c; }
      else { dd=a; mm=b; yyyy=(c<100?2000+c:c); }
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`;
    }
    const m2 = s.match(/^(\d{1,2})\s(\d{1,2})\s(\d{2,4})$/);
    if (m2){
      const dd=+m2[1], mm=+m2[2], y=m2[3];
      const yyyy = +y + (y.length===2?2000:0);
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`;
    }
    return s.replace(/\D/g,'').slice(0,8);
  }
  function toMoney(v){
    const n = Number(String(v).replace(/[^0-9.\-]/g,''));
    return isFinite(n) ? n.toFixed(2) : '';
  }

  // ---------- THE ONLY THING WE OVERRIDE ----------
  NS.handleFile = async function(file){
    if(!file) return;
    try{
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      let records = [];

      if (['csv','tsv','txt'].includes(ext)) {
        const text = await file.text();
        records = rowsToObjects(csvToRows(text));
      } else if (ext === 'json') {
        const text = await file.text();
        const data = JSON.parse(text);
        const arr = Array.isArray(data) ? data : (data.rows || []);
        records = arr.map(o => ({
          date:o.date??o['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']??o.ddmmyyyy??'',
          name:o.name??o['Customer Name']??'',
          ref1:o.ref1??o['Ref1']??o['Ref 1']??'',
          ref2:o.ref2??o['Ref2']??o['Ref 2']??'',
          branch:o.branch??o['Branch Code']??'',
          amount:o.amount??o['Amount']??o['Amount (THB)']??''
        }));
      } else if (ext === 'xlsx') {
        if (typeof XLSX === 'undefined') { alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ SheetJS (XLSX) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô .xlsx\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô .csv ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡∏ô'); return; }
        const buf = await file.arrayBuffer();
        const ws = XLSX.read(buf, {type:'array'}).Sheets[XLSX.read(buf, {type:'array'}).SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
        records = rowsToObjects(aoa);
      } else {
        alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'); return;
      }

      // normalize + filter ‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á
      const normalized = records.map(r=>({
        date:   toDDMMYYYY(r.date),
        name:   String(r.name??'').trim(),
        ref1:   String(r.ref1??'').trim(),
        ref2:   String(r.ref2??'').trim(),
        branch: String(r.branch??'').trim(),
        amount: toMoney(r.amount)
      })).filter(r=> (r.date||r.name||r.ref1||r.ref2||r.branch||r.amount));

      if (!normalized.length){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'); return; }

      // ----- ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏ö‡∏ö index (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ :last-child) -----
      const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
      if (!tbody) return;

      // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°
      const start = tbody.querySelectorAll('tr').length;

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏°
      if (typeof NS.addRow === 'function'){
        for (let i=0;i<normalized.length;i++) NS.addRow();
      }

      // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ row-by-row
      normalized.forEach((r, i) => {
        const row = tbody.querySelector(`tr:nth-child(${start + i + 1})`);
        if (!row) return;
        const q = (sel)=> row.querySelector(sel);
        const iDate   = q('.postdate_CBSPLIFE');
        const iName   = q('.accname_CBSPLIFE');
        const iRef1   = q('.refno_CBSPLIFE');
        const iRef2   = q('.idcard_CBSPLIFE');
        const iBranch = q('.branchcode_CBSPLIFE');
        const iAmt    = q('.amount_CBSPLIFE');
        if (iDate)   iDate.value   = r.date;
        if (iName)   iName.value   = r.name;
        if (iRef1)   iRef1.value   = r.ref1;
        if (iRef2)   iRef2.value   = r.ref2;
        if (iBranch) iBranch.value = r.branch;
        if (iAmt)    iAmt.value    = r.amount;
      });

      miniToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${normalized.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }catch(err){
      console.error(err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå');
    }
  };

  function miniToast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#1f2937',color:'#fff',padding:'8px 14px',borderRadius:'8px',fontSize:'14px',zIndex:9999,boxShadow:'0 4px 12px rgba(0,0,0,.2)'});
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition='opacity .35s'; t.style.opacity='0'; },1200);
    setTimeout(()=> t.remove(), 1700);
  }
})();

/* ============ CBSPLIFE Import ‚Äî CLONE-ROW VERSION (Final) ============
   - ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞ CBSPLIFE.handleFile
   - ‡πÉ‡∏ä‡πâ addRow() ‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á ‚Äú‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÅ‡∏ñ‡∏ß‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏Ñ‡∏•‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°
   - ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏° index ‚Üí ‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏µ‡∏Å
   - ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV/TSV/TXT/JSON ‡πÅ‡∏•‡∏∞ XLSX (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ window.XLSX)
===================================================================== */
(function () {
  if (!window.CBSPLIFE) return;
  const NS = window.CBSPLIFE;

  // ---------- helpers (parse & normalize) ----------
  const stripBOM = (s) => s.replace(/^\uFEFF/, "");
  const normKey = (s)=> String(s||'').replace(/^\uFEFF/,'').toLowerCase().replace(/\s+/g,' ').replace(/\(.*?\)/g,'').replace(/\./g,'').trim();
  const trimQuotes = (s) => {
    s = String(s ?? "");
    if (s.length >= 2 && s[0] === '"' && s[s.length - 1] === '"') return s.slice(1, -1).replace(/""/g, '"');
    return s;
  };
  const detectDelim = (line) => {
    const cand = [",",";","\t"]; let best=",",max=-1;
    for (const d of cand){ const c=(line.match(new RegExp(d==="\t"?"\\t":d,"g"))||[]).length; if(c>max){max=c;best=d;} }
    return best;
  };
  function csvToRows(text){
    text = stripBOM(text);
    const delim = detectDelim(text.split(/\r?\n/)[0] || ",");
    const rows = []; let cur=[], field="", inQ=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch===`"`){ if(!inQ){inQ=true; continue;} if(text[i+1]==='"'){field+='"'; i++; continue;} inQ=false; continue; }
      if(!inQ && ch===delim){ cur.push(trimQuotes(field).trim()); field=""; continue; }
      if(!inQ && ch==="\r" && text[i+1]==="\n"){ cur.push(trimQuotes(field).trim()); field=""; if(cur.some(v=>String(v).length)) rows.push(cur); cur=[]; i++; continue; }
      if(!inQ && (ch==="\n"||ch==="\r")){ cur.push(trimQuotes(field).trim()); field=""; if(cur.some(v=>String(v).length)) rows.push(cur); cur=[]; continue; }
      field+=ch;
    }
    if(field.length || cur.length){ cur.push(trimQuotes(field).trim()); if(cur.some(v=>String(v).length)) rows.push(cur); }
    return rows;
  }
  function rowsToObjects(rows){
    if(!rows.length) return [];
    const looksHeader = rows[0].some(c => /[A-Za-z‡∏Å-‡∏Æ]/.test(String(c)));
    if(!looksHeader){
      return rows.map(r=>({date:r[0]??'', name:r[1]??'', ref1:r[2]??'', ref2:r[3]??'', branch:r[4]??'', amount:r[5]??''}));
    }
    const header = rows[0].map(normKey);
    const data = rows.slice(1);
    const pick = (obj, names)=>{
      for(const n of names) for(const k of Object.keys(obj)) if(normKey(k)===normKey(n)) return obj[k];
      for(const n of names) for(const k of Object.keys(obj)) if(normKey(k).includes(normKey(n))) return obj[k];
      return '';
    };
    return data.map(r=>{
      const obj={}; header.forEach((h,i)=> obj[h]=r[i]??'');
      return {
        date:   pick(obj, ['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','ddmmyyyy','date','txn date','txn_date','post date','postdate']),
        name:   pick(obj, ['customer name','customer','account name','‡∏ä‡∏∑‡πà‡∏≠','‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢']),
        ref1:   pick(obj, ['ref1','‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠','ref','ref 1']),
        ref2:   pick(obj, ['ref2','‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','id','id card','‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','ref 2']),
        branch: pick(obj, ['branch code','‡∏™‡∏≤‡∏Ç‡∏≤','branch']),
        amount: pick(obj, ['amount','amount thb','‡∏¢‡∏≠‡∏î','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô']),
      };
    });
  }
  function toDDMMYYYY(v){
    if(!v) return ''; const s=String(v).trim(); if(/^\d{8}$/.test(s)) return s;
    const m=s.match(/(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})/);
    if(m){ let [_,a,b,c]=m; a=+a; b=+b; c=+c; let dd,mm,yyyy;
      if(a>31){ yyyy=a; mm=b; dd=c; } else if(c>31){ dd=a; mm=b; yyyy=c; } else { dd=a; mm=b; yyyy=(c<100?2000+c:c); }
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`;
    }
    const m2=s.match(/^(\d{1,2})\s(\d{1,2})\s(\d{2,4})$/);
    if(m2){ const dd=+m2[1], mm=+m2[2], y=m2[3]; const yyyy=+y + (y.length===2?2000:0);
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`; }
    return s.replace(/\D/g,'').slice(0,8);
  }
  function toMoney(v){ const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(n)? n.toFixed(2):''; }

  // --------- OVERRIDE handleFile (clone-row approach) ----------
  NS.handleFile = async function(file){
    if(!file) return;
    try{
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      let recs = [];
      if(['csv','tsv','txt'].includes(ext)){
        const text = await file.text();
        recs = rowsToObjects(csvToRows(text));
      }else if(ext==='json'){
        const text = await file.text();
        const data = JSON.parse(text);
        const arr = Array.isArray(data)? data : (data.rows||[]);
        recs = arr.map(o=>({ date:o.date??o['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']??o.ddmmyyyy??'', name:o.name??o['Customer Name']??'',
                              ref1:o.ref1??o['Ref1']??o['Ref 1']??'', ref2:o.ref2??o['Ref2']??o['Ref 2']??'',
                              branch:o.branch??o['Branch Code']??'', amount:o.amount??o['Amount']??o['Amount (THB)']??'' }));
      }else if(ext==='xlsx'){
        if(typeof XLSX==='undefined'){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ SheetJS (XLSX) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô .xlsx\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô .csv ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡∏ô'); return; }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
        const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
        recs = rowsToObjects(aoa);
      }else{ alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'); return; }

      // normalize
      const rows = recs.map(r=>({
        date:   toDDMMYYYY(r.date),
        name:   String(r.name??'').trim(),
        ref1:   String(r.ref1??'').trim(),
        ref2:   String(r.ref2??'').trim(),
        branch: String(r.branch??'').trim(),
        amount: toMoney(r.amount)
      })).filter(r=> (r.date||r.name||r.ref1||r.ref2||r.branch||r.amount));

      if(!rows.length){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'); return; }

      const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
      if(!tbody) return;

      // ----- ‡∏™‡∏£‡πâ‡∏≤‡∏á ‚Äú‡πÅ‡∏ñ‡∏ß‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‚Äù ‡∏à‡∏≤‡∏Å addRow() ‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏Ñ‡∏•‡∏ô -----
      // 1) ‡∏™‡∏£‡πâ‡∏≤‡∏á 1 ‡πÅ‡∏ñ‡∏ß‡∏î‡πâ‡∏ß‡∏¢ addRow() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
      const before = Array.from(tbody.children);
      if (typeof NS.addRow === 'function') NS.addRow();

      // 2) ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏û‡∏∂‡πà‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° (templateRow) ‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
      const after = Array.from(tbody.children);
      const templateRow = after.find(tr => !before.includes(tr));
      if (!templateRow) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
      tbody.removeChild(templateRow); // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏∞‡πÇ‡∏Ñ‡∏•‡∏ô‡πÉ‡∏™‡πà‡∏Å‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡∏Å‡πá‡πÑ‡∏î‡πâ

      // 3) ‡πÇ‡∏Ñ‡∏•‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡πÄ‡∏ó‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô rows ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏° index
      const frag = document.createDocumentFragment();
      rows.forEach((r)=>{
        const row = templateRow.cloneNode(true);
        const q = (sel)=> row.querySelector(sel);
        (q('.postdate_CBSPLIFE')   || {}).value = r.date;
        (q('.accname_CBSPLIFE')    || {}).value = r.name;
        (q('.refno_CBSPLIFE')      || {}).value = r.ref1;
        (q('.idcard_CBSPLIFE')     || {}).value = r.ref2;
        (q('.branchcode_CBSPLIFE') || {}).value = r.branch;
        (q('.amount_CBSPLIFE')     || {}).value = r.amount;
        frag.appendChild(row);
      });
      tbody.appendChild(frag);

      miniToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${rows.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }catch(err){
      console.error(err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå');
    }
  };

  function miniToast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#1f2937',color:'#fff',padding:'8px 14px',borderRadius:'8px',fontSize:'14px',zIndex:9999,boxShadow:'0 4px 12px rgba(0,0,0,.2)'});
    document.body.appendChild(t);
    setTimeout(()=>{t.style.transition='opacity .35s'; t.style.opacity='0';},1200);
    setTimeout(()=>t.remove(),1700);
  }
})();

/* ========== CBSPLIFE Import ‚Äî Use-first-row template (Final fix) ========== */
(function () {
  if (!window.CBSPLIFE) return;
  const NS = window.CBSPLIFE;

  // --- helpers: parse/normalize ---
  const stripBOM = s => s.replace(/^\uFEFF/, "");
  const norm = s => String(s||'').replace(/^\uFEFF/,'').toLowerCase().replace(/\s+/g,' ').replace(/\(.*?\)/g,'').replace(/\./g,'').trim();
  const trimQ = s => { s=String(s??''); return (s[0]==='"'&&s.slice(-1)==='"') ? s.slice(1,-1).replace(/""/g,'"') : s; };
  const detectDelim = line => { const cand=[',',';','\t']; let best=',',max=-1; for(const d of cand){const c=(line.match(new RegExp(d==='\t'?'\\t':d,'g'))||[]).length; if(c>max){max=c;best=d;}} return best; };

  function csvToRows(text){
    text = stripBOM(text);
    const delim = detectDelim(text.split(/\r?\n/)[0]||',');
    const rows=[], cur=[]; let field="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch === '"'){ if(!inQ){inQ=true;continue;} if(text[i+1]==='"'){field+='"'; i++; continue;} inQ=false; continue; }
      if(!inQ && ch===delim){ cur.push(trimQ(field).trim()); field=""; continue; }
      if(!inQ && ch==="\r" && text[i+1]==="\n"){ cur.push(trimQ(field).trim()); field=""; if(cur.some(v=>String(v).length)) rows.push(cur.slice()); cur.length=0; i++; continue; }
      if(!inQ && (ch==="\n"||ch==="\r")){ cur.push(trimQ(field).trim()); field=""; if(cur.some(v=>String(v).length)) rows.push(cur.slice()); cur.length=0; continue; }
      field+=ch;
    }
    if(field.length||cur.length){ cur.push(trimQ(field).trim()); if(cur.some(v=>String(v).length)) rows.push(cur.slice()); }
    return rows;
  }
  function rowsToObjects(rows){
    if(!rows.length) return [];
    const looksHeader = rows[0].some(c => /[A-Za-z‡∏Å-‡∏Æ]/.test(String(c)));
    if(!looksHeader){
      return rows.map(r=>({date:r[0]??'',name:r[1]??'',ref1:r[2]??'',ref2:r[3]??'',branch:r[4]??'',amount:r[5]??''}));
    }
    const header = rows[0].map(norm);
    const data = rows.slice(1);
    const pick = (obj, names)=>{
      for(const n of names) for(const k of Object.keys(obj)) if(norm(k)===norm(n)) return obj[k];
      for(const n of names) for(const k of Object.keys(obj)) if(norm(k).includes(norm(n))) return obj[k];
      return '';
    };
    return data.map(r=>{
      const obj={}; header.forEach((h,i)=> obj[h]=r[i]??'');
      return {
        date:   pick(obj,['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£','ddmmyyyy','date','txn date','txn_date','post date','postdate']),
        name:   pick(obj,['customer name','customer','account name','‡∏ä‡∏∑‡πà‡∏≠','‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢']),
        ref1:   pick(obj,['ref1','‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠','ref','ref 1']),
        ref2:   pick(obj,['ref2','‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','id','id card','‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','ref 2']),
        branch: pick(obj,['branch code','‡∏™‡∏≤‡∏Ç‡∏≤','branch']),
        amount: pick(obj,['amount','amount thb','‡∏¢‡∏≠‡∏î','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô']),
      };
    });
  }
  function toDDMMYYYY(v){
    if(!v) return ''; const s=String(v).trim(); if(/^\d{8}$/.test(s)) return s;
    const m=s.match(/(\d{1,4})[\/\-](\d{1,2})[\/\-](\d{1,4})/);
    if(m){ let [_,a,b,c]=m; a=+a;b=+b;c=+c; let dd,mm,yyyy;
      if(a>31){ yyyy=a;mm=b;dd=c; } else if(c>31){ dd=a;mm=b;yyyy=c; } else { dd=a;mm=b;yyyy=(c<100?2000+c:c); }
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`;
    }
    const m2=s.match(/^(\d{1,2})\s(\d{1,2})\s(\d{2,4})$/);
    if(m2){ const dd=+m2[1],mm=+m2[2],y=m2[3]; const yyyy=+y+(y.length===2?2000:0);
      return `${String(dd).padStart(2,'0')}${String(mm).padStart(2,'0')}${String(yyyy).padStart(4,'0')}`; }
    return s.replace(/\D/g,'').slice(0,8);
  }
  const toMoney = v => { const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(n)? n.toFixed(2):''; };

  // ----- OVERRIDE handleFile: ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô template ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏Ñ‡∏•‡∏ô -----
  NS.handleFile = async function(file){
    if(!file) return;
    try{
      const ext = (file.name.split('.').pop()||'').toLowerCase();
      let recs = [];
      if(['csv','tsv','txt'].includes(ext)){
        recs = rowsToObjects(csvToRows(await file.text()));
      }else if(ext==='json'){
        const data = JSON.parse(await file.text());
        const arr = Array.isArray(data)? data : (data.rows||[]);
        recs = arr.map(o=>({date:o.date??o['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£']??o.ddmmyyyy??'',name:o.name??o['Customer Name']??'',
                             ref1:o.ref1??o['Ref1']??o['Ref 1']??'',ref2:o.ref2??o['Ref2']??o['Ref 2']??'',
                             branch:o.branch??o['Branch Code']??'',amount:o.amount??o['Amount']??o['Amount (THB)']??''}));
      }else if(ext==='xlsx'){
        if(typeof XLSX==='undefined'){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ SheetJS (XLSX) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô .xlsx\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô .csv ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡∏ô'); return; }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
        recs = rowsToObjects(XLSX.utils.sheet_to_json(ws,{header:1,defval:''}));
      }else{ alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'); return; }

      const items = recs.map(r=>({
        date:toDDMMYYYY(r.date), name:String(r.name??'').trim(),
        ref1:String(r.ref1??'').trim(), ref2:String(r.ref2??'').trim(),
        branch:String(r.branch??'').trim(), amount:toMoney(r.amount)
      })).filter(r=> (r.date||r.name||r.ref1||r.ref2||r.branch||r.amount));

      if(!items.length){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'); return; }

      const tbody = document.querySelector('#detailTable_CBSPLIFE tbody');
      if(!tbody) return;

      // 1) ‡∏´‡∏≤ template row: ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô addRow 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      if (tbody.children.length === 0 && typeof NS.addRow === 'function') NS.addRow();
      const firstRow = tbody.querySelector('tr'); // ‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
      if (!firstRow) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }

      // 2) helper set values
      const setVals = (row, r) => {
        const q = sel => row.querySelector(sel);
        (q('.postdate_CBSPLIFE')   || {}).value = r.date;
        (q('.accname_CBSPLIFE')    || {}).value = r.name;
        (q('.refno_CBSPLIFE')      || {}).value = r.ref1;
        (q('.idcard_CBSPLIFE')     || {}).value = r.ref2;
        (q('.branchcode_CBSPLIFE') || {}).value = r.branch;
        (q('.amount_CBSPLIFE')     || {}).value = r.amount;
      };

      // 3) ‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏£‡∏Å
      setVals(firstRow, items[0]);

      // 4) ‡πÇ‡∏Ñ‡∏•‡∏ô template ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏£‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
      if (items.length > 1) {
        const tpl = firstRow.cloneNode(true);
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô template (‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏ã‡πâ‡∏≥‡∏ï‡∏¥‡∏î‡∏°‡∏≤)
        tpl.querySelectorAll('input,select,textarea').forEach(el => { if('value' in el) el.value=''; });

        const frag = document.createDocumentFragment();
        for (let i = 1; i < items.length; i++) {
          const row = tpl.cloneNode(true);
          setVals(row, items[i]);
          frag.appendChild(row);
        }
        tbody.appendChild(frag);
      }

      toast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${items.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }catch(err){
      console.error(err);
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå');
    }
  };

  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#1f2937',color:'#fff',padding:'8px 14px',borderRadius:'8px',fontSize:'14px',zIndex:9999,boxShadow:'0 4px 12px rgba(0,0,0,.2)'});
    document.body.appendChild(t);
    setTimeout(()=>{t.style.transition='opacity .35s'; t.style.opacity='0';},1200);
    setTimeout(()=> t.remove(),1700);
  }
})();
/* ==========================================================
  OL52 & OL55 ‚Äî Template + Import (CSV/TSV/TXT/JSON, XLSX-if-available)
  - ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ inject ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ toolbar ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ section
  - ‡πÉ‡∏ä‡πâ "‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï" ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏Ñ‡∏•‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö/‡∏ä‡∏ô addRow ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
  - Header ‡∏Ç‡∏≠‡∏á OL52/OL55 ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô:
    Customer Acc No, Txn Code, Amount, Service Type, Status, Ref no, ID Card,
    Branch Code, Branch Name, POST DATE (DDMMYY), Account Name
========================================================== */
(function(){
  // ===== Utilities shared =====
  const stripBOM = s => String(s||'').replace(/^\uFEFF/,'');
  const norm = s => stripBOM(s).toLowerCase().replace(/\s+/g,' ')
                  .replace(/\(.*?\)/g,'').replace(/\./g,'').trim();
  const trimQ = s => { s=String(s??''); return (s[0]==='"'&&s.slice(-1)==='"') ? s.slice(1,-1).replace(/""/g,'"') : s; };
  const detectDelim = line => {
    const cand=[',',';','\t']; let best=',', max=-1;
    for(const d of cand){const c=(line.match(new RegExp(d==='\t'?'\\t':d,'g'))||[]).length; if(c>max){max=c;best=d;}}
    return best;
  };
  function csvToRows(text){
    text = stripBOM(text);
    const delim = detectDelim(text.split(/\r?\n/)[0]||',');
    const rows=[]; let cur=[], field='', inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(ch==='"'){ if(!inQ){inQ=true;continue;} if(text[i+1]==='"'){field+='"'; i++; continue;} inQ=false; continue; }
      if(!inQ && ch===delim){ cur.push(trimQ(field).trim()); field=''; continue; }
      if(!inQ && ch==='\r' && text[i+1]==='\n'){ cur.push(trimQ(field).trim()); field=''; if(cur.some(v=>String(v).length)) rows.push(cur.slice()); cur.length=0; i++; continue; }
      if(!inQ && (ch==='\n'||ch==='\r')){ cur.push(trimQ(field).trim()); field=''; if(cur.some(v=>String(v).length)) rows.push(cur.slice()); cur.length=0; continue; }
      field+=ch;
    }
    if(field.length||cur.length){ cur.push(trimQ(field).trim()); if(cur.some(v=>String(v).length)) rows.push(cur.slice()); }
    return rows;
  }
  function rowsToObjects(rows){
    if(!rows.length) return [];
    const looksHeader = rows[0].some(c => /[A-Za-z‡∏Å-‡∏Æ]/.test(String(c)));
    const header = looksHeader ? rows[0].map(norm) : null;
    const data   = looksHeader ? rows.slice(1) : rows;
    const mapByPos = r => ({
      custAcc: r[0]??'', txnCode: r[1]??'', amount: r[2]??'',
      service: r[3]??'', status: r[4]??'', refno: r[5]??'',
      idcard : r[6]??'', brCode: r[7]??'', brName: r[8]??'',
      postDD : r[9]??'', accName: r[10]??''
    });
    if(!header) return data.map(mapByPos);

    const pick = (obj, names) => {
      for(const n of names) for(const k of Object.keys(obj)) if(norm(k)===norm(n)) return obj[k];
      for(const n of names) for(const k of Object.keys(obj)) if(norm(k).includes(norm(n))) return obj[k];
      return '';
    };
    return data.map(r=>{
      const obj={}; header.forEach((h,i)=> obj[h]=r[i]??'');
      return {
        custAcc: pick(obj,['customer acc no','account no','‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤']),
        txnCode: pick(obj,['txn code','c/d','txn']),
        amount : pick(obj,['amount','amount thb','‡∏¢‡∏≠‡∏î','‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô']),
        service: pick(obj,['service type','service','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£']),
        status : pick(obj,['status','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']),
        refno  : pick(obj,['ref no','refno','‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏™‡∏£‡∏∏‡∏õ']),
        idcard : pick(obj,['id card','‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô','id']),
        brCode : pick(obj,['branch code','‡∏™‡∏≤‡∏Ç‡∏≤']),
        brName : pick(obj,['branch name','‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤']),
        postDD : pick(obj,['post date ddmmyy','post date','post ddmmyy','post']),
        accName: pick(obj,['account name','‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ','customer name'])
      };
    });
  }
  const toMoney = v => {
    const n = Number(String(v).replace(/[^0-9.\-]/g,''));
    return isFinite(n) ? n.toFixed(2) : '';
  };

  function injectButtons(sectionId, ids, handlers){
    const root = document.getElementById(sectionId);
    if(!root) return;
    const toolbar = root.querySelector('.toolbar');
    if(!toolbar) return;

    // Import input (hidden)
    if(!root.querySelector(`#${ids.file}`)){
      const file = document.createElement('input');
      file.type = 'file';
      file.id = ids.file;
      file.hidden = true;
      file.accept = '.csv,.tsv,.txt,.xlsx,.json';
      file.onchange = (e)=>{ const f=e.target.files?.[0]; handlers.onImport(f); e.target.value=''; };
      toolbar.appendChild(file);
    }

    // Template button
    if(!root.querySelector(`#${ids.tplBtn}`)){
      const btn = document.createElement('button');
      btn.id = ids.tplBtn; btn.type='button';
      btn.textContent = 'üì• Template';
      btn.onclick = handlers.onTemplate;
      toolbar.appendChild(btn);
    }

    // Import button
    if(!root.querySelector(`#${ids.impBtn}`)){
      const btn = document.createElement('button');
      btn.id = ids.impBtn; btn.type='button';
      btn.textContent = '‚¨ÜÔ∏è Import';
      btn.onclick = ()=> root.querySelector(`#${ids.file}`).click();
      toolbar.appendChild(btn);
    }
  }

  function downloadCSV(filename, headers, sample){
    const escapeCSV = v => {
      const s = String(v ?? '');
      return /[",\r\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const csv = [headers, sample].map(r=>r.map(escapeCSV).join(',')).join('\r\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    URL.revokeObjectURL(a.href);
  }

  async function readAny(file){
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    if(['csv','tsv','txt'].includes(ext)) return rowsToObjects(csvToRows(await file.text()));
    if(ext==='json'){
      const data = JSON.parse(await file.text());
      const arr = Array.isArray(data)? data : (data.rows||[]);
      return arr.map(o=>({
        custAcc:o.custAcc??o['Customer Acc No']??o['account']??'',
        txnCode:o.txnCode??o['Txn Code']??o['C/D']??'',
        amount :o.amount ??o['Amount']??o['Amount (THB)']??'',
        service:o.service??o['Service Type']??'',
        status :o.status ??o['Status']??'',
        refno  :o.refno  ??o['Ref no']??'',
        idcard :o.idcard ??o['ID Card']??'',
        brCode :o.brCode ??o['Branch Code']??'',
        brName :o.brName ??o['Branch Name']??'',
        postDD :o.postDD ??o['POST DATE (DDMMYY)']??'',
        accName:o.accName??o['Account Name']??o['Customer Name']??''
      }));
    }
    if(ext==='xlsx'){
      if(typeof XLSX==='undefined'){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ SheetJS (XLSX) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô .xlsx\\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô .csv ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ó‡∏ô'); return []; }
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      return rowsToObjects(aoa);
    }
    alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö'); return [];
  }

  // ===== OL52 =====
  document.addEventListener('DOMContentLoaded', function(){
    injectButtons('app_ol52',
      {file:'ol52ImportFile', tplBtn:'ol52TplBtn', impBtn:'ol52ImpBtn'},
      {
        onTemplate: ()=>{
          downloadCSV('OL52_template.csv',
            ['Customer Acc No','Txn Code','Amount','Service Type','Status','Ref no','ID Card','Branch Code','Branch Name','POST DATE (DDMMYY)','Account Name'],
            ['020018580370','D','500.00','00','0','100567001511','2746506702371','1007','‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà','101125','QA SPLifeFile']
          );
        },
        onImport: async (file)=>{
          if(!file) return;
          const items = (await readAny(file)).map(r=>({
            custAcc: String(r.custAcc||'').trim(),
            txnCode: String(r.txnCode||'D').slice(0,1),
            amount : toMoney(r.amount),
            service: String(r.service||'00').padStart(2,'0'),
            status : String(r.status||'0').slice(0,1),
            refno  : String(r.refno||'').trim(),
            idcard : String(r.idcard||'').trim(),
            brCode : String(r.brCode||'').trim(),
            brName : String(r.brName||'').trim(),
            postDD : String(r.postDD||'').trim(), // DDMMYY
            accName: String(r.accName||'').trim()
          })).filter(x=> Object.values(x).some(v=>String(v).length));

          if(!items.length){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'); return; }

          const tbody = document.querySelector('#detailTable_SPLIFEOL52 tbody');
          if(!tbody) return;

          // ‡πÉ‡∏ä‡πâ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô template (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡πâ addRow ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
          if(tbody.children.length === 0 && typeof OL52?.addRow === 'function') OL52.addRow();
          const first = tbody.querySelector('tr');
          if(!first){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (OL52)'); return; }

          const setVals = (row, r) => {
            const q = s=>row.querySelector(s);
            (q('.custacc_SPLIFEOL52')   || {}).value = r.custAcc;
            (q('.txncode_SPLIFEOL52')   || {}).value = r.txnCode;
            (q('.amount_SPLIFEOL52')    || {}).value = r.amount;
            (q('.servicetype_SPLIFEOL52')||{}).value = r.service;
            (q('.status_SPLIFEOL52')    || {}).value = r.status;
            (q('.refno_SPLIFEOL52')     || {}).value = r.refno;
            (q('.idcard_SPLIFEOL52')    || {}).value = r.idcard;
            (q('.branchcode_SPLIFEOL52')||{}).value = r.brCode;
            (q('.branchname_SPLIFEOL52')||{}).value = r.brName;
            (q('.postdate_SPLIFEOL52')  || {}).value = r.postDD;
            (q('.accname_SPLIFEOL52')   || {}).value = r.accName;
          };

          setVals(first, items[0]);

          if(items.length > 1){
            const tpl = first.cloneNode(true);
            tpl.querySelectorAll('input,select,textarea').forEach(el=>('value' in el)&&(el.value=''));
            const frag = document.createDocumentFragment();
            for(let i=1;i<items.length;i++){ const row=tpl.cloneNode(true); setVals(row, items[i]); frag.appendChild(row); }
            tbody.appendChild(frag);
          }
          toast(`OL52: ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${items.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
      });
  });

  // ===== OL55 =====
  document.addEventListener('DOMContentLoaded', function(){
    injectButtons('app_ol55',
      {file:'ol55ImportFile', tplBtn:'ol55TplBtn', impBtn:'ol55ImpBtn'},
      {
        onTemplate: ()=>{
          downloadCSV('OL55_template.csv',
            ['Customer Acc No','Txn Code','Amount','Service Type','Status','Ref no','ID Card','Branch Code','Branch Name','POST DATE (DDMMYY)','Account Name'],
            ['020018580370','D','500.00','00','0','10056700151144','2746506702371','1007','‡∏™‡∏≤‡∏Ç‡∏≤‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà','101125','QA SPLifeFile']
          );
        },
        onImport: async (file)=>{
          if(!file) return;
          const items = (await readAny(file)).map(r=>({
            custAcc: String(r.custAcc||'').trim(),
            txnCode: String(r.txnCode||'D').slice(0,1),
            amount : toMoney(r.amount),
            service: String(r.service||'00').padStart(2,'0'),
            status : String(r.status||'0').slice(0,1),
            refno  : String(r.refno||'').trim(),
            idcard : String(r.idcard||'').trim(),
            brCode : String(r.brCode||'').trim(),
            brName : String(r.brName||'').trim(),
            postDD : String(r.postDD||'').trim(),
            accName: String(r.accName||'').trim()
          })).filter(x=> Object.values(x).some(v=>String(v).length));

          if(!items.length){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤'); return; }

          const tbody = document.querySelector('#detailTable_SPLIFEOL55 tbody');
          if(!tbody) return;

          if(tbody.children.length === 0 && typeof OL55?.addRow === 'function') OL55.addRow();
          const first = tbody.querySelector('tr');
          if(!first){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (OL55)'); return; }

          const setVals = (row, r) => {
            const q = s=>row.querySelector(s);
            (q('.custacc_SPLIFEOL55')   || {}).value = r.custAcc;
            (q('.txncode_SPLIFEOL55')   || {}).value = r.txnCode;
            (q('.amount_SPLIFEOL55')    || {}).value = r.amount;
            (q('.servicetype_SPLIFEOL55')||{}).value = r.service;
            (q('.status_SPLIFEOL55')    || {}).value = r.status;
            (q('.refno_SPLIFEOL55')     || {}).value = r.refno;
            (q('.idcard_SPLIFEOL55')    || {}).value = r.idcard;
            (q('.branchcode_SPLIFEOL55')||{}).value = r.brCode;
            (q('.branchname_SPLIFEOL55')||{}).value = r.brName;
            (q('.postdate_SPLIFEOL55')  || {}).value = r.postDD;
            (q('.accname_SPLIFEOL55')   || {}).value = r.accName;
          };

          setVals(first, items[0]);

          if(items.length > 1){
            const tpl = first.cloneNode(true);
            tpl.querySelectorAll('input,select,textarea').forEach(el=>('value' in el)&&(el.value=''));
            const frag = document.createDocumentFragment();
            for(let i=1;i<items.length;i++){ const row=tpl.cloneNode(true); setVals(row, items[i]); frag.appendChild(row); }
            tbody.appendChild(frag);
          }
          toast(`OL55: ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${items.length} ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
        }
      });
  });

  function toast(msg){
    const t=document.createElement('div');
    t.textContent=msg;
    Object.assign(t.style,{position:'fixed',left:'50%',top:'20px',transform:'translateX(-50%)',background:'#1f2937',color:'#fff',padding:'8px 14px',borderRadius:'8px',fontSize:'14px',zIndex:9999,boxShadow:'0 4px 12px rgba(0,0,0,.2)'});
    document.body.appendChild(t);
    setTimeout(()=>{t.style.transition='opacity .35s'; t.style.opacity='0';},1200);
    setTimeout(()=> t.remove(),1700);
  }
})();
</script>
</div>
</div>

  <script>
    function switchTab(tabId) {
      document.querySelectorAll('.card-content').forEach(e => e.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      document.querySelectorAll('.tab-link').forEach(e => e.classList.remove('active'));
      event.target.classList.add('active');
    }
  </script>
  <div class="noometal-brand">Version Beta 1.1.1 
  <br>Power of NooMetal</div>
</body>
</html>
